!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).gdp=t()}(this,(function(){"use strict";var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)({}).hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};function t(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+n+" is not a constructor or null");function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var i in t=arguments[n])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)};function r(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;o>i;i++)!r&&i in t||(r||(r=[].slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||[].slice.call(t))}var i=function(e){return null==e||void 0===e},o=function(e){return"string"==typeof e},s=function(e){return"number"==typeof e},a=function(e){return"[object Object]"==={}.toString.call(e)&&!i(e)},u=function(e){return"function"==typeof e},c=function(e){return Array.isArray(e)&&"[object Array]"==={}.toString.call(e)},d=function(e){return c(e)?e[0]:void 0},l=function(e){return c(e)?e[e.length-1]:void 0},g=function(e,t){return void 0===t&&(t=1),c(e)&&s(t)?e.slice(t>0&&t<e.length?t:1,e.length):e},f=function(e){if(c(e)){for(var t=0,n=[],r=0,i=e;r<i.length;r++){var o=i[r];o&&(n[t++]=o)}return n}return e},h=function(e){return i(e)?"":"".concat(e)},p=function(e,t){return"string"==typeof e?e.split(t):e},v=function(e){if(o(e)){var t=p(e,"");return"".concat(d(t).toLowerCase()).concat(g(t).join(""))}return e},m=function(e,t){return e.slice(0,t.length)===t},I=function(e,t){var n=e.length,r=n;r>n&&(r=n);var i=r;return(r-=t.length)>=0&&e.slice(r,i)===t},w={}.hasOwnProperty,y=function(e,t){return!i(e)&&w.call(e,t)},S=function(e){return"object"==typeof e?Object.keys(e):[]},O=function(e,t){S(e).forEach((function(n){return t(e[n],n)}))},b=function(e,t){var n=S(e);if(!a(e)||!a(t)||n.length!==S(t).length)return!1;for(var r=0;r<n.length;r+=1){if(a(e[n[r]]))return b(e[n[r]],t[n[r]]);if(e[n[r]]!==t[n[r]])return!1}},E=function(e,t){if(!a(e))return!1;try{if("string"===C(t))return delete e[t];if("array"===C(t))return t.map((function(t){return delete e[t]}));"object"===C(t)&&t.constructor===RegExp&&S(e).forEach((function(n){t.test(n)&&E(e,n)}))}catch(e){return!1}},N=function(e){return c(e)?0===e.length:a(e)?0===S(e).length:!e},C=function(e){var t=typeof e;return"object"===t&&c(e)?"array":t},x=Object.freeze({__proto__:null,isNil:i,isString:o,isNumber:s,isBoolean:function(e){return"boolean"==typeof e},isObject:a,isFunction:u,isArray:c,fixed:function(e,t){return s(e)?e.toFixed(s(t)?t:2,10):e},head:d,last:l,drop:g,dropWhile:function(e,t){return c(e)?e.filter((function(e){return!t(e)})):e},compact:f,find:function(e,t){if(c(e)){var n=e.findIndex(t);return 0>n?void 0:e[n]}},toString:h,split:p,lowerFirst:v,upperFirst:function(e){if(o(e)){var t=p(e,"");return"".concat(d(t).toUpperCase()).concat(g(t).join(""))}return e},startsWith:m,endsWith:I,hasOwnProperty:w,has:y,keys:S,forEach:O,isEqual:b,get:function(e,t,n){var r=e;return a(e)?(t.split(".").forEach((function(e){r=r?r[e]:n})),r):n},unset:E,isEmpty:N,typeOf:C}),P=function(e,t){console.log("%c[GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[t]||"")},_=function(e){try{return e()}catch(e){return}},q=function(e){var t={};return a(e)&&O(e,(function(e,n){var r=h(n).slice(0,50);a(e)?t[r]=q(e):c(e)?(t[r]=e.slice(0,100),"cdp"===window.gioEnvironment&&(t[r]=t[r].join("||"))):t[r]=i(e)?"":h(e).slice(0,1e3),""===t[r]&&E(t,r)})),t},A=function(e,t,r,i){void 0===i&&(i={}),document.addEventListener?e.addEventListener(t,r,n(n({},{capture:!0}),i)):e.attachEvent?e.attachEvent("on"+t,r):e["on"+t]=r},T=Object.freeze({__proto__:null,consoleText:P,niceTry:_,limitObject:q,addListener:A,flattenObject:function(e){void 0===e&&(e={});var t=n({},e);return S(t).forEach((function(e){a(t[e])?(S(t[e]).forEach((function(n){t["".concat(e,"_").concat(n)]=t[e][n]})),E(t,e)):c(t[e])?(t[e].forEach((function(n,r){a(n)?S(n).forEach((function(i){t["".concat(e,"_").concat(r,"_").concat(i)]=h(n[i])})):t["".concat(e,"_").concat(r)]=h(n)})),E(t,e)):i(t[e])||""===t[e]?E(t,e):t[e]=h(t[e])})),t}}),k=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},U=function(){var e,t=!!(null===(e=null===window||void 0===window?void 0:window.navigator)||void 0===e?void 0:e.sendBeacon),n=window.navigator.userAgent;if(n.match(/(iPad|iPhone|iPod)/g)){var r=D(n);return t&&r>13}return t},D=function(e){var t=e.toLowerCase().match(/cpu.*os (.*?) like mac os/i);return!t||2>t.length?0:+t[1].split("_").slice(0,2).join(".")},j=function(){var e=window.location.hostname;return _((function(){var t=e.split("."),n=l(t);if("localhost"!==e&&(!s(Number(n))||0>Number(n)||Number(n)>255))return[".".concat(t.slice(-2).join(".")),".".concat(t.slice(-3).join("."))]}))||[e]},R=function(e){return e.endsWith("_gioenc")?e.slice(0,-7):e},K=function(e){return Number.isNaN(Number(e))&&_((function(){return JSON.parse(e)}))||e};(window.ActiveXObject||"ActiveXObject"in window||navigator.userAgent.indexOf("compatible")>-1&&navigator.userAgent.indexOf("MSIE")>-1||navigator.userAgent.indexOf("Trident")>-1&&navigator.userAgent.indexOf("rv:11.0")>-1)&&(Array.prototype.includes=function(){return this.indexOf(arguments[0])>=0},Array.prototype.find=function(){var e=arguments[0],t=void 0;return this.forEach((function(n){e(n)&&void 0===t&&(t=n)})),t},Array.prototype.findIndex=function(){var e=arguments[0],t=-1;return this.forEach((function(n,r){e(n)&&-1===t&&(t=r)})),t},Array.from=function(){var e=arguments[0];if(null==e)throw Error("Array.from requires an array-like object not null or undefined");var t=arguments.length>1?arguments[1]:void 0;if(t&&"function"!=typeof t)throw Error("Array.from: when provided,the second argument must be a function");for(var n,r=arguments.length>2?arguments[2]:void 0,i=e.length,o=0,s=Array(i);i>o;)n=e[o],s[o]=t?r?t.call(r,n,o):t(n,o):n,o++;return s},Number.isNaN=function(){return"NaN"==="".concat(Number(arguments[0]))},String.prototype.startsWith=function(){var e=arguments[0],t=this.slice(0,e.length);return t===e},String.prototype.endsWith=function(){var e=arguments[0],t=this.slice(-e.length);return t===e});var B=["web","wxwv","minp","alip","baidup","qq","bytedance"],L={autotrack:{type:"boolean",default:!0},compress:{type:"boolean",default:!0},dataCollect:{type:"boolean",default:!0},debug:{type:"boolean",default:!1},hashtag:{type:"boolean",default:!1},touch:{type:"boolean",default:!1},version:{type:"string",default:"1.0.0"},platform:{type:"string",default:"web"}},F={enableIdMapping:{type:"boolean",default:!1},gtouchHost:{type:"string",default:""},host:{type:"string",default:""},ignoreFields:{type:"array",default:[]},penetrateHybrid:{type:"boolean",default:!0},scheme:{type:"string",default:location.protocol.replace(":","")},sessionExpires:{type:"number",default:30}},H={},V=["clearUserId","getGioInfo","getLocation","getOption","init","setDataCollect","setOption","setUserId","track","setGeneralProps","clearGeneralProps"];r(r([],V,!0),["setEvar","setPage","setUser","setVisitor"],!1);var G=r(r([],V,!0),["enableDebug","enableHT","setAutotrack","setTrackerHost","setTrackerScheme","setUserAttributes","getDeviceId","registerPlugins","sendPage","sendVisit"],!1),W=["autotrack","dataCollect","dataSourceId","debug","host","hashtag","scheme"],z={autotrack:"无埋点采集",dataCollect:"数据采集",debug:"调试模式"},X=["send","setConfig","collectImp","setPlatformProfile"],M=["language","screenHeight","screenWidth"],J=function(e){return o(e)&&e.length>0||s(e)&&e>0},Q=function(e){return e.vdsConfig||e.gioSDKInitialized?(P("SDK重复初始化，请检查是否重复加载SDK或接入其他平台SDK导致冲突!","warn"),!1):!(["","localhost","127.0.0.1"].includes(location.hostname)&&!window._gr_ignore_local_rule&&(P("当前SDK不允许在本地环境初始化!","warn"),1))},Z=function(e){return!!f(e)||(P('SDK初始化失败，请使用 gdp("init", "您的GrowingIO项目 accountId", "您项目的 dataSourceId", options); 进行初始化!',"error"),!1)},$=function(e){var t=e[0],n=l(e);return J(t)?(a(n)&&n||(n={}),{projectId:t,userOptions:n}):(P("SDK初始化失败，accountId 参数不合法!","error"),!1)},Y=function(e){var t=e[1],n=e[2],r=l(e);return t&&o(t)?a(r)&&r.host?{dataSourceId:t,appId:o(n)?n:"",cdpOptions:r}:(P("SDK初始化失败，未在配置中指定 host!","error"),!1):(P("SDK初始化失败，dataSourceId 参数不合法!","error"),!1)},ee=/^((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})(\.((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})){3}/i,te=/^(https?:\/\/)|(([a-zA-Z0-9_-])+(\.)?)*(:\d+)?(\/((\.)?(\?)?=?&?[a-zA-Z0-9_-](\?)?)*)*$/i,ne="SESSIONID_UPDATE",re={},ie={}.hasOwnProperty;function oe(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function se(e){try{return encodeURIComponent(e)}catch(e){return null}}re.stringify=function(e,t){t=t||"";var n,r,i=[];for(r in"string"!=typeof t&&(t="?"),e)if(ie.call(e,r)){if((n=e[r])||null!=n&&!isNaN(n)||(n=""),r=se(r),n=se(n),null===r||null===n)continue;i.push(r+"="+n)}return i.length?t+i.join("&"):""},re.parse=function(e){for(var t,n=/([^=?#&]+)=?([^&]*)/g,r={};t=n.exec(e);){var i=oe(t[1]),o=oe(t[2]);null===i||null===o||i in r||(r[i]=o)}return r};var ae=function(e){var t=this;this.growingIO=e,this.getValidResourceItem=function(e){if(e&&a(e)&&e.id&&e.key){var t={id:o(e.id)?e.id:h(e.id),key:o(e.key)?e.key:h(e.key)};return e.attributes&&(t.attributes=e.attributes),t}},this.getDynamicAttributes=function(e){return i(e)||S(e).forEach((function(t){u(e[t])?e[t]=e[t]():c(e[t])||(e[t]=h(e[t]))})),e},this.buildCustomEvent=function(e,r,i,s){if(o(e)&&e.match(/^[a-zA-Z_][0-9a-zA-Z_]{0,50}$/)){var u=t.growingIO.dataStore,c=u.eventContextBuilder,d=u.eventConverter,l=u.currentPage,g=n({eventType:"CUSTOM",eventName:e,pageShowTimestamp:null==l?void 0:l.time,attributes:q(t.getDynamicAttributes(a(r)&&!N(r)?r:void 0)),resourceItem:q(t.getValidResourceItem(i))},c());N(s)||(g=n(n({},g),s)),d(g)}else P("埋点事件格式不正确，事件名只能包含数字、字母和下划线，且不能以数字开头!","warn")},this.buildUserAttributesEvent=function(e,r){var i=t.growingIO.dataStore,o=i.eventContextBuilder,s=i.eventConverter,a=n({eventType:"LOGIN_USER_ATTRIBUTES",attributes:q(e)},o());N(r)||(a=n(n({},a),r)),s(a)}};window.gioCustomTracking={name:"gioCustomTracking",method:ae};var ue={name:"gioCustomTracking",method:ae},ce=function(e){function n(t){var n=e.call(this,t)||this;return n.growingIO=t,n.pluginsContext={plugins:[ue]},n}return t(n,e),n}((function(e){var t=this;this.growingIO=e,this.innerPluginInit=function(){var e;S(null===(e=t.pluginsContext)||void 0===e?void 0:e.plugins).forEach((function(e){var n,r=null===(n=t.pluginsContext)||void 0===n?void 0:n.plugins[e],i=r.name,o=r.method;t.pluginItems.find((function(e){return e.name===i}))||t.pluginItems.push({name:v(i||e),method:o||function(e){}})})),N(t.pluginItems)||t.installAll()},this.install=function(e,n,r){var i,o,s=n||t.pluginItems.find((function(t){return t.name===e}));if((null===(i=t.growingIO)||void 0===i?void 0:i.plugins)[e])return P("重复加载插件 ".concat(e," 或插件重名，已跳过加载!"),"warn"),!1;if(!s)return P("插件加载失败!不存在名为 ".concat(e," 的插件!"),"error"),!1;try{return(null===(o=t.growingIO)||void 0===o?void 0:o.plugins)[e]=new s.method(t.growingIO,r),"cdp"===t.growingIO.gioEnvironment&&n&&P("加载插件：".concat(e),"info"),!0}catch(e){return P("插件加载异常：".concat(e),"error"),!1}},this.installAll=function(e){(e||t.pluginItems).forEach((function(n){return t.install(n.name,e?n:void 0,e?null==n?void 0:n.options:void 0)}))},this.uninstall=function(e){var n;E(t.pluginItems,e);var r=E(null===(n=t.growingIO)||void 0===n?void 0:n.plugins,e);return r||P("卸载插件 ".concat(e," 失败!"),"error"),r},this.uninstallAll=function(){t.pluginItems.forEach((function(e){return t.uninstall(e.name)}))},this.lifeError=function(e,t){return P("插件执行错误 ".concat(e.name," ").concat(t),"error")},this.onComposeBefore=function(e){t.pluginItems.forEach((function(n){var r,i=null===(r=t.growingIO.plugins[n.name])||void 0===r?void 0:r.onComposeBefore;if(i&&u(i))try{i(e)}catch(e){t.lifeError(n,e)}}))},this.onComposeAfter=function(e){t.pluginItems.forEach((function(n){var r,i=null===(r=t.growingIO.plugins[n.name])||void 0===r?void 0:r.onComposeAfter;if(i&&u(i))try{i(e)}catch(e){t.lifeError(n,e)}}))},this.onSendBefore=function(e){t.pluginItems.forEach((function(n){var r,i=null===(r=t.growingIO.plugins[n.name])||void 0===r?void 0:r.onSendBefore;if(i&&u(i))try{i(e)}catch(e){t.lifeError(n,e)}}))},this.onSendAfter=function(e){t.pluginItems.forEach((function(n){var r,i=null===(r=t.growingIO.plugins[n.name])||void 0===r?void 0:r.onSendAfter;if(i&&u(i))try{i(e)}catch(e){t.lifeError(n,e)}}))},this.pluginsContext={plugins:[]},this.pluginItems=[],this.growingIO.emitter.on("onComposeBefore",this.onComposeBefore),this.growingIO.emitter.on("onComposeAfter",this.onComposeAfter),this.growingIO.emitter.on("onSendBefore",this.onSendBefore),this.growingIO.emitter.on("onSendAfter",this.onSendAfter)}));function de(e){for(var t=1;arguments.length>t;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}var le,ge,fe=function e(t,n){function r(e,r,i){if("undefined"!=typeof document){"number"==typeof(i=de({},n,i)).expires&&(i.expires=new Date(Date.now()+864e5*i.expires)),i.expires&&(i.expires=i.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var o="";for(var s in i)i[s]&&(o+="; "+s,!0!==i[s]&&(o+="="+i[s].split(";")[0]));return document.cookie=e+"="+t.write(r,e)+o}}return Object.create({set:r,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var n=document.cookie?document.cookie.split("; "):[],r={},i=0;i<n.length;i++){var o=n[i].split("="),s=o.slice(1).join("=");try{var a=decodeURIComponent(o[0]);if(r[a]=t.read(s,a),e===a)break}catch(e){}}return e?r[e]:r}},remove:function(e,t){r(e,"",de({},t,{expires:-1}))},withAttributes:function(t){return e(this.converter,de({},this.attributes,t))},withConverter:function(t){return e(de({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(n)},converter:{value:Object.freeze(t)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"}),he={A:1,a:1,Z:1,z:1,"@":1},pe=function(e){return i(e)?e:_((function(){return"gioenc-".concat(me(e))}))||e},ve=function(e){return o(e)&&e.startsWith("gioenc-")&&_((function(){return me(e.replace("gioenc-",""))}))||e},me=function(e){return(e=e||"").split("").map((function(e){return he[e]?e:Ie(e)})).join("")},Ie=function(e){if(/[0-9]/.test(e))return 1^+e;var t=e.charCodeAt(0);return String.fromCharCode(1^t)},we={},ye=function(){this.getItem=function(e){var t=_((function(){return JSON.parse(we[R(e)]||"")}));return a(t)&&t.expiredAt>+Date.now()?K(ve(t.value)):void 0},this.setItem=function(e,t,n){var r=null!=n?n:+new Date(9999,12);we[e]=JSON.stringify({value:o(t)&&t.length?pe(t):t,expiredAt:r})},this.removeItem=function(e){return E(we,R(e))},this.hasItem=function(e){return y(we,R(e))},this.getKeys=function(){return S(we)}},Se=window.self!==window.top?ye:["","localhost","127.0.0.1"].includes(window.location.hostname)||!["http:","https:"].includes(window.location.protocol)?function(){this.getItem=function(e){var t=_((function(){return JSON.parse(localStorage.getItem(R(e))||"")}))||{};return a(t)&&t.expiredAt>+Date.now()?K(ve(t.value)):void 0},this.setItem=function(e,t,n){var r=null!=n?n:+new Date(9999,12);localStorage.setItem(R(e),JSON.stringify({value:o(t)&&t.length&&e.endsWith("_gioenc")?pe(t):t,expiredAt:r}))},this.removeItem=function(e){return localStorage.removeItem(R(e))},this.hasItem=function(e){return!!localStorage.getItem(R(e))},this.getKeys=function(){return Array.from(Array(localStorage.length)).map((function(e,t){return localStorage.key[t]}))}}:function(){var e=!1;if(navigator.cookieEnabled)return!0;var t=document.cookie;return document.cookie="gioCookie=yes;",document.cookie.indexOf("gioCookie=yes")>-1&&(e=!0),document.cookie=t,e}()?function(){this.getItem=function(e){return K(ve(fe.get(R(e))))},this.setItem=function(e,t,n){return j().forEach((function(r){var i=o(t)&&e.endsWith("_gioenc")?t.length?pe(t):"":JSON.stringify(t);fe.set(R(e),i,{expires:n?new Date(n):3650,domain:r})}))},this.removeItem=function(e){return j().forEach((function(t){return fe.remove(R(e),{domain:t})}))},this.hasItem=function(e){return S(fe.get()).includes(R(e))},this.getKeys=function(){return S(fe.get())}}:ye,Oe=function(){function e(e){var t=this;this.growingIO=e;var n=this.growingIO.vdsConfig.projectId,r=this.growingIO.storage,i=r.getItem,o=r.setItem;this.getItem=i,this.setItem=o,this.sIdStorageName="".concat(n,"_gdp_session_id"),this.uidStorageName="gdp_user_id_gioenc",this.userIdStorageName="".concat(n,"_gdp_cs1_gioenc"),this.userKeyStorageName="".concat(n,"_gdp_user_key_gioenc"),this.gioIdStorageName="".concat(n,"_gdp_gio_id_gioenc"),this.growingIO.emitter.on(ne,(function(){t.growingIO.gioSDKInitialized&&(t.growingIO.dataStore.sendVisit(!0),t.growingIO.dataStore.sendPage(!0))}))}return Object.defineProperty(e.prototype,"sessionId",{get:function(){return this.getItem(this.sIdStorageName)||(this.sessionId=k(),this.sessionId)},set:function(e){e||(e=k());var t=this.getItem(this.sIdStorageName)||this.prevSessionId,n=this.growingIO.vdsConfig.sessionExpires,r=void 0===n?30:n;this.setItem(this.sIdStorageName,e,+Date.now()+60*r*1e3),t!==e&&this.growingIO.emitter.emit(ne,{newSessionId:e,oldSessionId:t}),this.prevSessionId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uid",{get:function(){return this.getItem(this.uidStorageName)||(this.uid=k(),this.uid)},set:function(e){var t=this.getItem(this.uidStorageName)||this.prevUId;this.setItem(this.uidStorageName,e),t!==e&&this.growingIO.emitter.emit("UID_UPDATE",{newUId:e,oldUId:t}),this.prevUId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userId",{get:function(){return this.getItem(this.userIdStorageName)||""},set:function(e){var t=this.getItem(this.userIdStorageName)||this.prevUserId;this.setItem(this.userIdStorageName,e),t!==e&&this.growingIO.emitter.emit("USERID_UPDATE",{newUserId:e,oldUserId:t,userKey:this.userKey}),e&&(this.gioId=e),this.prevUserId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"userKey",{get:function(){return this.getItem(this.userKeyStorageName)||""},set:function(e){var t=this.getItem(this.userKeyStorageName)||this.prevUserKey;this.setItem(this.userKeyStorageName,e),t!==e&&this.growingIO.emitter.emit("USERKEY_UPDATE",{newUserKey:e,oldUserKey:t,userId:this.userId}),this.prevUserKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gioId",{get:function(){return this.getItem(this.gioIdStorageName)||""},set:function(e){var t=this.getItem(this.gioIdStorageName)||this.prevGioId;this.setItem(this.gioIdStorageName,e),t!==e&&this.growingIO.emitter.emit("GIOID_UPDATE",{newGioId:e,oldGioId:t}),this.prevGioId=e},enumerable:!1,configurable:!0}),e}(),be=function(e){var t=this;this.growingIO=e,this.main=function(){var e,r=t.growingIO,i=r.sdkVersion,o=r.useEmbeddedInherit,s=r.vdsConfig,a=r.userStore,u=r.dataStore,c=r.trackingId,d=u.currentPage,l=d.path,g=d.query,f={appVersion:s.version,dataSourceId:s.dataSourceId,deviceId:a.uid,domain:o?s.appId:window.location.host,gioId:a.gioId,language:navigator.language,path:l,platform:s.platform,query:g,referralPage:(null===(e=u.lastPageEvent)||void 0===e?void 0:e.referralPage)||"",screenHeight:window.screen.height,screenWidth:window.screen.width,sdkVersion:i,sessionId:a.sessionId,timestamp:+Date.now(),title:document.title.slice(0,255),userId:a.userId,userKey:a.userKey};return N(t.minpExtraParams)||(f=n(n({},f),t.minpExtraParams)),N(s.ignoreFields)||s.ignoreFields.forEach((function(e){E(f,e)})),f.trackingId=c,f},this.minpExtraParams={}},Ee=function(e){var t=this;this.growingIO=e,this.parsePage=function(){var e=t.growingIO.vdsConfig.hashtag,n=location.pathname,r=location.search,i=location.hash,o=i.indexOf("?");t.domain=window.location.host,t.path=n,e&&(t.path+=o>-1?i.slice(0,o):i),t.query=r,e&&o>-1&&(t.query=t.query+"&"+i.slice(o+1)),t.query&&["?","&"].includes(t.query.charAt(0))&&(t.query=t.query.slice(1)),t.time=+Date.now()},this.pageListener=function(){t.lastHref!==window.location.href&&(t.parsePage(),t.buildPageEvent(),t.lastHref=window.location.href)},this.hookHistory=function(){var e=window.history.pushState,n=window.history.replaceState;e&&(_((function(){return window.history.pushState=function(n,r,i){e.call(window.history,n,r,i),setTimeout(t.pageListener)}})),A(window,"popstate",t.pageListener)),n&&_((function(){return window.history.replaceState=function(e,r,i){n.call(window.history,e,r,i),setTimeout(t.pageListener)}})),t.growingIO.vdsConfig.hashtag&&A(window,"hashchange",t.pageListener)},this.buildPageEvent=function(e){var r=t.growingIO.dataStore,i=r.lastPageEvent,o=r.eventContextBuilder,s=r.eventConverter,a=n(n({eventType:"PAGE"},o()),{protocolType:location.protocol.substring(0,location.protocol.length-1),referralPage:(null==i?void 0:i.path)===t.path&&(null==i?void 0:i.query)===t.query?null==i?void 0:i.referralPage:(null==i?void 0:i.path)?t.lastHref:document.referrer});N(e)||(a=n(n({},a),e)),a.timestamp=t.time,s(a)},this.lastHref=window.location.href},Ne=function(){function e(e){var t=this;this.growingIO=e,this.ALLOW_SETTING=n(n({},L),"saas"===this.growingIO.gioEnvironment?H:F),this.allowOptKeys=Object.keys(this.ALLOW_SETTING),this.initStorageId=function(){var e=t.growingIO.storage.getItem(t.seqStorageIdName)||{},r=n({},e);E(r,"globalKey"),r=a(r)&&!i(r)?r:{},t._esid={},S(r).forEach((function(e){t._esid[e]=Number.isNaN(Number(r[e]))||r[e]>=1e9||1>r[e]?1:r[e]})),b(r,t._esid)||t.setSequenceIds("esid",t._esid);var o=Number(e.globalKey);t._gsid=Number.isNaN(o)||o>=1e9||1>o?1:o,o!==t._gsid&&t.setSequenceIds("gsid",t._gsid)},this.setSequenceIds=function(e,r){var i=t.growingIO.storage.getItem(t.seqStorageIdName)||{};"gsid"===e?i.globalKey=r:i=n(n({},i),r),t.growingIO.storage.setItem(t.seqStorageIdName,i)},this.initOptions=function(e){var r=e.projectId,i=e.dataSourceId,o=e.appId;t.initialDataSourceId=i;var s={};t.allowOptKeys.forEach((function(n){var r=t.ALLOW_SETTING[n].type,i=c(r)?!r.includes(C(e[n])):C(e[n])!==t.ALLOW_SETTING[n].type;"platform"!==n||B.includes(e[n])||(i=!0),i?s[n]=t.ALLOW_SETTING[n].default:"ignoreFields"===n?s.ignoreFields=e.ignoreFields.filter((function(e){return M.includes(e)})):(s[n]=e[n],["dataCollect","autotrack"].includes(n)&&(s[n]||P("已关闭".concat(z[n]),"info")))})),s.sessionExpires=Math.round(s.sessionExpires),(Number.isNaN(s.sessionExpires)||1>s.sessionExpires||s.sessionExpires>360)&&(s.sessionExpires=30),t.growingIO.vdsConfig=n(n({},s),{projectId:r,dataSourceId:i,appId:o,sdkVer:t.growingIO.sdkVersion}),window.vds=t.growingIO.vdsConfig,t.seqStorageIdName="".concat(r,"_gdp_sequence_ids")},this.setOption=function(e,r){var i,s=t.growingIO,a=s.vdsConfig,u=s.callError,c=s.uploader,d=s.emitter,l=o(e)&&W.includes(e),g=l&&typeof r===((null===(i=t.ALLOW_SETTING[e])||void 0===i?void 0:i.type)||"string"),f=n({},a);return l&&g?(a[e]=r,"dataCollect"===e&&!1===f.dataCollect&&!0===r&&(t.sendVisit(!0),t.sendPage()),["host","scheme"].includes(e)&&(null==c||c.generateHost()),d.emit("OPTION_CHANGE",{optionName:e,optionValue:r}),!0):(u("setOption > ".concat(e)),!1)},this.getOption=function(e){var r=t.growingIO,o=r.vdsConfig,s=r.callError;return e&&y(o,h(e))?o[h(e)]:i(e)?n({},o):void s("getOption > ".concat(e))},this.sendVisit=function(e){var n=t.growingIO,r=n.userStore.sessionId,i=n.vdsConfig.projectId,o=n.storage,s="".concat(i,"_gdp_session_id_").concat(r),a=o.getItem(s);!e&&[!0,"true"].includes(a)||(t.buildVisitEvent(),o.setItem(s,!0))},this.buildVisitEvent=function(e){var r=t.growingIO.dataStore,i=r.eventContextBuilder,o=r.eventConverter,s=n(n({eventType:"VISIT"},i()),{referral:t.lastVisitEvent.referral,referralPage:t.lastPageEvent.referralPage});N(e)||(s.session=(null==e?void 0:e.session)||s.session,s.trackingId=null==e?void 0:e.trackingId,s=n(n({},s),e)),o(s)},this.sendPage=function(e){e&&t.currentPage.parsePage(),t.currentPage.buildPageEvent()},this.buildErrorEvent=function(e){var r=t.growingIO.dataStore,i=r.eventContextBuilder;(0,r.eventConverter)(n({eventType:"CUSTOM",pageShowTimestamp:t.currentPage.time,eventName:"onError",attributes:e},i()))},this.currentPage=new Ee(this.growingIO),this.eventContextBuilderInst=new be(this.growingIO),this.eventContextBuilder=this.eventContextBuilderInst.main,this.generalProps={},this.lastVisitEvent={referralPage:document.referrer},this.growingIO.emitter.on("onComposeAfter",(function(e){var n=e.composedEvent;"VISIT"!==n.eventType&&"vst"!==n.t||n.trackingId!==t.growingIO.trackingId||(t.lastVisitEvent=n)})),this.lastPageEvent={},this.growingIO.emitter.on("onComposeAfter",(function(e){var n=e.composedEvent;"PAGE"!==n.eventType&&"page"!==n.t||n.trackingId!==t.growingIO.trackingId||(t.lastPageEvent=n)}))}return Object.defineProperty(e.prototype,"esid",{get:function(){var e=this,t=this.growingIO.storage.getItem(this.seqStorageIdName)||{},r=n({},t);return E(r,"globalKey"),r=a(r)&&!i(r)?r:{},this._esid={},S(r).forEach((function(t){e._esid[t]=Number.isNaN(Number(r[t]))||r[t]>=1e9||1>r[t]?1:r[t]})),this._esid},set:function(e){var t={};S(e).forEach((function(n){t[n]=Number.isNaN(e[n])||e[n]>=1e9||1>e[n]?1:e[n]})),b(e,t)||(this._esid=t,this.setSequenceIds("esid",this._esid))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gsid",{get:function(){var e=this.growingIO.storage.getItem(this.seqStorageIdName)||{},t=Number(e.globalKey);return this._gsid=Number.isNaN(t)||t>=1e9||1>t?1:t,this._gsid},set:function(e){var t=Number(e);this._gsid=Number.isNaN(t)||e>=1e9||1>e?1:e,this.setSequenceIds("gsid",this._gsid)},enumerable:!1,configurable:!0}),e}(),Ce=function(e){function r(t){var r=e.call(this,t)||this;return r.growingIO=t,r.eventConverter=function(e){var t,o=r.growingIO,s=o.vdsConfig,a=o.dataStore,u=o.uploader;if(s.dataCollect){e.trackingId===r.growingIO.trackingId&&(e.globalSequenceId=a.gsid,e.eventSequenceId=a.esid[e.eventType]||1);var c={};O(e,(function(e,t){var n;if("element"===t){var r=null!==(n=d(e))&&void 0!==n?n:{};O(r,(function(e,t){N(e)&&0!==e||(c[t]=e)}))}else(N(e)||i(e))&&0!==e||(c[t]=e)})),e.trackingId===r.growingIO.trackingId&&(r.growingIO.dataStore.gsid+=1,r.growingIO.dataStore.esid=n(n({},r.growingIO.dataStore.esid),((t={})[c.eventType]=(r.growingIO.dataStore.esid[c.eventType]||1)+1,t))),r.growingIO.emitter.emit("onComposeAfter",{composedEvent:n({},c)}),e.trackingId===r.growingIO.trackingId&&u.commitRequest(c)}},r}return t(r,e),r}(Ne),xe=function(e){function n(t){var n=e.call(this,t)||this;return n.growingIO=t,n.generateHost=function(){var e=n.growingIO.vdsConfig,t=e.scheme,r=e.host,i=void 0===r?"":r,o=e.projectId;t?I(h(t),"://")||(t="".concat(t,"://")):t="".concat(location.protocol,"//"),m(i,"http")&&(i=i.substring(i.indexOf("://")+(I(h(t),"://")?4:1))),n.requestURL="".concat(t).concat(i,"/v3/projects/").concat(o,"/collect")},n.requestURL="",n.generateHost(),n}return t(n,e),n}((function(e){var t=this;this.growingIO=e,this.commitRequest=function(e){E(e,"trackingId");var r=n({},e);t.requestQueue.push(n(n({},r),{requestType:U()?"Beacon":"XHR"})),t.initiateRequest()},this.initiateRequest=function(){var e,i;if(r([],t.requestQueue,!0).length>0&&t.requestingNum<t.requestLimit){var o=t.growingIO,s=o.vdsConfig,a=o.emitter,u=o.plugins,c=o.useHybridInherit;if(t.requestQueue=r([],t.requestQueue,!0).filter((function(e){return(t.retryIds[e.globalSequenceId||e.esid]||0)<=t.retryLimit})),N(t.requestQueue))return;var d=t.requestQueue.shift(),l=d.requestType;if(E(d,"requestType"),s.debug&&console.log("[GrowingIO Debug]:",JSON.stringify(d,null,2).replace(/\"/g,(i=window.navigator.userAgent,/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(i)&&!/chrome\/(\d+\.\d+)/i.test(i)?"":'"'))),a.emit("onSendBefore",{requestData:d}),t.requestingNum+=1,c)return t.requestSuccessFn(d),!1;var g=n({},d);switch(s.compress?(t.compressType="1",g=null===(e=null==u?void 0:u.gioCompress)||void 0===e?void 0:e.compressToUint8Array(JSON.stringify([g]))):(t.compressType="0",g=JSON.stringify([g])),l){case"Beacon":default:t.sendByBeacon(d,g);break;case"XHR":t.sendByXHR(d,g);break;case"Image":t.sendByImage(d,g)}}},this.generateURL=function(){return"".concat(t.requestURL,"?stm=").concat(+Date.now(),"&compress=").concat(t.compressType)},this.sendByBeacon=function(e,n){navigator.sendBeacon(t.generateURL(),n)?t.requestSuccessFn(e):t.requestFailFn(e,"Beacon")},this.sendByXHR=function(e,n){var r,i=["unload","beforeunload","pagehide"].includes(null===(r=null===window||void 0===window?void 0:window.event)||void 0===r?void 0:r.type),o=new XMLHttpRequest;if(o)return o.open("POST",t.generateURL(),i),o.onreadystatechange=function(){4===o.readyState&&204===o.status?t.requestSuccessFn(e):t.requestFailFn(e,"XHR")},o.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),void o.send(n);if(null===window||void 0===window?void 0:window.XDomainRequest){var s=new window.XDomainRequest;s.open("POST",t.generateURL().replace("https://","http://"),i),s.onload=function(){204===s.status?t.requestSuccessFn(e):t.requestFailFn(e,"XHR")},s.onerror=s.ontimeout=function(){t.requestFailFn(e,"XHR")},s.send(n)}},this.sendByImage=function(e,n){var r="".concat(t.generateURL(),"&data=").concat(n),i=document.createElement("img");i.width=1,i.height=1,i.onload=function(){t.requestSuccessFn(e),t.clearImage(i)},i.onerror=i.onabort=function(){t.requestFailFn(e,"Image"),t.clearImage(i)},i.src=r},this.clearImage=function(e){e.src="",e.onload=function(){},e.onerror=e.onerabort=function(){},e=null},this.requestSuccessFn=function(e){t.requestingNum-=1;var n=e.globalSequenceId||e.esid||-1;t.retryIds[n]&&(t.retryIds[n]=0),t.growingIO.userStore.sessionId=t.growingIO.userStore.sessionId,t.growingIO.emitter.emit("onSendAfter",{requestData:e}),t.initiateRequest()},this.requestFailFn=function(e,r){t.requestingNum-=1;var i=e.globalSequenceId||e.esid||-1;t.retryIds[i]||(t.retryIds[i]=0),t.retryIds[i]+=1;var o=t.requestQueue.some((function(t){return t.globalSequenceId===e.globalSequenceId&&t.esid===e.esid})),s=r;t.retryIds[i]<t.retryLimit+1||(s="Beacon"===r?"XHR":"XHR"===r?"Image":void 0,t.retryIds[i]=0),!o&&s&&t.requestQueue.push(n(n({},e),{requestType:s}))},this.requestQueue=[],this.requestLimit=10,this.requestTimeout=5e3,this.retryLimit=1,this.retryIds={},this.requestingNum=0,this.requestURL=""})),Pe=function(e){function o(){var t=e.call(this)||this;return t.registerPlugins=function(e){e.forEach((function(t,r){var i;t.js&&(e[r]=n(n({},null===(i=t.js)||void 0===i?void 0:i.default),{options:t.options}))})),t.plugins.pluginItems=r(r([],t.plugins.pluginItems,!0),e,!0),t.plugins.installAll(e)},t.initCallback=function(){var e,n;t.userStore=new Oe(t),t.vdsConfig.enableIdMapping||(t.userStore.userKey=""),t.uploader=new xe(t),null===(n=null===(e=t.plugins)||void 0===e?void 0:e.gioEventAutoTracking)||void 0===n||n.main()},t.setTrackerScheme=function(e){["http","https"].includes(e)?(t.dataStore.setOption("scheme",e),t.notRecommended()):t.callError("scheme",!1)},t.setTrackerHost=function(e){ee.test(e)||te.test(e)?(t.dataStore.setOption("host",e),t.notRecommended()):t.callError("host",!1)},t.setDataCollect=function(e){t.setOption("dataCollect",!!e),t.notRecommended()},t.setAutotrack=function(e){t.setOption("autotrack",!!e),t.notRecommended()},t.enableDebug=function(e){t.setOption("debug",!!e),t.notRecommended()},t.enableHT=function(e){t.setOption("hashtag",!!e),t.notRecommended()},t.getDeviceId=function(){return t.userStore.uid},t.setUserAttributes=function(e,n){var r,i;!N(e)&&a(e)?null===(i=null===(r=t.plugins)||void 0===r?void 0:r.gioCustomTracking)||void 0===i||i.buildUserAttributesEvent(e,n):t.callError("setUser")},t.setUserId=function(e,n){if(J(e)){var r=t.userStore.gioId;t.vdsConfig.enableIdMapping&&(t.userStore.userKey=!i(n)&&h(n).length>0?h(n).slice(0,1e3):""),e=h(e).slice(0,1e3),t.userStore.userId=e,r&&r!==e&&(t.userStore.sessionId=""),r||r===e||t.dataStore.sendVisit(!0)}else t.clearUserId(),t.callError("setUserId")},t.clearUserId=function(){t.userStore.userId="",t.userStore.userKey=""},t.track=function(e,r,i,o){var s,u;((null===(u=null===(s=t.plugins)||void 0===s?void 0:s.gioCustomTracking)||void 0===u?void 0:u.buildCustomEvent)||function(){})(e,n(n({},t.dataStore.generalProps),a(r)&&!N(r)?r:{}),i,o)},t.sendPage=function(e){return t.dataStore.currentPage.buildPageEvent(e)},t.sendVisit=function(e){return t.dataStore.buildVisitEvent(e)},t.dataStore=new Ce(t),t}return t(o,e),o}((function(){var e,t=this;this.trackingId="g0",this.init=function(e){var n,r,i,o;P("Gio Web SDK 初始化中...","info");var s=t.dataStore,a=s.initOptions,u=s.currentPage,c=s.sendVisit,d=s.sendPage;a(e),t.useEmbeddedInherit=null===(r=null===(n=t.plugins)||void 0===n?void 0:n.gioEmbeddedAdapter)||void 0===r?void 0:r.main(e),t.useHybridInherit=null===(o=null===(i=t.plugins)||void 0===i?void 0:i.gioHybridAdapter)||void 0===o?void 0:o.main(e),null==t||t.initCallback(),u.hookHistory(),u.parsePage(),t.emitter.emit("SDK_INITIALIZED",t),P("Gio Web SDK 初始化完成！","success"),t.useEmbeddedInherit||c(),d(),t.gioSDKInitialized=!0},this.setOption=function(e,n){if(W.includes(e)){var r=t.dataStore.setOption(e,n);return r&&z[e]&&P("已".concat(n?"开启":"关闭").concat(z[e]),"info"),r}return P("不存在可修改的配置项：".concat(e,"，请检查后重试!"),"warn"),!1},this.getOption=function(e){return t.dataStore.getOption(e)},this.setGeneralProps=function(e){a(e)&&!N(e)?(t.dataStore.generalProps=n(n({},t.dataStore.generalProps),e),S(t.dataStore.generalProps).forEach((function(e){["",void 0,null].includes(t.dataStore.generalProps[e])&&E(t.dataStore.generalProps,e)}))):t.callError("setGeneralProps")},this.clearGeneralProps=function(e){c(e)&&!N(e)?e.forEach((function(e){E(t.dataStore.generalProps,e)})):t.dataStore.generalProps={}},this.reissuePage=function(){t.dataStore.sendPage()},this.notRecommended=function(){return P("不推荐的方法使用，建议使用 gio('setOption', [optionName], [value])!","info")},this.callError=function(e,t,n){return void 0===t&&(t=!0),void 0===n&&(n="参数不合法"),P("".concat(t?"调用":"设置"," ").concat(e," 失败，").concat(n,"!"),"warn")},this.gioEnvironment="cdp",this.sdkVersion="3.8.0-rc.1",this.utils=n(n(n({},x),T),{qs:re}),this.emitter={all:e=e||new Map,on:function(t,n){var r=e.get(t);r?r.push(n):e.set(t,[n])},off:function(t,n){var r=e.get(t);r&&(n?r.splice(r.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var r=e.get(t);r&&r.slice().map((function(e){e(n)})),(r=e.get("*"))&&r.slice().map((function(e){e(t,n)}))}},this.gioSDKInitialized=!1,this.storage=new Se,this.plugins=new ce(this),this.plugins.innerPluginInit()})),_e=new Pe,qe=function(){var e=arguments[0];if(o(e)&&G.includes(e)&&_e[e]){var t=g(Array.from(arguments));if("init"===e){var r=Q(_e),i=Z(t),s=$(t),a=Y(t);if(r&&i&&s&&a){var u=s.projectId,c=a.dataSourceId,d=a.appId,l=a.cdpOptions;_e.init(n(n({},l),{projectId:u,dataSourceId:c,appId:d}))}}else if("registerPlugins"===e)_e.registerPlugins(t[0]);else{if(_e.gioSDKInitialized&&_e.vdsConfig)return _e[e].apply(_e,t);P("SDK未初始化!","error")}}else X.includes(e)?P("方法 ".concat(h(e)," 已被弃用，请移除!"),"warn"):P("不存在名为 ".concat(h(e)," 的方法调用!"),"error");window.gioEnvironment="cdp",window.gioSDKVersion=_e.sdkVersion};return c(null===(le=null===window||void 0===window?void 0:window.gdp)||void 0===le?void 0:le.q)&&!N(null===(ge=null===window||void 0===window?void 0:window.gdp)||void 0===ge?void 0:ge.q)&&window.gdp.q.forEach((function(e){qe.apply(null,e)})),window.gdp=qe,qe}));
