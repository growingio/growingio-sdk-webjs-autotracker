!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).gdp=e()}(this,(function(){"use strict";var t,e,i,s,r,n,o,a="function"==typeof Array.from?Array.from:(e||(e=1,i=function(t){return"function"==typeof t},s=function(t){var e=function(t){var e=Number(t);return isNaN(e)?0:0!==e&&isFinite(e)?(e>0?1:-1)*Math.floor(Math.abs(e)):e}(t);return Math.min(Math.max(e,0),9007199254740991)},r=function(t){if(null!=t){if(["string","number","boolean","symbol"].indexOf(typeof t)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in t)return Symbol.iterator;if("@@iterator"in t)return"@@iterator"}},n=function(t,e){if(null!=t&&null!=e){var s=t[e];if(null==s)return;if(!i(s))throw new TypeError(s+" is not a function");return s}},o=function(t){var e=t.next();return!e.done&&e},t=function(t){var e,a,l,d=this,c=arguments.length>1?arguments[1]:void 0;if(void 0!==c){if(!i(c))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(e=arguments[2])}var h=n(t,r(t));if(void 0!==h){a=i(d)?Object(new d):[];var u,g,m=h.call(t);if(null==m)throw new TypeError("Array.from requires an array-like or iterable object");for(l=0;;){if(!(u=o(m)))return a.length=l,a;g=u.value,a[l]=c?c.call(e,g,l):g,l++}}else{var p=Object(t);if(null==t)throw new TypeError("Array.from requires an array-like object - not null or undefined");var I,f=s(p.length);for(a=i(d)?Object(new d(f)):Array(f),l=0;f>l;)I=p[l],a[l]=c?c.call(e,I,l):I,l++;a.length=f}return a}),t);Array.prototype.includes=function(){return this.indexOf(arguments[0])>=0},Array.prototype.find=function(){const t=arguments[0];let e;return this.forEach((i=>{t(i)&&void 0===e&&(e=i)})),e},Array.prototype.findIndex=function(){const t=arguments[0];let e=-1;return this.forEach(((i,s)=>{t(i)&&-1===e&&(e=s)})),e},Array.from=a,Number.isNaN=function(){return""+Number(arguments[0])=="NaN"},String.prototype.includes=function(){return this.indexOf(arguments[0])>=0},String.prototype.startsWith=function(){const t=arguments[0],e=this.slice(0,t.length);return e===t},String.prototype.endsWith=function(){const t=arguments[0],e=this.slice(-t.length);return e===t};const l=["web","wxwv","minp","alip","baidup","qq","bytedance"],d={autotrack:{type:"boolean",default:!0},compress:{type:"boolean",default:!0},dataCollect:{type:"boolean",default:!0},debug:{type:"boolean",default:!1},hashtag:{type:"boolean",default:!1},touch:{type:"boolean",default:!1},version:{type:"string",default:"1.0.0"},platform:{type:"string",default:"web"}},c={enableIdMapping:{type:"boolean",default:!1},gtouchHost:{type:"string",default:""},host:{type:"string",default:""},ignoreFields:{type:"array",default:[]},penetrateHybrid:{type:"boolean",default:!0},scheme:{type:"string",default:location.protocol.indexOf("http")>-1?location.protocol.replace(":",""):"https"},sessionExpires:{type:"number",default:30}},h={},u=["clearUserId","getGioInfo","getLocation","getOption","init","setDataCollect","setOption","setUserId","track","setGeneralProps","clearGeneralProps","enableDebug","enableHT","setAutotrack","setTrackerHost","setTrackerScheme","setUserAttributes","getVisitorId","getDeviceId","registerPlugins","sendPage","sendVisit","trackTimerStart","trackTimerPause","trackTimerResume","trackTimerEnd","removeTimer","clearTrackTimer"],g=["autotrack","dataCollect","dataSourceId","debug","host","hashtag","scheme"],m={autotrack:"无埋点采集",dataCollect:"数据采集",debug:"调试模式"},p=["send","setConfig","collectImp","setPlatformProfile"],I=["screenHeight","screenWidth"],f=t=>null==t||void 0===t,v=t=>"string"==typeof t,w=t=>"number"==typeof t,y=t=>"[object Object]"==={}.toString.call(t)&&!f(t),S=t=>"function"==typeof t,b=t=>Array.isArray(t)&&"[object Array]"==={}.toString.call(t),O=t=>"[object Date]"==={}.toString.call(t),E=t=>{try{return Array.from(t)[0]}catch(t){return}},N=t=>{try{const e=Array.from(t);return e[e.length-1]}catch(t){return}},T=(t,e=1)=>b(t)&&w(e)?t.slice(e>0?e:1,t.length):t,C=t=>{if(b(t)){let e=0;const i=[];for(const s of t)s&&!L(s)&&(i[e++]=s);return i}return t},j=t=>f(t)?"":""+t,k=(t,e)=>"string"==typeof t?t.split(e):t,x=t=>{if(v(t)){const e=k(t,"");return`${E(e).toLowerCase()}${T(e).join("")}`}return t},_=(t,e)=>!!v(t)&&t.slice(0,e.length)===e,q=(t,e)=>{if(v(t)){const{length:i}=t;let s=i;s>i&&(s=i);const r=s;return s-=e.length,s>=0&&t.slice(s,r)===e}return!1},A={}.hasOwnProperty,P=(t,e)=>!f(t)&&A.call(t,e),D=t=>"object"===B(t)?Object.keys(t):[],U=(t,e)=>{D(t).forEach((i=>e(t[i],i)))},R=(t,e)=>{const i=D(t);return!(!y(t)||!y(e)||i.length!==D(e).length||i.map(((i,s)=>y(t[i])?R(t[i],e[i]):t[i]===e[i])).includes(!1))},K=(t,e)=>{if(!y(t))return!1;try{if("string"===B(e))return delete t[e];if("array"===B(e))return e.map((e=>delete t[e]));"object"===B(e)&&e.constructor===RegExp&&D(t).forEach((i=>{e.test(i)&&K(t,i)}))}catch(t){return!1}},L=t=>b(t)?0===t.length:y(t)?0===D(t).length:!t,B=t=>{const e=typeof t;return"object"===e?null===t?"null":b(t)?"array":e:e};var F=Object.freeze({__proto__:null,isNil:f,isString:v,isNumber:w,isBoolean:t=>"boolean"==typeof t,isObject:y,isFunction:S,isArray:b,isDate:O,fixed:(t,e)=>w(t)?Number(t.toFixed(w(e)?e:2)):v(t)&&"NaN"!==j(Number(t))?Number(Number(t).toFixed(w(e)?e:2)):t,head:E,last:N,drop:T,dropWhile:(t,e)=>b(t)?t.filter((t=>!e(t))):t,compact:C,find:(t,e)=>{if(b(t)){const i=t.findIndex(e);return 0>i?void 0:t[i]}},toString:j,split:k,lowerFirst:x,upperFirst:t=>{if(v(t)){const e=k(t,"");return`${E(e).toUpperCase()}${T(e).join("")}`}return t},startsWith:_,endsWith:q,hasOwnProperty:A,has:P,keys:D,forEach:U,isEqual:R,get:(t,e,i)=>{let s=t;return y(t)?(e.split(".").forEach((t=>{s=s?s[t]:i})),s):i},unset:K,isEmpty:L,typeOf:B,formatDate:t=>{if(O(t)){const e=t=>10>t?"0"+t:t;return t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())+" "+e(t.getHours())+":"+e(t.getMinutes())+":"+e(t.getSeconds())+"."+e(t.getMilliseconds())}return t}});const $=(t,e)=>{console.log("%c[GrowingIO]："+t,{info:"color: #3B82F6;",error:"color: #EF4444",warn:"color: #F59E0B",success:"color: #10B981"}[e]||"")},H=t=>{try{return t()}catch(t){return}},V=t=>{const e={};return y(t)&&U(t,((t,i)=>{const s=j(i).slice(0,50);y(t)?e[s]=V(t):b(t)?(e[s]=t.slice(0,100),"cdp"===window.gioEnvironment&&(e[s]=e[s].join("||"))):e[s]=f(t)?"":j(t).slice(0,1e3)})),e},G=(t,e,i,s={})=>{document.addEventListener?t.addEventListener(e,i,Object.assign(Object.assign({},{capture:!0}),s)):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i};var W=Object.freeze({__proto__:null,consoleText:$,niceTry:H,limitObject:V,addListener:G,flattenObject:(t={})=>{const e=Object.assign({},t);return D(e).forEach((t=>{y(e[t])?(D(e[t]).forEach((i=>{e[`${t}_${i}`]=j(e[t][i])})),K(e,t)):b(e[t])?(e[t].forEach(((i,s)=>{y(i)?D(i).forEach((r=>{e[`${t}_${s}_${r}`]=j(i[r])})):e[`${t}_${s}`]=j(i)})),K(e,t)):f(e[t])||""===e[t]?K(e,t):e[t]=j(e[t])})),e}});const z=t=>v(t)&&t.length>0||w(t)&&t>0,M=t=>t.vdsConfig||t.gioSDKInitialized||window.vds||window.gioSDKInitialized?($("SDK重复初始化，请检查是否重复加载SDK或接入其他平台SDK导致冲突!","warn"),!1):!(["","localhost","127.0.0.1"].includes(location.hostname)&&!window._gr_ignore_local_rule&&($("当前SDK不允许在本地环境初始化!","warn"),1)),X=t=>!L(C(t))||($('SDK初始化失败，请使用 gdp("init", "您的GrowingIO项目 accountId", "您项目的 dataSourceId", options); 进行初始化!',"error"),!1),J=t=>{const e=E(t);let i=N(t);return z(j(e).trim())?(y(i)&&i||(i={}),{projectId:e,userOptions:i}):($("SDK初始化失败，accountId 参数不合法!","error"),!1)},Q=t=>{const e=t[1],i=t[2],s=N(t);return e&&v(e)?y(s)&&s.host?{dataSourceId:e,appId:v(i)?i:"",cdpOptions:s}:($("SDK初始化失败，未在配置中指定 host!","error"),!1):($("SDK初始化失败，dataSourceId 参数不合法!","error"),!1)},Z=/^((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})(\.((2(5[0-5]|[0-4]\d))|[0-1]?\d{1,2})){3}/i,Y=/^(https?:\/\/)|(([a-zA-Z0-9_-])+(\.)?)*(:\d+)?(\/((\.)?(\?)?=?&?[a-zA-Z0-9_-](\?)?)*)*$/i;var tt="SESSIONID_UPDATE",et={},it={}.hasOwnProperty;function st(t){try{return decodeURIComponent(t.replace(/\+/g," "))}catch(t){return null}}function rt(t){try{return encodeURIComponent(t)}catch(t){return null}}et.stringify=function(t,e){e=e||"";var i,s,r=[];for(s in"string"!=typeof e&&(e="?"),t)if(it.call(t,s)){if((i=t[s])||null!=i&&!isNaN(i)||(i=""),s=rt(s),i=rt(i),null===s||null===i)continue;r.push(s+"="+i)}return r.length?e+r.join("&"):""},et.parse=function(t){for(var e,i=/([^=?#&]+)=?([^&]*)/g,s={};e=i.exec(t);){var r=st(e[1]),n=st(e[2]);null===r||null===n||r in s||(s[r]=n)}return s};class nt{constructor(t){this.growingIO=t,this.getValidResourceItem=t=>{if(t&&y(t)&&t.id&&t.key){const e={id:v(t.id)?t.id:j(t.id),key:v(t.key)?t.key:j(t.key)};return t.attributes&&(e.attributes=t.attributes),e}},this.getDynamicAttributes=t=>(f(t)||D(t).forEach((e=>{S(t[e])?t[e]=t[e]():y(t[e])?K(t,e):b(t[e])||(t[e]=j(t[e]))})),t),this.buildCustomEvent=(t,e,i,s)=>{if(v(t)&&t.match(/^[a-zA-Z_][0-9a-zA-Z_]{0,50}$/)){const{dataStore:{eventContextBuilder:r,eventConverter:n,currentPage:o}}=this.growingIO;let a=Object.assign({eventType:"CUSTOM",eventName:t,pageShowTimestamp:null==o?void 0:o.time,attributes:V(this.getDynamicAttributes(y(e)&&!L(e)?e:void 0)),resourceItem:V(this.getValidResourceItem(i))},r());L(s)||(a=Object.assign(Object.assign({},a),s)),n(a)}else $("埋点事件格式不正确，事件名只能包含数字、字母和下划线，且不能以数字开头!","warn")},this.buildUserAttributesEvent=(t,e)=>{const{dataStore:{eventContextBuilder:i,eventConverter:s}}=this.growingIO;let r=Object.assign({eventType:"LOGIN_USER_ATTRIBUTES",attributes:V(t)},i());L(e)||(r=Object.assign(Object.assign({},r),e)),s(r)}}}window.gioCustomTracking={name:"gioCustomTracking",method:nt};const ot={};var at,lt,dt;lt={name:"gioCustomTracking",method:nt},dt=ot,(at=["plugins","gioCustomTracking"]).map((function(t,e){dt[t]=e==at.length-1?lt:dt[t]||{},dt=dt[t]}));class ct extends class{constructor(t){var e,i,s,r;this.growingIO=t,this.innerPluginInit=()=>{var t;D(null===(t=this.pluginsContext)||void 0===t?void 0:t.plugins).forEach((t=>{var e;const{name:i,method:s}=null===(e=this.pluginsContext)||void 0===e?void 0:e.plugins[t];this.pluginItems.find((t=>t.name===i))||this.pluginItems.push({name:x(i||t),method:s||(t=>{})})})),L(this.pluginItems)||this.installAll()},this.install=(t,e,i)=>{var s,r;const n=e||this.pluginItems.find((e=>e.name===t));if((null===(s=this.growingIO)||void 0===s?void 0:s.plugins)[t])return $(`重复加载插件 ${t} 或插件重名，已跳过加载!`,"warn"),!1;if(!n)return $(`插件加载失败!不存在名为 ${t} 的插件!`,"error"),!1;try{return(null===(r=this.growingIO)||void 0===r?void 0:r.plugins)[t]=new n.method(this.growingIO,i),"cdp"===this.growingIO.gioEnvironment&&e&&$("加载插件："+t,"info"),!0}catch(t){return $("插件加载异常："+t,"error"),!1}},this.installAll=t=>{(t||this.pluginItems).forEach((e=>this.install(e.name,t?e:void 0,t?null==e?void 0:e.options:void 0)))},this.uninstall=t=>{var e;K(this.pluginItems,t);const i=K(null===(e=this.growingIO)||void 0===e?void 0:e.plugins,t);return i||$(`卸载插件 ${t} 失败!`,"error"),i},this.uninstallAll=()=>{this.pluginItems.forEach((t=>this.uninstall(t.name)))},this.lifeError=(t,e)=>$(`插件执行错误 ${t.name} ${e}`,"error"),this.onComposeBefore=t=>{this.pluginItems.forEach((e=>{var i;const s=null===(i=this.growingIO.plugins[e.name])||void 0===i?void 0:i.onComposeBefore;if(s&&S(s))try{s(t)}catch(t){this.lifeError(e,t)}}))},this.onComposeAfter=t=>{this.pluginItems.forEach((e=>{var i;const s=null===(i=this.growingIO.plugins[e.name])||void 0===i?void 0:i.onComposeAfter;if(s&&S(s))try{s(t)}catch(t){this.lifeError(e,t)}}))},this.onSendBefore=t=>{this.pluginItems.forEach((e=>{var i;const s=null===(i=this.growingIO.plugins[e.name])||void 0===i?void 0:i.onSendBefore;if(s&&S(s))try{s(t)}catch(t){this.lifeError(e,t)}}))},this.onSendAfter=t=>{this.pluginItems.forEach((e=>{var i;const s=null===(i=this.growingIO.plugins[e.name])||void 0===i?void 0:i.onSendAfter;if(s&&S(s))try{s(t)}catch(t){this.lifeError(e,t)}}))},this.pluginsContext={plugins:{}},this.pluginItems=[],null===(e=this.growingIO.emitter)||void 0===e||e.on("onComposeBefore",this.onComposeBefore),null===(i=this.growingIO.emitter)||void 0===i||i.on("onComposeAfter",this.onComposeAfter),null===(s=this.growingIO.emitter)||void 0===s||s.on("onSendBefore",this.onSendBefore),null===(r=this.growingIO.emitter)||void 0===r||r.on("onSendAfter",this.onSendAfter)}}{constructor(t){super(t),this.growingIO=t,this.pluginsContext=ot}}const ht=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})),ut=()=>{var t;const e=!!(null===(t=null===window||void 0===window?void 0:window.navigator)||void 0===t?void 0:t.sendBeacon),i=window.navigator.userAgent;if(i.match(/(iPad|iPhone|iPod)/g)){const t=gt(i);return e&&t>13}return e},gt=t=>{const e=t.toLowerCase().match(/cpu.*os (.*?) like mac os/i);return!e||2>e.length?0:+e[1].split("_").slice(0,2).join(".")},mt=()=>{let t=window.location.hostname;return H((()=>{const e=t.split("."),i=N(e);if("localhost"!==t&&(!w(Number(i))||0>Number(i)||Number(i)>255))return["."+e.slice(-2).join("."),"."+e.slice(-3).join(".")]}))||[t]},pt=t=>t.endsWith("_gioenc")?t.slice(0,-7):t,It=t=>Number.isNaN(Number(t))&&H((()=>JSON.parse(t)))||t;function ft(t){for(var e=1;arguments.length>e;e++){var i=arguments[e];for(var s in i)t[s]=i[s]}return t}var vt=function t(e,i){function s(t,s,r){if("undefined"!=typeof document){"number"==typeof(r=ft({},i,r)).expires&&(r.expires=new Date(Date.now()+864e5*r.expires)),r.expires&&(r.expires=r.expires.toUTCString()),t=encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var n="";for(var o in r)r[o]&&(n+="; "+o,!0!==r[o]&&(n+="="+r[o].split(";")[0]));return document.cookie=t+"="+e.write(s,t)+n}}return Object.create({set:s,get:function(t){if("undefined"!=typeof document&&(!arguments.length||t)){for(var i=document.cookie?document.cookie.split("; "):[],s={},r=0;r<i.length;r++){var n=i[r].split("="),o=n.slice(1).join("=");try{var a=decodeURIComponent(n[0]);if(s[a]=e.read(o,a),t===a)break}catch(t){}}return t?s[t]:s}},remove:function(t,e){s(t,"",ft({},e,{expires:-1}))},withAttributes:function(e){return t(this.converter,ft({},this.attributes,e))},withConverter:function(e){return t(ft({},this.converter,e),this.attributes)}},{attributes:{value:Object.freeze(i)},converter:{value:Object.freeze(e)}})}({read:function(t){return'"'===t[0]&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"});const wt={A:1,a:1,Z:1,z:1,"@":1},yt=t=>f(t)?t:H((()=>"gioenc-"+bt(t)))||t,St=t=>v(t)&&t.startsWith("gioenc-")&&H((()=>bt(t.replace("gioenc-",""))))||t,bt=t=>(t=t||"").split("").map((t=>wt[t]?t:Ot(t))).join(""),Ot=t=>{if(/[0-9]/.test(t))return 1^+t;{let e=t.charCodeAt(0);return String.fromCharCode(1^e)}};const Et={};let Nt;Nt=window.self===window.top&&!["","localhost","127.0.0.1"].includes(window.location.hostname)&&["http:","https:"].includes(window.location.protocol)||!(t=>{try{const t=window.localStorage,e="__storage_test__";return t.setItem(e,e),t.removeItem(e),!0}catch(t){return!1}})()?(()=>{let t=!1;if(navigator.cookieEnabled)return!0;const e=document.cookie;return document.cookie="gioCookie=yes;",document.cookie.indexOf("gioCookie=yes")>-1&&(t=!0),document.cookie=e,t})()?class{constructor(){this.getItem=t=>It(St(vt.get(pt(t)))),this.setItem=(t,e,i)=>mt().forEach((s=>{let r;r=v(e)?e.length?t.endsWith("_gioenc")?yt(e):e:"":JSON.stringify(e),vt.set(pt(t),r,{expires:i?new Date(i):3650,domain:s})})),this.removeItem=t=>mt().forEach((e=>vt.remove(pt(t),{domain:e}))),this.hasItem=t=>D(vt.get()).includes(pt(t)),this.getKeys=()=>D(vt.get())}}:class{constructor(){this.getItem=t=>{const e=H((()=>JSON.parse(Et[pt(t)]||"")));return y(e)&&e.expiredAt>+Date.now()?It(St(e.value)):void 0},this.setItem=(t,e,i)=>{const s=null!=i?i:+new Date(9999,12);Et[pt(t)]=JSON.stringify({value:v(e)&&e.length?yt(e):e,expiredAt:s})},this.removeItem=t=>K(Et,pt(t)),this.hasItem=t=>P(Et,pt(t)),this.getKeys=()=>D(Et)}}:class{constructor(){this.getItem=t=>{const e=H((()=>JSON.parse(localStorage.getItem(pt(t))||"")))||{};return y(e)&&e.expiredAt>+Date.now()?It(St(e.value)):void 0},this.setItem=(t,e,i)=>{const s=null!=i?i:+new Date(9999,12);localStorage.setItem(pt(t),JSON.stringify({value:v(e)&&e.length&&t.endsWith("_gioenc")?yt(e):e,expiredAt:s}))},this.removeItem=t=>localStorage.removeItem(pt(t)),this.hasItem=t=>!!localStorage.getItem(pt(t)),this.getKeys=()=>Array.from(Array(localStorage.length)).map(((t,e)=>localStorage.key(e)))}};var Tt,Ct=Nt;class jt{constructor(t){var e;this.growingIO=t;const{projectId:i}=this.growingIO.vdsConfig,{getItem:s,setItem:r}=this.growingIO.storage;this.getItem=s,this.setItem=r,this.sIdStorageName=i+"_gdp_session_id",this.uidStorageName="gdp_user_id_gioenc",this.userIdStorageName=i+"_gdp_cs1_gioenc",this.userKeyStorageName=i+"_gdp_user_key_gioenc",this.gioIdStorageName=i+"_gdp_gio_id_gioenc",null===(e=this.growingIO.emitter)||void 0===e||e.on(tt,(()=>{this.growingIO.gioSDKInitialized&&(this.growingIO.dataStore.sendVisit(!0),this.growingIO.dataStore.sendPage(!0))}))}get sessionId(){return this.getItem(this.sIdStorageName)||(this.sessionId=ht(),this.sessionId)}set sessionId(t){var e;t||(t=ht());const i=this.getItem(this.sIdStorageName)||this.prevSessionId,{sessionExpires:s=30}=this.growingIO.vdsConfig;this.setItem(this.sIdStorageName,t,+Date.now()+60*s*1e3),i!==t&&(null===(e=this.growingIO.emitter)||void 0===e||e.emit(tt,{newSessionId:t,oldSessionId:i})),this.prevSessionId=t}get uid(){return this.getItem(this.uidStorageName)||(this.uid=ht(),this.uid)}set uid(t){var e;const i=this.getItem(this.uidStorageName)||this.prevUId;this.setItem(this.uidStorageName,t),i!==t&&(null===(e=this.growingIO.emitter)||void 0===e||e.emit("UID_UPDATE",{newUId:t,oldUId:i})),this.prevUId=t}get userId(){return this.getItem(this.userIdStorageName)||""}set userId(t){var e;const i=this.getItem(this.userIdStorageName)||this.prevUserId;this.setItem(this.userIdStorageName,t),i!==t&&(null===(e=this.growingIO.emitter)||void 0===e||e.emit("USERID_UPDATE",{newUserId:t,oldUserId:i,userKey:this.userKey})),t&&(this.gioId=t),this.prevUserId=t}get userKey(){return this.getItem(this.userKeyStorageName)||""}set userKey(t){var e;const i=this.getItem(this.userKeyStorageName)||this.prevUserKey;this.setItem(this.userKeyStorageName,t),i!==t&&(null===(e=this.growingIO.emitter)||void 0===e||e.emit("USERKEY_UPDATE",{newUserKey:t,oldUserKey:i,userId:this.userId})),this.prevUserKey=t}get gioId(){return this.getItem(this.gioIdStorageName)||""}set gioId(t){var e;const i=this.getItem(this.gioIdStorageName)||this.prevGioId;this.setItem(this.gioIdStorageName,t),i!==t&&(null===(e=this.growingIO.emitter)||void 0===e||e.emit("GIOID_UPDATE",{newGioId:t,oldGioId:i})),this.prevGioId=t}}class kt{constructor(t){this.growingIO=t,this.main=()=>{var t;const{sdkVersion:e,useEmbeddedInherit:i,vdsConfig:s,userStore:r,dataStore:n,trackingId:o}=this.growingIO,{path:a,query:l}=n.currentPage;let d={appVersion:s.version,dataSourceId:s.dataSourceId,deviceId:r.uid,domain:i?s.appId:window.location.host,gioId:r.gioId,language:navigator.language,path:a,platform:s.platform,query:l,referralPage:(null===(t=n.lastPageEvent)||void 0===t?void 0:t.referralPage)||"",screenHeight:window.screen.height,screenWidth:window.screen.width,sdkVersion:e,sessionId:r.sessionId,timestamp:+Date.now(),title:document.title.slice(0,255),userId:r.userId};return s.enableIdMapping&&(d.userKey=r.userKey),L(this.minpExtraParams)||(d=Object.assign(Object.assign({},d),this.minpExtraParams)),L(s.ignoreFields)||s.ignoreFields.forEach((t=>{K(d,t)})),d.trackingId=o,d},this.minpExtraParams={}}}class xt{constructor(t){this.growingIO=t,this.parsePage=()=>{const{hashtag:t}=this.growingIO.vdsConfig,e=location.pathname,i=location.search,s=location.hash,r=s.indexOf("?");this.domain=window.location.host,this.path=e,t&&(this.path+=r>-1?s.slice(0,r):s),this.query=i,t&&r>-1&&(this.query=this.query+"&"+s.slice(r+1)),this.query&&["?","&"].includes(this.query.charAt(0))&&(this.query=this.query.slice(1)),this.time=+Date.now()},this.pageListener=()=>{this.lastHref!==window.location.href&&(this.parsePage(),this.buildPageEvent(),this.lastHref=window.location.href,this.lastLocation=window.location)},this.hookHistory=()=>{const t=window.history.pushState,e=window.history.replaceState;t&&(H((()=>window.history.pushState=(e,i,s)=>{t.call(window.history,e,i,s),setTimeout(this.pageListener)})),G(window,"popstate",(()=>{location.pathname===this.lastLocation.pathname&&location.search===this.lastLocation.search||this.pageListener}))),e&&H((()=>window.history.replaceState=(t,i,s)=>{e.call(window.history,t,i,s),setTimeout(this.pageListener)})),this.growingIO.vdsConfig.hashtag&&G(window,"hashchange",this.pageListener)},this.buildPageEvent=t=>{const{dataStore:{lastPageEvent:e,eventContextBuilder:i,eventConverter:s}}=this.growingIO;let r=Object.assign(Object.assign({eventType:"PAGE"},i()),{protocolType:location.protocol.substring(0,location.protocol.length-1),referralPage:(null==e?void 0:e.path)===this.path&&(null==e?void 0:e.query)===this.query?null==e?void 0:e.referralPage:(null==e?void 0:e.path)?this.lastHref:document.referrer});L(t)||(r=Object.assign(Object.assign({},r),t)),r.timestamp=this.time,s(r)},this.lastHref=window.location.href,this.lastLocation=window.location}}class _t extends class{constructor(t){var e,i;this.growingIO=t,this.ALLOW_SETTING=Object.assign(Object.assign({},d),"saas"===this.growingIO.gioEnvironment?h:c),this.allowOptKeys=Object.keys(this.ALLOW_SETTING),this.trackTimers={},this.initStorageId=()=>{const t=this.growingIO.storage.getItem(this.seqStorageIdName)||{};let e=Object.assign({},t);K(e,"globalKey"),e=y(e)&&!f(e)?e:{},this._esid={},D(e).forEach((t=>{this._esid[t]=Number.isNaN(Number(e[t]))||e[t]>=1e9||1>e[t]?1:e[t]})),R(e,this._esid)||this.setSequenceIds("esid",this._esid);const i=Number(t.globalKey);this._gsid=Number.isNaN(i)||i>=1e9||1>i?1:i,i!==this._gsid&&this.setSequenceIds("gsid",this._gsid)},this.setSequenceIds=(t,e)=>{let i=this.growingIO.storage.getItem(this.seqStorageIdName)||{};"gsid"===t?i.globalKey=e:i=Object.assign(Object.assign({},i),e),this.growingIO.storage.setItem(this.seqStorageIdName,i)},this.initOptions=t=>{const{projectId:e,dataSourceId:i,appId:s}=t;this.initialDataSourceId=i;const r={};this.allowOptKeys.forEach((e=>{const i=this.ALLOW_SETTING[e].type;let s=b(i)?!i.includes(B(t[e])):B(t[e])!==this.ALLOW_SETTING[e].type;"platform"!==e||l.includes(t[e])||(s=!0),s?r[e]=this.ALLOW_SETTING[e].default:"ignoreFields"===e?r.ignoreFields=t.ignoreFields.filter((t=>I.includes(t))):(r[e]=t[e],["dataCollect","autotrack"].includes(e)&&(r[e]||$("已关闭"+m[e],"info")))})),r.sessionExpires=Math.round(r.sessionExpires),(Number.isNaN(r.sessionExpires)||1>r.sessionExpires||r.sessionExpires>360)&&(r.sessionExpires=30),this.growingIO.vdsConfig=Object.assign(Object.assign({},r),{projectId:e,dataSourceId:i,appId:s,sdkVer:this.growingIO.sdkVersion}),window.vds=this.growingIO.vdsConfig,this.seqStorageIdName=e+"_gdp_sequence_ids"},this.setOption=(t,e)=>{var i;const{vdsConfig:s,callError:r,uploader:n,emitter:o}=this.growingIO,a=v(t)&&g.includes(t),l=a&&typeof e===((null===(i=this.ALLOW_SETTING[t])||void 0===i?void 0:i.type)||"string"),d=Object.assign({},s);return a&&l?(s[t]=e,"dataCollect"===t&&d.dataCollect!==e&&(e?(this.sendVisit(!0),this.sendPage()):this.growingIO.clearTrackTimer()),["host","scheme"].includes(t)&&(null==n||n.generateHost()),null==o||o.emit("OPTION_CHANGE",{optionName:t,optionValue:e}),!0):(r("setOption > "+t),!1)},this.getOption=t=>{const{vdsConfig:e,callError:i}=this.growingIO;return t&&P(e,j(t))?e[j(t)]:f(t)?Object.assign({},e):void i("getOption > "+t)},this.sendVisit=t=>{const{userStore:{sessionId:e},vdsConfig:{projectId:i,dataCollect:s},storage:r}=this.growingIO;if(s){const s=`${i}_gdp_session_id_${e}`,n=r.getItem(s);!t&&[!0,"true"].includes(n)||(this.buildVisitEvent(),r.setItem(s,!0))}},this.buildVisitEvent=t=>{const{dataStore:{eventContextBuilder:e,eventConverter:i}}=this.growingIO;let s=Object.assign(Object.assign({eventType:"VISIT"},e()),{referral:this.lastVisitEvent.referral,referralPage:this.lastPageEvent.referralPage});L(t)||(s.session=(null==t?void 0:t.session)||s.session,s.trackingId=null==t?void 0:t.trackingId,s=Object.assign(Object.assign({},s),t)),i(s)},this.sendPage=t=>{t&&this.currentPage.parsePage(),this.currentPage.buildPageEvent()},this.buildErrorEvent=t=>{const{dataStore:{eventContextBuilder:e,eventConverter:i}}=this.growingIO;i(Object.assign({eventType:"CUSTOM",pageShowTimestamp:this.currentPage.time,eventName:"onError",attributes:t},e()))},this.currentPage=new xt(this.growingIO),this.eventContextBuilderInst=new kt(this.growingIO),this.eventContextBuilder=this.eventContextBuilderInst.main,this.generalProps={},this.lastVisitEvent={referralPage:document.referrer},null===(e=this.growingIO.emitter)||void 0===e||e.on("onComposeAfter",(({composedEvent:t})=>{"VISIT"!==t.eventType&&"vst"!==t.t||t.trackingId!==this.growingIO.trackingId||(this.lastVisitEvent=t)})),this.lastPageEvent={},null===(i=this.growingIO.emitter)||void 0===i||i.on("onComposeAfter",(({composedEvent:t})=>{"PAGE"!==t.eventType&&"page"!==t.t||t.trackingId!==this.growingIO.trackingId||(this.lastPageEvent=t)}))}get esid(){const t=this.growingIO.storage.getItem(this.seqStorageIdName)||{};let e=Object.assign({},t);return K(e,"globalKey"),e=y(e)&&!f(e)?e:{},this._esid={},D(e).forEach((t=>{this._esid[t]=Number.isNaN(Number(e[t]))||e[t]>=1e9||1>e[t]?1:e[t]})),this._esid}set esid(t){const e={};D(t).forEach((i=>{e[i]=Number.isNaN(t[i])||t[i]>=1e9||1>t[i]?1:t[i]})),R(this._esid,e)||(this._esid=e,this.setSequenceIds("esid",this._esid))}get gsid(){const t=this.growingIO.storage.getItem(this.seqStorageIdName)||{},e=Number(t.globalKey);return this._gsid=Number.isNaN(e)||e>=1e9||1>e?1:e,this._gsid}set gsid(t){const e=Number(t);this._gsid=Number.isNaN(e)||t>=1e9||1>t?1:t,this.setSequenceIds("gsid",this._gsid)}}{constructor(t){super(t),this.growingIO=t,this.eventConverter=t=>{var e;const{vdsConfig:i,dataStore:s,uploader:r}=this.growingIO;if(i.dataCollect){t.trackingId===this.growingIO.trackingId&&(t.globalSequenceId=s.gsid,t.eventSequenceId=s.esid[t.eventType]||1);const i={};U(t,((t,e)=>{var s;if("element"===e){const e=null!==(s=E(t))&&void 0!==s?s:{};U(e,((t,e)=>{L(t)&&0!==t||(i[e]=t)}))}else(L(t)||f(t))&&0!==t||(i[e]=t)})),t.trackingId===this.growingIO.trackingId&&(this.growingIO.dataStore.gsid+=1,this.growingIO.dataStore.esid=Object.assign(Object.assign({},this.growingIO.dataStore.esid),{[i.eventType]:(this.growingIO.dataStore.esid[i.eventType]||1)+1})),null===(e=this.growingIO.emitter)||void 0===e||e.emit("onComposeAfter",{composedEvent:Object.assign({},i)}),t.trackingId===this.growingIO.trackingId&&r.commitRequest(i)}}}}class qt extends class{constructor(t){this.growingIO=t,this.commitRequest=t=>{const e=Object.assign({},t);this.requestQueue.push(Object.assign(Object.assign({},e),{requestType:ut()?"Beacon":"XHR"})),this.initiateRequest()},this.initiateRequest=()=>{var t,e;if([...this.requestQueue].length>0&&this.requestingNum<this.requestLimit){const{vdsConfig:i,emitter:s,plugins:r,useHybridInherit:n}=this.growingIO;if(this.requestQueue=[...this.requestQueue].filter((t=>(this.retryIds[t.globalSequenceId||t.esid]||0)<=this.retryLimit)),L(this.requestQueue))return;const o=this.requestQueue.shift(),{requestType:a}=o;if(null==s||s.emit("onSendBefore",{requestData:o}),K(o,["requestType","trackingId"]),i.debug&&console.log("[GrowingIO Debug]:",JSON.stringify(o,null,2).replace(/\"/g,(()=>{const t=window.navigator.userAgent;return/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(t)&&!/chrome\/(\d+\.\d+)/i.test(t)})()?"":'"')),this.requestingNum+=1,n)return this.requestSuccessFn(o),!1;let l=Object.assign({},o);switch(i.compress&&(null===(t=null==r?void 0:r.gioCompress)||void 0===t?void 0:t.compressToUint8Array)?(this.compressType="1",l=null===(e=null==r?void 0:r.gioCompress)||void 0===e?void 0:e.compressToUint8Array(JSON.stringify([l]))):(this.compressType="0",l=JSON.stringify([l])),a){case"Beacon":default:this.sendByBeacon(o,l);break;case"XHR":this.sendByXHR(o,l);break;case"Image":this.sendByImage(o,l)}}},this.generateURL=()=>`${this.requestURL}?stm=${+Date.now()}&compress=${this.compressType}`,this.sendByBeacon=(t,e)=>{navigator.sendBeacon(this.generateURL(),e)?this.requestSuccessFn(t):this.requestFailFn(t,"Beacon")},this.sendByXHR=(t,e)=>{var i;const s=["unload","beforeunload","pagehide"].includes(null===(i=null===window||void 0===window?void 0:window.event)||void 0===i?void 0:i.type),r=new XMLHttpRequest;if(r)return r.open("POST",this.generateURL(),s),r.onreadystatechange=()=>{4===r.readyState&&204===r.status?this.requestSuccessFn(t):this.requestFailFn(t,"XHR")},r.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),void r.send(e);if(null===window||void 0===window?void 0:window.XDomainRequest){const i=new window.XDomainRequest;i.open("POST",this.generateURL().replace("https://","http://"),s),i.onload=()=>{204===i.status?this.requestSuccessFn(t):this.requestFailFn(t,"XHR")},i.onerror=i.ontimeout=()=>{this.requestFailFn(t,"XHR")},i.send(e)}},this.sendByImage=(t,e)=>{const i=`${this.generateURL()}&data=${e}`;let s=document.createElement("img");s.width=1,s.height=1,s.onload=()=>{this.requestSuccessFn(t),this.clearImage(s)},s.onerror=s.onabort=()=>{this.requestFailFn(t,"Image"),this.clearImage(s)},s.src=i},this.clearImage=t=>{t.src="",t.onload=()=>{},t.onerror=t.onerabort=()=>{},t=null},this.requestSuccessFn=t=>{var e;this.requestingNum-=1;const i=t.globalSequenceId||t.esid||-1;this.retryIds[i]&&(this.retryIds[i]=0),this.growingIO.userStore.sessionId=this.growingIO.userStore.sessionId,null===(e=this.growingIO.emitter)||void 0===e||e.emit("onSendAfter",{requestData:t}),this.initiateRequest()},this.requestFailFn=(t,e)=>{this.requestingNum-=1;const i=t.globalSequenceId||t.esid||-1;this.retryIds[i]||(this.retryIds[i]=0),this.retryIds[i]+=1;const s=this.requestQueue.some((e=>e.globalSequenceId===t.globalSequenceId&&e.esid===t.esid));let r=e;this.retryIds[i]<this.retryLimit+1||(r="Beacon"===e?"XHR":"XHR"===e?"Image":void 0,this.retryIds[i]=0),!s&&r&&this.requestQueue.push(Object.assign(Object.assign({},t),{requestType:r}))},this.requestQueue=[],this.requestLimit=10,this.requestTimeout=5e3,this.retryLimit=1,this.retryIds={},this.requestingNum=0,this.requestURL=""}}{constructor(t){super(t),this.growingIO=t,this.generateHost=()=>{let{scheme:t,host:e="",projectId:i}=this.growingIO.vdsConfig;t?q(j(t),"://")||(t+="://"):t=(location.protocol.indexOf("http")>-1?location.protocol.replace(":",""):"https")+"//",_(e,"http")&&(e=e.substring(e.indexOf("://")+(q(j(t),"://")?3:0))),this.requestURL=`${t}${e}/v3/projects/${i}/collect`},this.requestURL="",this.generateHost()}}const At=new class extends class{constructor(){var t;this.trackingId="g0",this.init=t=>{var e,i,s,r,n;$("Gio Web SDK 初始化中...","info");const{initOptions:o,currentPage:a,sendVisit:l,sendPage:d}=this.dataStore;o(t),this.useEmbeddedInherit=null===(i=null===(e=this.plugins)||void 0===e?void 0:e.gioEmbeddedAdapter)||void 0===i?void 0:i.main(t),this.useHybridInherit=null===(r=null===(s=this.plugins)||void 0===s?void 0:s.gioHybridAdapter)||void 0===r?void 0:r.main(t),null==this||this.initCallback(),a.hookHistory(),a.parsePage(),null===(n=this.emitter)||void 0===n||n.emit("SDK_INITIALIZED",this),$("Gio Web SDK 初始化完成！","success"),this.useEmbeddedInherit||l(),d(),this.gioSDKInitialized=!0},this.setOption=(t,e)=>{if(g.includes(t)){const i=this.dataStore.setOption(t,e);return i&&m[t]&&$(`已${e?"开启":"关闭"}${m[t]}`,"info"),i}return $(`不存在可修改的配置项：${t}，请检查后重试!`,"warn"),!1},this.getOption=t=>this.dataStore.getOption(t),this.setGeneralProps=t=>{y(t)&&!L(t)?(this.dataStore.generalProps=Object.assign(Object.assign({},this.dataStore.generalProps),t),D(this.dataStore.generalProps).forEach((t=>{[void 0,null].includes(this.dataStore.generalProps[t])&&(this.dataStore.generalProps[t]="")}))):this.callError("setGeneralProps")},this.clearGeneralProps=t=>{b(t)&&!L(t)?t.forEach((t=>{K(this.dataStore.generalProps,t)})):this.dataStore.generalProps={}},this.reissuePage=()=>{this.dataStore.sendPage()},this.notRecommended=()=>$("不推荐的方法使用，建议使用 gio('setOption', [optionName], [value])!","info"),this.callError=(t,e=!0,i="参数不合法")=>$(`${e?"调用":"设置"} ${t} 失败，${i}!`,"warn"),this.gioEnvironment="cdp",this.sdkVersion="3.8.0-rc.7",this.utils=Object.assign(Object.assign(Object.assign({},F),W),{qs:et}),this.emitter={all:t=t||new Map,on:function(e,i){var s=t.get(e);s?s.push(i):t.set(e,[i])},off:function(e,i){var s=t.get(e);s&&(i?s.splice(s.indexOf(i)>>>0,1):t.set(e,[]))},emit:function(e,i){var s=t.get(e);s&&s.slice().map((function(t){t(i)})),(s=t.get("*"))&&s.slice().map((function(t){t(e,i)}))}},this.gioSDKInitialized=!1,this.storage=new Ct,this.plugins=new ct(this),this.plugins.innerPluginInit()}}{constructor(){super(),this.registerPlugins=t=>{t.forEach(((e,i)=>{var s;L(e)||f(e)?$("插件不合法，跳过加载!","warn"):e.js&&(t[i]=Object.assign(Object.assign({},null===(s=e.js)||void 0===s?void 0:s.default),{options:e.options}))})),t=C(t),this.plugins.pluginItems=[...this.plugins.pluginItems,...t],this.plugins.installAll(t)},this.initCallback=()=>{var t,e;this.userStore=new jt(this),this.uploader=new qt(this),null===(e=null===(t=this.plugins)||void 0===t?void 0:t.gioEventAutoTracking)||void 0===e||e.main(),this.vdsConfig.enableIdMapping||(this.userStore.userKey="")},this.setTrackerScheme=t=>{["http","https"].includes(t)?(this.dataStore.setOption("scheme",t),this.notRecommended()):this.callError("scheme",!1)},this.setTrackerHost=t=>{Z.test(t)||Y.test(t)?(this.dataStore.setOption("host",t),this.notRecommended()):this.callError("host",!1)},this.setDataCollect=t=>{this.setOption("dataCollect",!!t),this.notRecommended()},this.setAutotrack=t=>{this.setOption("autotrack",!!t),this.notRecommended()},this.enableDebug=t=>{this.setOption("debug",!!t),this.notRecommended()},this.enableHT=t=>{this.setOption("hashtag",!!t),this.notRecommended()},this.getVisitorId=()=>this.userStore.uid,this.getDeviceId=()=>this.userStore.uid,this.setUserAttributes=(t,e)=>{var i,s;!L(t)&&y(t)?null===(s=null===(i=this.plugins)||void 0===i?void 0:i.gioCustomTracking)||void 0===s||s.buildUserAttributesEvent(t,e):this.callError("setUserAttributes")},this.setUserId=(t,e)=>{if(z(j(t).trim())){const i=this.userStore.gioId;this.vdsConfig.enableIdMapping&&(this.userStore.userKey=!f(e)&&j(e).length>0?j(e).slice(0,1e3):""),t=j(t).slice(0,1e3),this.userStore.userId=t,i&&i!==t&&(this.userStore.sessionId=""),i||i===t||this.dataStore.sendVisit(!0)}else this.clearUserId(),this.callError("setUserId")},this.clearUserId=()=>{this.userStore.userId="",this.userStore.userKey=""},this.track=(t,e,i,s)=>{var r,n;((null===(n=null===(r=this.plugins)||void 0===r?void 0:r.gioCustomTracking)||void 0===n?void 0:n.buildCustomEvent)||function(){})(t,Object.assign(Object.assign({},this.dataStore.generalProps),y(e)&&!L(e)?e:{}),i,s)},this.sendPage=t=>this.dataStore.currentPage.buildPageEvent(t),this.sendVisit=t=>this.dataStore.buildVisitEvent(t),this.trackTimerStart=(t,e)=>{if(this.vdsConfig.dataCollect)if(v(t)&&!L(t)&&t.match(/^[a-zA-Z_][0-9a-zA-Z_]{0,50}$/)){const i=ht();S(e)?(this.dataStore.trackTimers[i]={eventName:t,leng:0,start:+Date.now()},e(i)):$("回调方法不合法，返回timerId失败!")}else $("事件名格式不正确，只能包含数字、字母和下划线，且不能以数字开头!","error")},this.trackTimerPause=t=>{if(t&&this.dataStore.trackTimers[t]){const e=this.dataStore.trackTimers[t];e.start&&(e.leng=e.leng+(+Date.now()-e.start)),e.start=0}},this.trackTimerResume=t=>{if(t&&this.dataStore.trackTimers[t]){const e=this.dataStore.trackTimers[t];0===e.start&&(e.start=+Date.now())}},this.trackTimerEnd=(t,e)=>{if(this.vdsConfig.dataCollect){const i=864e5;if(t&&this.dataStore.trackTimers[t]){const s=this.dataStore.trackTimers[t];if(0!==s.start){const t=+Date.now()-s.start;s.leng=t>0?s.leng+t:0}this.track(s.eventName,Object.assign(Object.assign({},e),{eventDuration:s.leng>i?0:s.leng/1e3})),this.removeTimer(t)}else $("未查找到对应的计时器，请检查!","error")}},this.removeTimer=t=>{t&&this.dataStore.trackTimers[t]&&delete this.dataStore.trackTimers[t]},this.clearTrackTimer=()=>{this.dataStore.trackTimers={}},this.dataStore=new _t(this)}},Pt=function(){const t=arguments[0];if(v(t)&&u.includes(t)&&At[t]){const e=T(Array.from(arguments));if("init"===t){if(!M(At))return;if(!X(e))return;const t=J(e);if(!t)return;const i=Q(e);if(!i)return;const{projectId:s}=t,{dataSourceId:r,appId:n,cdpOptions:o}=i;At.init(Object.assign(Object.assign({},o),{projectId:s,dataSourceId:r,appId:n}))}else if("registerPlugins"===t)At.registerPlugins(e[0]);else{if(At.gioSDKInitialized&&At.vdsConfig)return At[t](...e);$("SDK未初始化!","error")}}else p.includes(t)?$(`方法 ${j(t)} 已被弃用，请移除!`,"warn"):$(`不存在名为 ${j(t)} 的方法调用!`,"error");window.gioEnvironment="cdp",window.gioSDKVersion=At.sdkVersion},Dt=null===(Tt=null===window||void 0===window?void 0:window.gdp)||void 0===Tt?void 0:Tt.q;return window.gdp=Pt,b(Dt)&&!L(Dt)&&Dt.forEach((t=>{Pt.apply(null,t)})),Pt}));
