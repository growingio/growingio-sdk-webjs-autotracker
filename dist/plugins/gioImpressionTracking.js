var e=function(){return e=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var i in t=arguments[r])({}).hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},e.apply(this,arguments)};"function"==typeof SuppressedError&&SuppressedError;var t,r,n,i,o,a="function"==typeof Array.from?Array.from:(r||(r=1,n=function(e){return"function"==typeof e},i=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),9007199254740991)},o=function(e){var t=e.next();return!t.done&&t},t=function(e){var t,r,a,u=this,c=arguments.length>1?arguments[1]:void 0;if(void 0!==c){if(!n(c))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(t=arguments[2])}var s=function(e,t){if(null!=e&&null!=t){var r=e[t];if(null==r)return;if(!n(r))throw new TypeError(r+" is not a function");return r}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==s){r=n(u)?Object(new u):[];var f,l,v=s.call(e);if(null==v)throw new TypeError("Array.from requires an array-like or iterable object");for(a=0;;){if(!(f=o(v)))return r.length=a,r;l=f.value,r[a]=c?c.call(t,l,a):l,a++}}else{var m=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var d,p=i(m.length);for(r=n(u)?Object(new u(p)):Array(p),a=0;p>a;)d=m[a],r[a]=c?c.call(t,d,a):d,a++;r.length=p}return r}),t),u=function(e){return l(["undefined","null"],y(e))},c=function(e){return"object"===y(e)&&!u(e)},s=function(e){return Array.isArray(e)&&"array"===y(e)},f=function(e){try{return v(e)[0]}catch(e){return}},l=function(e,t){return("array"===y(e)||"string"===y(e))&&e.indexOf(t)>=0},v=a,m=function(e){return u(e)?"":"".concat(e)},d=function(e){if("string"===y(e)){var t=function(e,t){return"string"==typeof e?e.split(""):e}(e);return"".concat(f(t).toLowerCase()).concat((r=t,void 0===n&&(n=1),s(r)&&function(e){return"number"===y(e)}(n)?r.slice(n>0?n:1,r.length):r).join(""))}var r,n;return e},p={}.hasOwnProperty,g=function(e,t){return!u(e)&&p.call(e,t)},b=function(e){return c(e)?Object.keys(e):[]},y=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},h=function(t,r,n,i){void 0===i&&(i={}),document.addEventListener?t.addEventListener(r,n,e(e({},{capture:!0}),i)):t.attachEvent?t.attachEvent("on"+r,n):t["on"+r]=n},O=function(e){var t={};return c(e)&&function(e,r){b(e).forEach((function(r){return function(e,r){var n=m(r).slice(0,100);c(e)?t[n]=O(e):s(e)?(t[n]=e.slice(0,100),t[n]=t[n].join("||").slice(0,1e3)):t[n]=u(e)?"":m(e).slice(0,1e3)}(e[r],r)}))}(e),t},I=/^data-gio-track-[a-z]+$/i,w=/^gioTrack(.+)/,A=/^[a-zA-Z][a-zA-Z0-9_]{0,99}$/,E={name:"gioImpressionTracking",method:function(t){var r,n=this;this.growingIO=t,this.documentReady=!1,this.main=function(e){"listener"===e?(n.documentReady=!0,n.growingIO.gioSDKInitialized&&n.initMutationObserver()):"emitter"===e&&n.documentReady&&n.initMutationObserver()},this.initIntersectionObserver=function(){n.intersectionObserver=new IntersectionObserver((function(e){var t;(s(t=e)?0===t.length:c(t)?0===b(t).length:!t)||e.map((function(e){var t=e.target.dataset;if(e.intersectionRatio>0){var r=n.getImpressionProperties(t),i=r.eventName,o=r.properties,a=t.id;if(a){if("once"===t.gioImpType&&g(n.sentImps,a))return;n.sentImps[a]={eventName:i,properties:o}}i&&n.buildImpEvent({eventName:i,properties:o})}}))}))},this.initMutationObserver=function(){if(n.mutationObserver)return!1;var e=document.querySelectorAll("[data-gio-imp-track]");v(e).map((function(e){var t;null===(t=n.intersectionObserver)||void 0===t||t.observe(e)})),n.mutationObserver=new MutationObserver((function(e){return e.map((function(e){var t;if("attributes"===e.type&&e.target.dataset.gioImpTrack)return null===(t=n.intersectionObserver)||void 0===t?void 0:t.observe(e.target)}))})),n.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0,attributeOldValue:!0,attributeFilter:["data-gio-imp-track","data-gio-imp-attrs",I]})},this.getImpressionProperties=function(e){var t={eventName:void 0,properties:{}};if(!(null==e?void 0:e.gioImpTrack))return t;if(t.eventName=e.gioImpTrack,g(e,"gioImpAttrs"))t.properties=function(t){try{return c(e.gioImpAttrs)?e.gioImpAttrs:JSON.parse(e.gioImpAttrs)}catch(e){return}}();else for(var r in e){var n=void 0,i=r.match(w);i&&"track"!==(n=d(i[1]))&&(t.properties[n]=e[r])}return t.properties=O(t.properties),A.test(t.eventName)&&!Number.isInteger(Number(f(t.eventName.split(""))))||(t.eventName=null,t={}),t},this.buildImpEvent=function(t){var r=t.eventName,i=t.properties,o=n.growingIO.dataStore,a=o.eventContextBuilder;(0,o.eventConverter)(e(e({eventType:"CUSTOM",eventName:r,attributes:i},a()),{customEventType:0}))},this.sentImps={},window.ActiveXObject||"ActiveXObject"in window||navigator.userAgent.indexOf("compatible")>-1&&navigator.userAgent.indexOf("MSIE")>-1||navigator.userAgent.indexOf("Trident")>-1&&navigator.userAgent.indexOf("rv:11.0")>-1?("warn",console.log("%c [GrowingIO]：IE浏览器不支持半自动埋点，gioImpressionTracking已自动关闭！","color: #F59E0B;")):(this.initIntersectionObserver(),h(document,"readystatechange",(function(){l(["interactive","complete"],document.readyState)&&n.main("listener")}),{once:!0}),null===(r=this.growingIO.emitter)||void 0===r||r.on("SDK_INITIALIZED",(function(){return n.main("emitter")})),h(window,"unload",(function(){var e,t;null===(e=n.intersectionObserver)||void 0===e||e.disconnect(),null===(t=n.mutationObserver)||void 0===t||t.disconnect()})))}};export{E as default};
