var t,e,r,n,i,o=function(){return o=Object.assign||function(t){for(var e,r=1,n=arguments.length;n>r;r++)for(var i in e=arguments[r])({}).hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},o.apply(this,arguments)},a="function"==typeof Array.from?Array.from:(e||(e=1,r=function(t){return"function"==typeof t},n=function(t){var e=function(t){var e=Number(t);return isNaN(e)?0:0!==e&&isFinite(e)?(e>0?1:-1)*Math.floor(Math.abs(e)):e}(t);return Math.min(Math.max(e,0),9007199254740991)},i=function(t){var e=t.next();return!e.done&&e},t=function(t){var e,o,a,u=this,c=arguments.length>1?arguments[1]:void 0;if(void 0!==c){if(!r(c))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(e=arguments[2])}var s=function(t,e){if(null!=t&&null!=e){var n=t[e];if(null==n)return;if(!r(n))throw new TypeError(n+" is not a function");return n}}(t,function(t){if(null!=t){if(["string","number","boolean","symbol"].indexOf(typeof t)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in t)return Symbol.iterator;if("@@iterator"in t)return"@@iterator"}}(t));if(void 0!==s){o=r(u)?Object(new u):[];var l,v,f=s.call(t);if(null==f)throw new TypeError("Array.from requires an array-like or iterable object");for(a=0;;){if(!(l=i(f)))return o.length=a,o;v=l.value,o[a]=c?c.call(e,v,a):v,a++}}else{var m=Object(t);if(null==t)throw new TypeError("Array.from requires an array-like object - not null or undefined");var d,p=n(m.length);for(o=r(u)?Object(new u(p)):Array(p),a=0;p>a;)d=m[a],o[a]=c?c.call(e,d,a):d,a++;o.length=p}return o}),t),u=function(t){return v(["undefined","null"],y(t))},c=function(t){return"object"===y(t)&&!u(t)},s=function(t){return Array.isArray(t)&&"array"===y(t)},l=function(t){try{return f(t)[0]}catch(t){return}},v=function(t,e){return("array"===y(t)||"string"===y(t))&&t.indexOf(e)>=0},f=a,m=function(t){return u(t)?"":"".concat(t)},d=function(t){if("string"===y(t)){var e=function(t,e){return"string"==typeof t?t.split(""):t}(t);return"".concat(l(e).toLowerCase()).concat((r=e,void 0===n&&(n=1),s(r)&&function(t){return"number"===y(t)}(n)?r.slice(n>0?n:1,r.length):r).join(""))}var r,n;return t},p={}.hasOwnProperty,g=function(t,e){return!u(t)&&p.call(t,e)},b=function(t){return c(t)?Object.keys(t):[]},y=function(t){return{}.toString.call(t).slice(8,-1).toLowerCase()},h=function(t,e,r,n){void 0===n&&(n={}),document.addEventListener?t.addEventListener(e,r,o(o({},{capture:!0}),n)):t.attachEvent?t.attachEvent("on"+e,r):t["on"+e]=r},I=function(t){var e={};return c(t)&&function(t,r){b(t).forEach((function(r){return function(t,r){var n=m(r).slice(0,100);c(t)?e[n]=I(t):s(t)?(e[n]=t.slice(0,100),e[n]=e[n].join("||").slice(0,1e3)):e[n]=u(t)?"":m(t).slice(0,1e3)}(t[r],r)}))}(t),e},O=/^data-gio-track-[a-z]+$/i,w=/^gioTrack(.+)/,N=/^[a-zA-Z][a-zA-Z0-9_]{0,99}$/,k={name:"gioImpressionTracking",method:function(t){var e,r=this;this.growingIO=t,this.documentReady=!1,this.main=function(t){"listener"===t?(r.documentReady=!0,r.growingIO.gioSDKInitialized&&r.initMutationObserver()):"emitter"===t&&r.documentReady&&r.initMutationObserver()},this.initIntersectionObserver=function(){r.intersectionObserver=new IntersectionObserver((function(t){var e;(s(e=t)?0===e.length:c(e)?0===b(e).length:!e)||t.map((function(t){var e=t.target,n=e.dataset,i=e.id;if(t.intersectionRatio>0){var o=r.getImpressionProperties(n),a=o.eventName,u=o.properties;if(i){if("once"===n.gioImpType&&g(r.sentImps,i))return;r.sentImps[i]={eventName:a,properties:u}}a&&r.buildImpEvent({eventName:a,properties:u},n.gioImpSendto||r.growingIO.trackingId)}}))}))},this.initMutationObserver=function(){var t;r.mutationObserver&&(null===(t=r.mutationObserver)||void 0===t||t.disconnect());var e=document.querySelectorAll("[data-gio-imp-track]");f(e).map((function(t){var e;null===(e=r.intersectionObserver)||void 0===e||e.observe(t)})),r.mutationObserver=new MutationObserver((function(t){t.map((function(t){var e,n;"attributes"===t.type&&(null===(e=t.target.dataset)||void 0===e?void 0:e.gioImpTrack)&&(null===(n=r.intersectionObserver)||void 0===n||n.observe(t.target))}))})),r.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0,attributeOldValue:!0,attributeFilter:["data-gio-imp-track","data-gio-imp-attrs",O,"data-gio-imp-sendto"]})},this.getImpressionProperties=function(t){var e={eventName:void 0,properties:{}};if(!(null==t?void 0:t.gioImpTrack))return e;if(e.eventName=t.gioImpTrack,g(t,"gioImpAttrs"))e.properties=function(e){try{return c(t.gioImpAttrs)?t.gioImpAttrs:JSON.parse(t.gioImpAttrs)}catch(t){return}}();else for(var r in t){var n=void 0,i=r.match(w);i&&"track"!==(n=d(i[1]))&&(e.properties[n]=t[r])}return e.properties=I(e.properties),N.test(e.eventName)&&!Number.isInteger(Number(l(e.eventName.split(""))))||(e.eventName=null,e={}),e},this.buildImpEvent=function(t,e){var n=t.eventName,i=t.properties,a=r.growingIO.dataStore,u=a.eventContextBuilder,c=a.eventConverter;(0,a.getTracker)(e)&&c(o(o({eventType:"CUSTOM",eventName:n,attributes:i},u(e)),{customEventType:0}))},this.sentImps={},window.IntersectionObserver&&window.MutationObserver?(this.initIntersectionObserver(),h(document,"readystatechange",(function(){v(["interactive","complete"],document.readyState)&&r.main("listener")}),{once:!0}),null===(e=this.growingIO.emitter)||void 0===e||e.on("OPTION_INITIALIZED",(function(t){t.trackingId===r.growingIO.trackingId&&r.main("emitter")})),h(window,"unload",(function(){var t,e;null===(t=r.intersectionObserver)||void 0===t||t.disconnect(),null===(e=r.mutationObserver)||void 0===e||e.disconnect()}))):("warn",console.log("%c [GrowingIO]：当前浏览器不支持半自动埋点，gioImpressionTracking已自动关闭！","color: #F59E0B;"))}};export{k as default};
