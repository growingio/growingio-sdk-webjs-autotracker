var t,e,n,r,i=function(){return i=Object.assign||function(t){for(var e,n=1,r=arguments.length;r>n;n++)for(var i in e=arguments[n])({}).hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},i.apply(this,arguments)};function o(t){return t&&t.__esModule&&{}.hasOwnProperty.call(t,"default")?t.default:t}var a,u,c,s=r?n:(r=1,n="function"==typeof Array.from?Array.from:(e||(e=1,a=function(t){return"function"==typeof t},u=function(t){var e=function(t){var e=Number(t);return isNaN(e)?0:0!==e&&isFinite(e)?(e>0?1:-1)*Math.floor(Math.abs(e)):e}(t);return Math.min(Math.max(e,0),9007199254740991)},c=function(t){var e=t.next();return!e.done&&e},t=function(t){var e,n,r,i=this,o=arguments.length>1?arguments[1]:void 0;if(void 0!==o){if(!a(o))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(e=arguments[2])}var s=function(t,e){if(null!=t&&null!=e){var n=t[e];if(null==n)return;if(!a(n))throw new TypeError(n+" is not a function");return n}}(t,function(t){if(null!=t){if(["string","number","boolean","symbol"].indexOf(typeof t)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in t)return Symbol.iterator;if("@@iterator"in t)return"@@iterator"}}(t));if(void 0!==s){n=a(i)?Object(new i):[];var l,f,d=s.call(t);if(null==d)throw new TypeError("Array.from requires an array-like or iterable object");for(r=0;;){if(!(l=c(d)))return n.length=r,n;f=l.value,n[r]=o?o.call(e,f,r):f,r++}}else{var v=Object(t);if(null==t)throw new TypeError("Array.from requires an array-like object - not null or undefined");var m,p=u(v.length);for(n=a(i)?Object(new i(p)):Array(p),r=0;p>r;)m=v[r],n[r]=o?o.call(e,m,r):m,r++;n.length=p}return n}),t)),l=function(t){return b(["undefined","null"],k(t))},f=function(t){return"string"===k(t)},d=function(t){return"object"===k(t)&&!l(t)},v=function(t){return Array.isArray(t)&&"array"===k(t)},m=function(t){return"date"===k(t)},p=function(t){try{return h(t)[0]}catch(t){return}},g=function(t,e){if(void 0===e&&(e=!1),v(t)){for(var n=0,r=[],i=0,o=t;i<o.length;i++){var a=o[i];a&&!T(a)&&(r[n++]=a),e&&0===a&&(r[n++]=a)}return r}return t},b=function(t,e){return("array"===k(t)||"string"===k(t))&&("array"===k(e)?e.some((function(e){return t.indexOf(e)>=0})):t.indexOf(e)>=0)},h=o(s),y=function(t){return l(t)?"":"".concat(t)},I=function(t){if(f(t)){var e=function(t,e){return"string"==typeof t?t.split(""):t}(t);return"".concat(p(e).toLowerCase()).concat((n=e,void 0===r&&(r=1),v(n)&&function(t){return"number"===k(t)}(r)?n.slice(r>0?r:1,n.length):n).join(""))}var n,r;return t},O={}.hasOwnProperty,w=function(t,e){return!l(t)&&O.call(t,e)},S=function(t){return d(t)?Object.keys(t):[]},N=function(t,e){if(!d(t))return!1;try{return"string"===k(e)?delete t[e]:"array"===k(e)?e.map((function(e){return delete t[e]})):(function(t){return"regexp"===k(t)}(e)&&S(t).forEach((function(n){e.test(n)&&N(t,n)})),!0)}catch(t){return!1}},T=function(t){return v(t)?0===t.length:d(t)?0===S(t).length:!t},k=function(t){return{}.toString.call(t).slice(8,-1).toLowerCase()},A=function(t){for(var e=[],n=1;arguments.length>n;n++)e[n-1]=arguments[n];try{return t.apply(void 0,e)}catch(t){return}},E=function(t,e,n,r){void 0===r&&(r={}),document.addEventListener?t.addEventListener(e,n,i(i({},{capture:!0}),r)):t.attachEvent?t.attachEvent("on"+e,n):t["on"+e]=n},M=function(t){var e={};return d(t)&&(N(t,"&&sendTo"),function(t,n){S(t).forEach((function(n){return function(t,n){var r=y(n).slice(0,100);d(t)?e[r]=M(t):v(t)?(e[r]=g(t.slice(0,100),!0),e[r]=e[r].join("||").slice(0,1e3)):m(t)?e[r]=function(t){if(m(t)){var e=function(t){return 10>t?"0"+t:t};return t.getFullYear()+"-"+e(t.getMonth()+1)+"-"+e(t.getDate())+" "+e(t.getHours())+":"+e(t.getMinutes())+":"+e(t.getSeconds())+"."+e(t.getMilliseconds())}return t}(t):e[r]=l(t)?"":y(t).slice(0,1e3)}(t[n],n)}))}(t)),e},j=/^data-gio-track-[a-z]+$/i,x=/^gioTrack(.+)/,L=/^[a-zA-Z][a-zA-Z0-9_]{0,99}$/,C={name:"gioImpressionTracking",method:function(t){var e,n=this;this.growingIO=t,this.documentReady=!1,this.main=function(t){b(["listener","manual"],t)?(n.documentReady=!0,n.growingIO.gioSDKInitialized&&(n.initIntersectionObserver(),n.initMutationObserver())):"emitter"===t&&n.documentReady&&(n.initIntersectionObserver(),n.initMutationObserver())},this.initIntersectionObserver=function(){var t,e=(null===(t=n.growingIO.vdsConfig)||void 0===t?void 0:t.impressionScale)||1e-13;n.intersectionObserver=new IntersectionObserver((function(t){T(t)||t.map((function(t){var r=t.target,i=r.dataset,o=r.id;if(t.intersectionRatio>=e){var a=n.getImpressionProperties(i);if(o){if("once"===i.gioImpType&&w(n.sentImps,o))return;n.sentImps[o]=a}if(a.eventName){var u=[];i.gioImpSendto&&(u=g(v(i.gioImpSendto)?i.gioImpSendto:A((function(){return JSON.parse(i.gioImpSendto)}))||[]),T(u)&&A((function(){return i.gioImpSendto.split(",").forEach((function(t){(t=f(t)&&t.trim().replace("[","").replace("]",""))&&u.push(t)}))}))),n.buildImpEvent(a,u)}}}))}),{threshold:[e]})},this.initMutationObserver=function(){var t;n.mutationObserver&&(null===(t=n.mutationObserver)||void 0===t||t.disconnect());var e=document.querySelectorAll("[data-gio-imp-track]");h(e).map((function(t){var e;null===(e=n.intersectionObserver)||void 0===e||e.observe(t)})),n.mutationObserver=new MutationObserver((function(t){t.map((function(t){var e,r;"attributes"===t.type&&(null===(e=t.target.dataset)||void 0===e?void 0:e.gioImpTrack)&&(null===(r=n.intersectionObserver)||void 0===r||r.observe(t.target)),"childList"===t.type&&t.addedNodes.forEach((function(t){var e,r;(null===(e=t.dataset)||void 0===e?void 0:e.gioImpTrack)&&(null===(r=n.intersectionObserver)||void 0===r||r.observe(t))}))}))})),n.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0,attributeOldValue:!0,attributeFilter:["data-gio-imp-track","data-gio-imp-attrs",j,"data-gio-imp-sendto"]})},this.getImpressionProperties=function(t){var e={eventName:void 0,properties:{}};if(!(null==t?void 0:t.gioImpTrack))return e;if(e.eventName=t.gioImpTrack,w(t,"gioImpAttrs"))e.properties=A((function(){return d(t.gioImpAttrs)?t.gioImpAttrs:JSON.parse(t.gioImpAttrs)}));else for(var n in t){var r=void 0,i=n.match(x);i&&"track"!==(r=I(i[1]))&&(e.properties[r]=t[n])}return e.properties=M(e.properties),L.test(e.eventName)&&!Number.isInteger(Number(p(e.eventName.split(""))))||(e.eventName=null,e={}),e},this.buildImpEvent=function(t,e){var r,o=t.eventName,a=t.properties,u=n.growingIO,c=u.trackingId,s=u.dataStore,l=s.eventContextBuilder,f=s.eventConverter,v=u.plugins,m=i({eventType:"CUSTOM",eventName:o},l(c));m.attributes=M(i(i({},null!==(r=m.attributes)&&void 0!==r?r:{}),d(a)&&!T(a)?a:{})),v.gioMultipleInstances&&!T(e)&&(m["&&sendTo"]=e),f(m)},this.pluginVersion="4.3.1",this.sentImps={},window.IntersectionObserver&&window.MutationObserver?("complete"===document.readyState?this.main("listener"):E(document,"readystatechange",(function(){"complete"===document.readyState&&n.main("listener")}),{once:!0}),null===(e=this.growingIO.emitter)||void 0===e||e.on("OPTION_INITIALIZED",(function(t){t.trackingId===n.growingIO.trackingId&&n.main("emitter")})),E(window,"unload",(function(){var t,e;null===(t=n.intersectionObserver)||void 0===t||t.disconnect(),null===(e=n.mutationObserver)||void 0===e||e.disconnect()}))):("warn",console.log("%c [GrowingIO]：当前浏览器不支持半自动埋点，gioImpressionTracking已自动关闭！","color: #F59E0B;"))}};export{C as default};
