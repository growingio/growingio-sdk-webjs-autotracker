!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,t,n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var o in t=arguments[n])({}).hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},n.apply(this,arguments)};function r(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;i>o;o++)!r&&o in t||(r||(r=[].slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||[].slice.call(t))}var o,i,a,u="function"==typeof Array.from?Array.from:(t||(t=1,o=function(e){return"function"==typeof e},i=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),9007199254740991)},a=function(e){var t=e.next();return!t.done&&t},e=function(e){var t,n,r,u=this,c=arguments.length>1?arguments[1]:void 0;if(void 0!==c){if(!o(c))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(t=arguments[2])}var s=function(e,t){if(null!=e&&null!=t){var n=e[t];if(null==n)return;if(!o(n))throw new TypeError(n+" is not a function");return n}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==s){n=o(u)?Object(new u):[];var f,l,g=s.call(e);if(null==g)throw new TypeError("Array.from requires an array-like or iterable object");for(r=0;;){if(!(f=a(g)))return n.length=r,n;l=f.value,n[r]=c?c.call(t,l,r):l,r++}}else{var d=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var h,m=i(d.length);for(n=o(u)?Object(new u(m)):Array(m),r=0;m>r;)h=d[r],n[r]=c?c.call(t,h,r):h,r++;n.length=m}return n}),e),c=function(e){return d(["undefined","null"],_(e))},s=function(e){return"string"===_(e)},f=function(e){return"number"===_(e)},l=function(e){return"NaN"===m(Number(e))},g=function(e){return"object"===_(e)&&!c(e)},d=function(e,t){return("array"===_(e)||"string"===_(e))&&e.indexOf(t)>=0},h=u,m=function(e){return c(e)?"":"".concat(e)},v=function(e,t){return!!s(e)&&e.slice(0,t.length)===t},p=function(e,t){if(s(e)){var n=e.length,r=n;r>n&&(r=n);var o=r;return(r-=t.length)>=0&&e.slice(r,o)===t}return!1},y={}.hasOwnProperty,w=function(e){return g(e)?Object.keys(e):[]},I=function(e,t){if(!g(e))return!1;try{return"string"===_(t)?delete e[t]:"array"===_(t)?t.map((function(t){return delete e[t]})):(function(e){return"regexp"===_(e)}(t)&&w(e).forEach((function(n){t.test(n)&&I(e,n)})),!0)}catch(e){return!1}},b=function(e){return function(e){return Array.isArray(e)&&"array"===_(e)}(e)?0===e.length:g(e)?0===w(e).length:!e},_=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},S=function(e,t){console.log("%c [GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444;",warn:"color: #F59E0B;",success:"color: #10B981;"}[t]||"")},C=function(e){try{return e()}catch(e){return}},T=function(e,t){if(d(["function","asyncfunction"],_(e)))try{e(t)}catch(e){S("回调执行失败！".concat(e),"error")}},O=function(e){var t=0;if(b(e)||"boolean"==typeof e)return t;for(var n=0;n<e.length;)t=(t<<5)-t+e.charCodeAt(n),t&=t,n++;return t};function x(e){for(var t=1;arguments.length>t;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}var A,D=function e(t,n){function r(e,r,o){if("undefined"!=typeof document){"number"==typeof(o=x({},n,o)).expires&&(o.expires=new Date(Date.now()+864e5*o.expires)),o.expires&&(o.expires=o.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var i="";for(var a in o)o[a]&&(i+="; "+a,!0!==o[a]&&(i+="="+o[a].split(";")[0]));return document.cookie=e+"="+t.write(r,e)+i}}return Object.create({set:r,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var n=document.cookie?document.cookie.split("; "):[],r={},o=0;o<n.length;o++){var i=n[o].split("="),a=i.slice(1).join("=");try{var u=decodeURIComponent(i[0]);if(r[u]=t.read(a,u),e===u)break}catch(e){}}return e?r[e]:r}},remove:function(e,t){r(e,"",x({},t,{expires:-1}))},withAttributes:function(t){return e(this.converter,x({},this.attributes,t))},withConverter:function(t){return e(x({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(n)},converter:{value:Object.freeze(t)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"}),N=function(e){return p(e,"_gioenc")?e.slice(0,-7):e},k=function(e){return l(Number(e))&&C((function(){return JSON.parse(e)}))||e},q={A:1,a:1,Z:1,z:1,"@":1,"{":1},j=function(e){return c(e)?e:C((function(){return"gioenc-".concat(E(e))}))||e},B=function(e){return s(e)&&v(e,"gioenc-")&&C((function(){return E(e.replace("gioenc-",""))}))||e},E=function(e){return(e=e||"").split("").map((function(e){return q[e]?e:R(e)})).join("")},R=function(e){if(/[0-9]/.test(e))return 1^+e;var t=e.charCodeAt(0);return String.fromCharCode(1^t)},U=function(e){var t=this;this.domain=e,this.getItem=function(e){return k(B(D.get(N(e),{domain:t.domain,path:"/"})))},this.setItem=function(e,n,r){var o;o=s(n)?n.length?p(e,"_gioenc")?j(n):n:"":JSON.stringify(n),D.set(N(e),o,{expires:r?new Date(r):new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()),domain:t.domain,path:"/"})},this.removeItem=function(e){D.remove(N(e),{domain:t.domain,path:"/"})},this.hasItem=function(e){return d(w(D.get()),N(e))},this.getKeys=function(){return w(D.get())},this.type="Cookie"},M=function(){this.getItem=function(e){var t=C((function(){return JSON.parse(localStorage.getItem(N(e))||"")}))||{};return g(t)&&t.expiredAt>+Date.now()?k(B(t.value)):void 0},this.setItem=function(e,t,n){var r=null!=n?n:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();localStorage.setItem(N(e),JSON.stringify({value:s(t)&&t.length&&p(e,"_gioenc")?j(t):t,expiredAt:r}))},this.removeItem=function(e){return localStorage.removeItem(N(e))},this.hasItem=function(e){return!!localStorage.getItem(N(e))},this.getKeys=function(){return h(Array(localStorage.length)).map((function(e,t){return localStorage.key(t)}))},this.type="localStorage"},F={},H=function(){this.getItem=function(e){var t=C((function(){return JSON.parse(F[N(e)]||"")}));return g(t)&&t.expiredAt>+Date.now()?k(B(t.value)):void 0},this.setItem=function(e,t,n){var r=null!=n?n:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();F[N(e)]=JSON.stringify({value:s(t)&&t.length?j(t):t,expiredAt:r})},this.removeItem=function(e){return I(F,N(e))},this.hasItem=function(e){return function(e,t){return!c(e)&&y.call(e,t)}(F,N(e))},this.getKeys=function(){return w(F)},this.type="memory"},J=/^(\.ac\.|\.br\.|\.co\.|\.com\.|\.edu\.|\.gov\.|\.org\.|\.net\.)/,K=function(e){var t=[];try{var n=e.split("."),r=function(e){try{var t=h(e);return t[t.length-1]}catch(e){return}}(n);if(n.length>=2&&(isNaN(Number(r))||0>Number(r)||Number(r)>255)){var o=".".concat(n.slice(-2).join("."));J.test(o)?A=o:t.push(o);var i=".".concat(n.slice(-3).join("."));J.test(i)||d(t,i)||t.push(i);var a=".".concat(n.slice(-4).join("."));J.test(a)||d(t,a)||t.push(a)}}catch(e){}return t},$=function(e){var t="";return e.every((function(e){return!P(e)||(t=e,!1)})),t},P=function(e){try{D.set("gioCookie","yes",{domain:e});var t=!!D.get("gioCookie",{domain:e});return D.remove("gioCookie",{domain:e}),t}catch(e){return!1}},L=function(e){var t,n,o,i=e.storageType,a=e.cookieDomain,u=e.projectId;if(d(["cookie","localstorage"],i)||(i="cookie"),"cookie"===i&&(n=!!(o=navigator.userAgent.indexOf("Electron")>-1||d(["","localhost","127.0.0.1"],window.location.hostname)||!d(["http:","https:"],window.location.protocol)?"":$(r(r([],K(window.location.hostname),!0),[window.location.hostname],!1)))),"cookie"===i&&n){var c=new U(o);if(a){var s=K(a),f=$(b(s)?[]:r([a],K(a),!0));f&&P(f)?c.domain=f:S("指定Cookie域无效或无权限，使用默认域！","warn")}t=c}else t=function(){try{var e=window.localStorage,t="__storage_test__";return e.setItem(t,t),e.removeItem(t),!0}catch(e){return!1}}()?new M:new H;return"cookie"===i&&A&&P(A)&&function(e,t,n){if(t&&P(t)){var r=new U(t);["".concat(n,"_gdp_session_id"),"gdp_user_id_gioenc","".concat(n,"_gdp_cs1_gioenc"),"".concat(n,"_gdp_user_key_gioenc"),"".concat(n,"_gdp_gio_id_gioenc"),"".concat(n,"_gdp_sequence_ids"),"".concat(n,"_gdp_session_id_sent")].forEach((function(t){var n=r.getItem(t);r.hasItem(t)&&(e.setItem(t,n),r.removeItem(t))})),r=void 0}}(t,A,u),t},Y={},z={}.hasOwnProperty;function V(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function X(e){try{return encodeURIComponent(e)}catch(e){return null}}Y.stringify=function(e,t){t=t||"";var n,r,o=[];for(r in"string"!=typeof t&&(t="?"),e)if(z.call(e,r)){if((n=e[r])||null!=n&&!isNaN(n)||(n=""),r=X(r),n=X(n),null===r||null===n)continue;o.push(r+"="+n)}return o.length?t+o.join("&"):""},Y.parse=function(e){for(var t,n=/([^=?#&]+)=?([^&]*)/g,r={};t=n.exec(e);){var o=V(t[1]),i=V(t[2]);null===o||null===i||o in r||(r[o]=i)}return r};window.gioABTest={name:"gioABTest",method:function(e,t){var r=this;this.growingIO=e,this.timeoutCheck=function(e,t){r.requestInterval=f(Number(e))&&!l(Number(e))?Number(e):5,(r.requestInterval>1440||0>r.requestInterval)&&(r.requestInterval=5),r.requestTimeout=f(Number(t))&&!l(Number(t))?Number(t):1e3,(r.requestTimeout>5e3||100>r.requestTimeout)&&(r.requestTimeout=1e3)},this.abtStorageCheck=function(){var e=r.abtStorage.getKeys();e.filter((function(e){return/^\d+_gdp_abt_sign$/.test(e)})).forEach((function(e){var t=r.abtStorage.getItem(e);t&&t>=Date.now()||r.abtStorage.removeItem(e)})),e.filter((function(e){return/^\d+_gdp_abtd$/.test(e)})).forEach((function(e){b(r.abtStorage.getItem(e))&&r.abtStorage.removeItem(e)}))},this.getHashKey=function(e){var t=r.growingIO,n=t.userStore.uid,o=t.vdsConfig.projectId;return Math.abs(O("".concat(o,"#").concat(n,"#").concat(e)))},this.generateUrl=function(e){v(e,"http")?r.url="".concat(e,"/diversion/specified-layer-variables"):r.url="https://".concat(e,"/diversion/specified-layer-variables")},this.getABTest=function(e,t){if(r.url){if(!e)return S("获取ABTest数据失败! 实验层Id不合法!","error"),void T(t,{});var n=r.abtStorage.getItem("".concat(r.getHashKey(e),"_gdp_abt_sign"))||0,o=r.abtStorage.getItem("".concat(r.getHashKey(e),"_gdp_abtd"))||{};!n||n<Date.now()?r.initiateRequest(e,o,t):T(t,o)}else T(t,{})},this.initiateRequest=function(e,t,o){var i=r.growingIO,a=i.userStore.uid,u=i.vdsConfig,c=u.projectId,s=u.dataSourceId,f=new XMLHttpRequest;if(f)return f.open("POST",r.url,!0),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),f.timeout=r.requestTimeout,f.onload=function(i){var a,u=null!==(a=C((function(){return JSON.parse(i.target.responseText)})))&&void 0!==a?a:{};0===u.code?r.experimentVerify(n(n({},u),{layerId:e}),t,o):(S("获取ABTest数据失败! ".concat(u.errorMsg,"!"),"error"),T(o,{})),r.abtStorage.setItem("".concat(r.getHashKey(e),"_gdp_abt_sign"),Date.now()+6e4*r.requestInterval)},f.ontimeout=function(){S("获取ABTest数据失败! 请求超时!","error"),T(o,{})},f.onerror=function(){200!==f.status&&(2>r.retryCount?(r.initiateRequest(e,t,o),r.retryCount+=1):(S("获取ABTest数据失败! ".concat(f.statusText,"!"),"error"),T(o,{})))},void f.send(Y.stringify({accountId:c,datasourceId:s,distinctId:a,layerId:e}));S("获取ABTest数据失败! 当前环境不支持XMLHttpRequest!","error")},this.experimentVerify=function(e,t,n){var o=e.layerId,i=e.strategyId,a=e.experimentId,u=e.variables,c="".concat(r.getHashKey(o),"_gdp_abtd"),s={layerId:m(o),strategyId:m(i),experimentId:m(a),variables:u};O(JSON.stringify(s))!==O(JSON.stringify(t))&&(r.abtStorage.setItem(c,s,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),i&&a&&r.buildExperimentHitEvent(m(o),m(a),m(i))),T(n,s)},this.buildExperimentHitEvent=function(e,t,o){var i=r.growingIO.dataStore,a=i.eventContextBuilder;(0,i.eventConverter)(n(n({eventType:"CUSTOM",eventName:"$exp_hit",attributes:{$exp_layer_id:e,$exp_id:t,$exp_strategy_id:o}},a()),{customEventType:0}))};var o=null!=t?t:{},i=o.abServerUrl,a=o.requestInterval,u=o.requestTimeout,c=this.growingIO.emitter;this.timeoutCheck(a,u),this.abtStorage=L({storageType:"localstorage"}),this.growingIO.getABTest=this.getABTest,c.on("OPTION_INITIALIZED",(function(){i?(r.abtStorageCheck(),r.generateUrl(i)):S("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn")})),this.retryCount=0}}}));
