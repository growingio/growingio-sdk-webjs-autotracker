!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,r,t=function(){return t=Object.assign||function(e){for(var r,t=1,n=arguments.length;n>t;t++)for(var o in r=arguments[t])({}).hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e},t.apply(this,arguments)};function n(e,r,t){if(t||2===arguments.length)for(var n,o=0,i=r.length;i>o;o++)!n&&o in r||(n||(n=[].slice.call(r,0,o)),n[o]=r[o]);return e.concat(n||[].slice.call(r))}var o,i,c,a="function"==typeof Array.from?Array.from:(r||(r=1,o=function(e){return"function"==typeof e},i=function(e){var r=function(e){var r=Number(e);return isNaN(r)?0:0!==r&&isFinite(r)?(r>0?1:-1)*Math.floor(Math.abs(r)):r}(e);return Math.min(Math.max(r,0),9007199254740991)},c=function(e){var r=e.next();return!r.done&&r},e=function(e){var r,t,n,a=this,l=arguments.length>1?arguments[1]:void 0;if(void 0!==l){if(!o(l))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(r=arguments[2])}var s=function(e,r){if(null!=e&&null!=r){var t=e[r];if(null==t)return;if(!o(t))throw new TypeError(t+" is not a function");return t}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==s){t=o(a)?Object(new a):[];var u,g,d=s.call(e);if(null==d)throw new TypeError("Array.from requires an array-like or iterable object");for(n=0;;){if(!(u=c(d)))return t.length=n,t;g=u.value,t[n]=l?l.call(r,g,n):g,n++}}else{var f=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var p,h=i(f.length);for(t=o(a)?Object(new a(h)):Array(h),n=0;h>n;)p=f[n],t[n]=l?l.call(r,p,n):p,n++;t.length=h}return t}),e),l=function(e){return g(["undefined","null"],w(e))},s=function(e){return"string"===w(e)},u=function(e){return"object"===w(e)&&!l(e)},g=function(e,r){return("array"===w(e)||"string"===w(e))&&("array"===w(r)?r.some((function(r){return e.indexOf(r)>=0})):e.indexOf(r)>=0)},d=a,f=function(e,r){return!!s(e)&&e.slice(0,r.length)===r},p=function(e,r){if(s(e)){var t=e.length,n=t;n>t&&(n=t);var o=n;return(n-=r.length)>=0&&e.slice(n,o)===r}return!1},h={}.hasOwnProperty,m=function(e,r){return!l(e)&&h.call(e,r)},v=function(e){return u(e)?Object.keys(e):[]},I=function(e,r){if(!u(e))return!1;try{return"string"===w(r)?delete e[r]:"array"===w(r)?r.map((function(r){return delete e[r]})):(function(e){return"regexp"===w(e)}(r)&&v(e).forEach((function(t){r.test(t)&&I(e,t)})),!0)}catch(e){return!1}},w=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},y=function(e){try{return e()}catch(e){return}},O=function(e){return p(e,"_gioenc")?e.slice(0,-7):e},S=function(e){if(f(e,"?")||g(e,["=","&"])){var r={};return f(e,"?")&&(e=e.substring(1)),e.split("&").forEach((function(e){var t,n=e.split("="),o=n[0],i=null!==(t=n[1])&&void 0!==t?t:"";l(o)||""===o||(r[o]=i)})),r}return decodeURIComponent(e)},b=function(e,r){if(void 0===r&&(r=!1),"object"===w(e)){var t="";return o=function(e,n){""===t?t=(r?"?":"")+"".concat(n,"=").concat(e):t+="&".concat(n,"=").concat(e)},v(n=e).forEach((function(e){return o(n[e],e)})),t}var n,o;if("string"===w(e))return encodeURIComponent(e)},q="ON_SEND_AFTER",U={A:1,a:1,Z:1,z:1,"@":1,"{":1},E=function(e){return(e=e||"").split("").map((function(e){return U[e]?e:C(e)})).join("")},C=function(e){if(/[0-9]/.test(e))return 1^+e;var r=e.charCodeAt(0);return String.fromCharCode(1^r)},j=function(){this.getItem=function(e){var r,t=y((function(){return JSON.parse(localStorage.getItem(O(e))||"")}))||{};return u(t)&&t.expiredAt>+Date.now()?function(e){return isNaN(Number(e))&&y((function(){return JSON.parse(e)}))||e}((r=t.value,s(r)&&f(r,"gioenc-")&&y((function(){return E(r.replace("gioenc-",""))}))||r)):void 0},this.setItem=function(e,r,t){var n,o=null!=t?t:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();localStorage.setItem(O(e),JSON.stringify({value:s(r)&&r.length&&p(e,"_gioenc")?(n=r,l(n)?n:y((function(){return"gioenc-".concat(E(n))}))||n):r,expiredAt:o}))},this.removeItem=function(e){return localStorage.removeItem(O(e))},this.hasItem=function(e){return!!localStorage.getItem(O(e))},this.getKeys=function(){return d(Array(localStorage.length)).map((function(e,r){return localStorage.key(r)}))},this.type="localStorage"},T={},R={}.hasOwnProperty;function k(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function A(e){try{return encodeURIComponent(e)}catch(e){return null}}T.stringify=function(e,r){r=r||"";var t,n,o=[];for(n in"string"!=typeof r&&(r="?"),e)if(R.call(e,n)){if((t=e[n])||null!=t&&!isNaN(t)||(t=""),n=A(n),t=A(t),null===n||null===t)continue;o.push(n+"="+t)}return o.length?r+o.join("&"):""},T.parse=function(e){for(var r,t=/([^=?#&]+)=?([^&]*)/g,n={};r=t.exec(e);){var o=k(r[1]),i=k(r[2]);null===o||null===i||o in n||(n[o]=i)}return n};var F={gioprojectid:"projectId",giodatacollect:"dataCollect",gioappid:"domain",giodatasourceid:"dataSourceId",gios:"sessionId",giou:"uid",giocs1:"userId",giouserkey:"userKey",gioappchannel:"appChannel",giodevicebrand:"deviceBrand",giodevicemodel:"deviceModel",giodevicetype:"deviceType",giolanguage:"language",gionetworkstate:"networkState",giooperatingsystem:"operatingSystem",gioplatform:"platform",gioplatformversion:"platformVersion",gioscreenheight:"screenHeight",gioscreenwidth:"screenWidth",giocircleroomid:"circleRoomId"},N=["gioprojectid","giodatacollect","giodatasourceid","gioplatform","giocircleroomid"],x=["giodatasourceid","gioplatform","gioappchannel","giodevicebrand","giodevicemodel","giodevicetype","giolanguage","gionetworkstate","giooperatingsystem","gioplatformversion","gioscreenheight","gioscreenwidth"],D=["giocs1","gios","giou","giouserkey"],V="gdp_query_string",_="gdp_circle_error";window.gioEmbeddedAdapter={name:"gioEmbeddedAdapter",method:function(e){var r=this;this.growingIO=e,this.circleOpen=!1,this.onOptionsInit=function(e,t){var n,o,i,c=t.projectId,a=t.appId,l=e===r.growingIO.trackingId?t.hashtag:r.growingIO.vdsConfig.hashtag,s=r.getGQS(l);if(g(["search","hash"],r.qsFrom)&&!(function(e){return Array.isArray(e)&&"array"===w(e)}(i=s)?0===i.length:u(i)?0===v(i).length:!i)&&r.storage.setItem(V,s),!r.growingIO.useEmbeddedInherit&&"none"!==r.qsFrom&&s.gioprojectid===c&&s.gioappid===a){r.growingIO.useEmbeddedInherit=e,r.growingIO.dataStore.updateVdsConfig(e,{minipLink:!0}),s.giocircleroomid?r.circleInit(s.giocircleroomid):r.storage.removeItem(_);var d=r.growingIO.dataStore.getTrackerVds(e);N.forEach((function(e){if(m(s,e))if("giodatacollect"===e)d.dataCollect=g(["true",!0],s.giodatacollect);else{var r=F[e];g(["domain","platform"],r)&&(d.originValues||(d.originValues={}),d.originValues[r]=d[r]),d[r]=s[e]}})),r.growingIO.dataStore.updateVdsConfig(e,d);var f=r.growingIO,p=f.userStore,h=f.dataStore.eventContextBuilderInst;p.setUid(s.giou),p.setSessionId(e,s.gios),p.setUserId(e,null!==(n=s.giocs1)&&void 0!==n?n:""),p.setUserKey(e,null!==(o=s.giouserkey)&&void 0!==o?o:"");var I=window.setInterval((function(){p.setSessionId(e,s.gios)}),.8*t.sessionExpires*60*1e3);window.onbeforeunload=function(){window.clearInterval(I),I=void 0},x.forEach((function(e){m(s,e)&&(h.minpExtraParams[F[e]]=s[e])}));var y=r.growingIO.setUserId;r.growingIO.setUserId=function(){for(var r=[],t=0;arguments.length>t;t++)r[t]=arguments[t];if(r[0]!==e)return y.apply(this,r)};var O=r.growingIO.clearUserId;if(r.growingIO.clearUserId=function(){for(var r=[],t=0;arguments.length>t;t++)r[t]=arguments[t];if(r[0]!==e)return O.apply(this,r)},m(s,"giodatacollect")){var S=r.growingIO.setOption;r.growingIO.setOption=function(){for(var r=[],t=0;arguments.length>t;t++)r[t]=arguments[t];if(r[0]!==e)return S.apply(this,r)}}}!1!==r.growingIO.dataStore.getTrackerVds(r.growingIO.trackingId).rewriteQuery&&r.gioURLRewrite(),r.growingIO.dataStore.currentPage.parsePage()},this.getGQS=function(e){var o=window.location.search,i=window.location.hash,c=e?i.substring(i.indexOf("?")+1):"",a=r.storage.getItem(V),l=T.parse(o),s=S(o),u=T.parse(c),d=S(c),f={},p={};if(m(l,"gioprojectid"))f=l,p=s,r.qsFrom="search";else if(m(u,"gioprojectid"))f=u,p=d,r.qsFrom="hash";else{if(!m(a,"gioprojectid"))return r.qsFrom="none",{};f=a,p=a,r.qsFrom="local"}var h={},I={},w=n(n(["gioappid","gioprojectid","giodatacollect","giocircleurl","giocircleroomid"],D,!0),x,!0);return v(f).forEach((function(e){var r=e.toLowerCase();g(w,r)?g(["","undefined","null",void 0,null],f[e])?h[r]="":(h[r]=f[e],g(["true","TRUE",!0],f[e])&&(h[r]=!0),g(["false","FALSE",!1],f[e])&&(h[r]=!1)):I[e]=p[e]})),r.gqs=h,r.customerqs=I,t(t({},r.gqs),r.customerqs)},this.gioURLRewrite=function(){var e=r.growingIO.vdsConfig.hashtag,t=window.location.search,n=window.location.hash,o=!1;if("search"===r.qsFrom&&(t=b(r.customerqs,!0),o=!0),e&&"hash"===r.qsFrom&&(n="".concat(n.split("?")[0]).concat(b(r.customerqs,!0)),o=!0),o){var i="".concat(window.location.pathname).concat(t||"").concat(n||"");window.history.replaceState(null,document.title,i)}},this.circleInit=function(e){var t;console.log("%c [GrowingIO]：您已进入小程序圈选模式","color: #3B82F6;"),r.circleRoomId=e,r.circleOpen=!0;var n=r.growingIO.useEmbeddedInherit;if(r.circleServerUrl={},null===(t=r.options)||void 0===t?void 0:t.circleServerUrl){var o=r.options.circleServerUrl;s(o)?r.generateUrl(n,o):u(o)&&v(o).forEach((function(e){r.generateUrl(e,o[e])}))}else r.generateUrl(n,"portal.growingio.com");r.growingIO.emitter.on(q,r.collectorSendFn)},this.generateUrl=function(e,t){f(t,"http")?r.circleServerUrl[e]="".concat(t,"/api/public/circle-room/collect?roomId=").concat(r.circleRoomId):r.circleServerUrl[e]="https://".concat(t,"/api/public/circle-room/collect?roomId=").concat(r.circleRoomId)},this.collectorSendFn=function(e){var n=e.requestData,o=e.trackingId,i=t({},n);r.circleOpen&&"CUSTOM"!==i.eventType&&o===r.growingIO.useEmbeddedInherit&&(I(i,["requestType","trackingId","requestId"]),r.circleRequest(o,i))},this.circleRequest=function(e,t){var n,o,i=new XMLHttpRequest;i.open("POST",r.circleServerUrl[e],!0),i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.onload=i.ontimeout=i.onerror=i.onabort=function(e){var t=e.target,n=t.status,o=y((function(){return JSON.parse(t.responseText)}));g([200,204],n)&&(null==o?void 0:o.success)||(r.circleClose(),r.storage.getItem(_)!==r.circleRoomId&&(r.storage.setItem(_,r.circleRoomId),alert("H5："+((null==o?void 0:o.message)||o||t.responseText||"圈选请求失败，请重试!"))))},i.timeout=null!==(o=null===(n=r.options)||void 0===n?void 0:n.requestTimeout)&&void 0!==o?o:5e3,i.send(JSON.stringify([t]))},this.circleClose=function(){r.circleOpen=!1,r.circleServerUrl="",r.growingIO.emitter.off(q,r.collectorSendFn);var e=r.storage.getItem(V);I(e,["giocircleserverurl","giocircleroomid"]),r.storage.setItem(V,e)},this.pluginVersion="4.3.0",this.gqs={},this.customerqs={},this.qsFrom="search",this.storage=new j,this.growingIO.emitter.on("OPTION_INITIALIZED",(function(e){var t=e.trackingId,n=e.vdsConfig;r.onOptionsInit(t,n)}))}}}));
