var e,r,t,o,n=function(){return n=Object.assign||function(e){for(var r,t=1,o=arguments.length;o>t;t++)for(var n in r=arguments[t])({}).hasOwnProperty.call(r,n)&&(e[n]=r[n]);return e},n.apply(this,arguments)};function i(e,r,t){for(var o,n=0,i=r.length;i>n;n++)!o&&n in r||(o||(o=[].slice.call(r,0,n)),o[n]=r[n]);return e.concat(o||[].slice.call(r))}function a(e){return e&&e.__esModule&&{}.hasOwnProperty.call(e,"default")?e.default:e}var c,l,s,u=o?t:(o=1,t="function"==typeof Array.from?Array.from:(r||(r=1,c=function(e){return"function"==typeof e},l=function(e){var r=function(e){var r=Number(e);return isNaN(r)?0:0!==r&&isFinite(r)?(r>0?1:-1)*Math.floor(Math.abs(r)):r}(e);return Math.min(Math.max(r,0),9007199254740991)},s=function(e){var r=e.next();return!r.done&&r},e=function(e){var r,t,o,n=this,i=arguments.length>1?arguments[1]:void 0;if(void 0!==i){if(!c(i))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(r=arguments[2])}var a=function(e,r){if(null!=e&&null!=r){var t=e[r];if(null==t)return;if(!c(t))throw new TypeError(t+" is not a function");return t}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==a){t=c(n)?Object(new n):[];var u,g,d=a.call(e);if(null==d)throw new TypeError("Array.from requires an array-like or iterable object");for(o=0;;){if(!(u=s(d)))return t.length=o,t;g=u.value,t[o]=i?i.call(r,g,o):g,o++}}else{var f=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var h,p=l(f.length);for(t=c(n)?Object(new n(p)):Array(p),o=0;p>o;)h=f[o],t[o]=i?i.call(r,h,o):h,o++;t.length=p}return t}),e)),g=function(e){return h(["undefined","null"],S(e))},d=function(e){return"string"===S(e)},f=function(e){return"object"===S(e)&&!g(e)},h=function(e,r){return("array"===S(e)||"string"===S(e))&&("array"===S(r)?r.some((function(r){return e.indexOf(r)>=0})):e.indexOf(r)>=0)},p=a(u),m=function(e,r){return!!d(e)&&e.slice(0,r.length)===r},v=function(e,r){if(d(e)){var t=e.length,o=t;o>t&&(o=t);var n=o;return(o-=r.length)>=0&&e.slice(o,n)===r}return!1},I={}.hasOwnProperty,w=function(e,r){return!g(e)&&I.call(e,r)},y=function(e){return f(e)?Object.keys(e):[]},O=function(e,r){if(!f(e))return!1;try{return"string"===S(r)?delete e[r]:"array"===S(r)?r.map((function(r){return delete e[r]})):(function(e){return"regexp"===S(e)}(r)&&y(e).forEach((function(t){r.test(t)&&O(e,t)})),!0)}catch(e){return!1}},S=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},b=function(e){for(var r=[],t=1;arguments.length>t;t++)r[t-1]=arguments[t];try{return e.apply(void 0,r)}catch(e){return}},U=function(e){return v(e,"_gioenc")?e.slice(0,-7):e},E=function(e){if(m(e,"?")||h(e,["=","&"])){var r={},t=[];return m(e,"?")&&(e=e.substring(1)),e.split("&").forEach((function(e){var o,n=e.split("="),i=n[0],a=null!==(o=n[1])&&void 0!==o?o:"";g(i)||""===i||(r[i]=a,t.push(i))})),n(n({},r),{__GIO_ORDER__:t})}return decodeURIComponent(e)},_=function(e,r){if("object"===S(e)){var t="";return(e.__GIO_ORDER__||y(e)).forEach((function(r){"__GIO_ORDER__"!==r&&w(e,r)&&(""===t?t="?"+"".concat(r,"=").concat(e[r]):t+="&".concat(r,"=").concat(e[r]))})),t}if("string"===S(e))return encodeURIComponent(e)},R="ON_SEND_AFTER",q={A:1,a:1,Z:1,z:1,"@":1,"{":1},C=function(e){return(e=e||"").split("").map((function(e){return q[e]?e:T(e)})).join("")},T=function(e){if(/[0-9]/.test(e))return 1^+e;var r=e.charCodeAt(0);return String.fromCharCode(1^r)},j=function(){this.getItem=function(e){var r,t=b((function(){return JSON.parse(localStorage.getItem(U(e))||"")}))||{};return f(t)&&t.expiredAt>+Date.now()?function(e){return isNaN(Number(e))&&b((function(){return JSON.parse(e)}))||e}((r=t.value,d(r)&&m(r,"gioenc-")&&b((function(){return C(r.replace("gioenc-",""))}))||r)):void 0},this.setItem=function(e,r,t){var o,n=null!=t?t:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();localStorage.setItem(U(e),JSON.stringify({value:d(r)&&r.length&&v(e,"_gioenc")?(o=r,g(o)?o:b((function(){return"gioenc-".concat(C(o))}))||o):r,expiredAt:n}))},this.removeItem=function(e){return localStorage.removeItem(U(e))},this.hasItem=function(e){return!!localStorage.getItem(U(e))},this.getKeys=function(){return p(Array(localStorage.length)).map((function(e,r){return localStorage.key(r)}))},this.type="localStorage"},k={gioprojectid:"projectId",giodatacollect:"dataCollect",gioappid:"domain",giodatasourceid:"dataSourceId",gios:"sessionId",giou:"uid",giocs1:"userId",giouserkey:"userKey",gioappchannel:"appChannel",giodevicebrand:"deviceBrand",giodevicemodel:"deviceModel",giodevicetype:"deviceType",giolanguage:"language",gionetworkstate:"networkState",giooperatingsystem:"operatingSystem",gioplatform:"platform",gioplatformversion:"platformVersion",gioscreenheight:"screenHeight",gioscreenwidth:"screenWidth",giocircleroomid:"circleRoomId"},A=["gioprojectid","giodatacollect","giodatasourceid","gioplatform","giocircleroomid"],F=["giodatasourceid","gioplatform","gioappchannel","giodevicebrand","giodevicemodel","giodevicetype","giolanguage","gionetworkstate","giooperatingsystem","gioplatformversion","gioscreenheight","gioscreenwidth"],x=i(i(["gioappid","gioprojectid","giodatacollect","giocircleroomid"],["giocs1","gios","giou","giouserkey"]),F),N="gdp_query_string",D="gdp_circle_error",Q={name:"gioEmbeddedAdapter",method:function(e){var r=this;this.growingIO=e,this.pluginVersion="4.3.1",this.options={},this.searchQs={},this.hashQs={},this.gqs={},this.customerQs={},this.qsFrom="search",this.circleOpen=!1,this.circleServerUrl={},this.onOptionsInit=function(e,t){var o,n,i,a=t.projectId,c=t.appId,l=e===r.growingIO.trackingId?t.hashtag:r.growingIO.vdsConfig.hashtag,s=r.getGQS(l);if(h(["search","hash"],r.qsFrom)&&!(function(e){return Array.isArray(e)&&"array"===S(e)}(i=s)?0===i.length:f(i)?0===y(i).length:!i)&&r.storage.setItem(N,s),!r.growingIO.useEmbeddedInherit&&"none"!==r.qsFrom&&s.gioprojectid===a&&s.gioappid===c){r.growingIO.useEmbeddedInherit=e,r.growingIO.dataStore.updateVdsConfig(e,{minipLink:!0}),s.giocircleroomid?r.circleInit(s.giocircleroomid,t):r.storage.removeItem(D);var u=r.growingIO.dataStore.getTrackerVds(e);A.forEach((function(e){if(w(s,e))if("giodatacollect"===e)u.dataCollect=h(["true",!0],s.giodatacollect);else{var r=k[e];h(["domain","platform"],r)&&(u.originValues||(u.originValues={}),u.originValues[r]=u[r]),u[r]=s[e]}})),r.growingIO.dataStore.updateVdsConfig(e,u);var g=r.growingIO,d=g.userStore,p=g.dataStore.eventContextBuilderInst;d.setUid(s.giou),d.setSessionId(e,s.gios),d.setUserId(e,null!==(o=s.giocs1)&&void 0!==o?o:""),d.setUserKey(e,null!==(n=s.giouserkey)&&void 0!==n?n:"");var m=window.setInterval((function(){d.setSessionId(e,s.gios)}),.8*t.sessionExpires*60*1e3);window.onbeforeunload=function(){window.clearInterval(m),m=void 0},F.forEach((function(e){w(s,e)&&(p.minpExtraParams[k[e]]=s[e])}));var v=r.growingIO.setUserId;r.growingIO.setUserId=function(){for(var r=[],t=0;arguments.length>t;t++)r[t]=arguments[t];if(r[0]!==e)return v.apply(this,r)};var I=r.growingIO.clearUserId;if(r.growingIO.clearUserId=function(){for(var r=[],t=0;arguments.length>t;t++)r[t]=arguments[t];if(r[0]!==e)return I.apply(this,r)},w(s,"giodatacollect")){var O=r.growingIO.setOption;r.growingIO.setOption=function(){for(var r=[],t=0;arguments.length>t;t++)r[t]=arguments[t];if(r[0]!==e)return O.apply(this,r)}}}!1!==r.growingIO.dataStore.getTrackerVds(r.growingIO.trackingId).rewriteQuery&&r.gioURLRewrite(),r.growingIO.dataStore.currentPage.parsePage()},this.getGQS=function(e){var t=window.location.search,o=window.location.hash,i=e?o.substring(o.indexOf("?")+1):"",a=r.storage.getItem(N),c=E(t),l=E(i),s={};if(w(c,"gioprojectid"))s=c,r.qsFrom="search";else if(w(l,"gioprojectid"))s=l,r.qsFrom="hash";else{if(!w(a,"gioprojectid"))return r.qsFrom="none",{};s=a,r.qsFrom="local"}var u={},g={};return y(s).forEach((function(e){var r=e.toLowerCase();if(h(x,r)){var t=decodeURIComponent(s[e]);h(["","undefined","null",void 0,null],t)?u[r]="":u[r]=!!h(["true","TRUE",!0],t)||!h(["false","FALSE",!1],t)&&t}else g[e]=s[e]})),r.gqs=u,r.customerQs=g,n(n({},r.gqs),r.customerQs)},this.gioURLRewrite=function(){var e=r.growingIO.vdsConfig.hashtag,t=window.location.search,o=window.location.hash,n=!1;if("search"===r.qsFrom&&(t=_(r.customerQs),n=!0),e&&"hash"===r.qsFrom&&(o="".concat(o.split("?")[0]).concat(_(r.customerQs)),n=!0),n){var i="".concat(window.location.pathname).concat(t||"").concat(o||"");window.history.replaceState(null,document.title,i)}},this.circleInit=function(e,t){var o,n;console.log("%c [GrowingIO]：您已进入小程序圈选模式","color: #3B82F6;"),r.circleRoomId=e,r.circleOpen=!0;var i=r.growingIO.useEmbeddedInherit;r.circleServerUrl={};var a=(null===(o=null==t?void 0:t.embeddedAdapter)||void 0===o?void 0:o.circleServerUrl)||(null===(n=r.options)||void 0===n?void 0:n.circleServerUrl);a?d(a)?r.generateUrl(i,a):f(a)&&y(a).forEach((function(e){r.generateUrl(e,a[e])})):r.generateUrl(i,"portal.growingio.com"),r.growingIO.emitter.on(R,r.collectorSendFn)},this.generateUrl=function(e,t){m(t,"http")?r.circleServerUrl[e]="".concat(t,"/api/public/circle-room/collect?roomId=").concat(r.circleRoomId):r.circleServerUrl[e]="https://".concat(t,"/api/public/circle-room/collect?roomId=").concat(r.circleRoomId)},this.collectorSendFn=function(e){var t=e.requestData,o=e.trackingId,i=n({},t);r.circleOpen&&"CUSTOM"!==i.eventType&&o===r.growingIO.useEmbeddedInherit&&(O(i,["requestType","trackingId","requestId"]),r.circleRequest(o,i))},this.circleRequest=function(e,t){var o,n,i=new XMLHttpRequest;i.open("POST",r.circleServerUrl[e],!0),i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.onload=i.ontimeout=i.onerror=i.onabort=function(e){var t=e.target,o=t.status,n=b((function(){return JSON.parse(t.responseText)}));h([200,204],o)&&(null==n?void 0:n.success)||(r.circleClose(),r.storage.getItem(D)!==r.circleRoomId&&(r.storage.setItem(D,r.circleRoomId),alert("H5："+((null==n?void 0:n.message)||n||t.responseText||"圈选请求失败，请重试!"))))},i.timeout=null!==(n=null===(o=r.options)||void 0===o?void 0:o.requestTimeout)&&void 0!==n?n:5e3,i.send(JSON.stringify([t]))},this.circleClose=function(){r.circleOpen=!1,r.circleServerUrl={},r.growingIO.emitter.off(R,r.collectorSendFn);var e=r.storage.getItem(N);O(e,["giocircleserverurl","giocircleroomid"]),r.storage.setItem(N,e)},this.storage=new j,this.growingIO.emitter.on("OPTION_INITIALIZED",(function(e){var t=e.trackingId,o=e.vdsConfig;r.onOptionsInit(t,o)}))}};export{Q as default};
