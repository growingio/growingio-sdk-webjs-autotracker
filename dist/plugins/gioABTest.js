var e,t,r=function(){return r=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var o in t=arguments[r])({}).hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)};function n(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;i>o;o++)!n&&o in t||(n||(n=[].slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||[].slice.call(t))}var o,i,a,u="function"==typeof Array.from?Array.from:(t||(t=1,o=function(e){return"function"==typeof e},i=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),9007199254740991)},a=function(e){var t=e.next();return!t.done&&t},e=function(e){var t,r,n,u=this,c=arguments.length>1?arguments[1]:void 0;if(void 0!==c){if(!o(c))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(t=arguments[2])}var s=function(e,t){if(null!=e&&null!=t){var r=e[t];if(null==r)return;if(!o(r))throw new TypeError(r+" is not a function");return r}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==s){r=o(u)?Object(new u):[];var l,g,d=s.call(e);if(null==d)throw new TypeError("Array.from requires an array-like or iterable object");for(n=0;;){if(!(l=a(d)))return r.length=n,r;g=l.value,r[n]=c?c.call(t,g,n):g,n++}}else{var f=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var v,m=i(f.length);for(r=o(u)?Object(new u(m)):Array(m),n=0;m>n;)v=f[n],r[n]=c?c.call(t,v,n):v,n++;r.length=m}return r}),e),c=function(e){return m(["undefined","null"],x(e))},s=function(e){return"string"===x(e)},l=function(e){return"number"===x(e)},g=function(e){return"NaN"===p(Number(e))},d=function(e){return"object"===x(e)&&!c(e)},f=function(e){return Array.isArray(e)&&"array"===x(e)},v=function(e){return"date"===x(e)},m=function(e,t){return("array"===x(e)||"string"===x(e))&&("array"===x(t)?t.some((function(t){return e.indexOf(t)>=0})):e.indexOf(t)>=0)},h=u,p=function(e){return c(e)?"":"".concat(e)},I=function(e,t){return!!s(e)&&e.slice(0,t.length)===t},y=function(e,t){if(s(e)){var r=e.length,n=r;n>r&&(n=r);var o=n;return(n-=t.length)>=0&&e.slice(n,o)===t}return!1},w={}.hasOwnProperty,S=function(e){return d(e)?Object.keys(e):[]},b=function(e,t){if(!d(e))return!1;try{return"string"===x(t)?delete e[t]:"array"===x(t)?t.map((function(t){return delete e[t]})):(function(e){return"regexp"===x(e)}(t)&&S(e).forEach((function(r){t.test(r)&&b(e,r)})),!0)}catch(e){return!1}},_=function(e){return f(e)?0===e.length:d(e)?0===S(e).length:!e},x=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},N=function(e,t){console.log("%c [GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444;",warn:"color: #F59E0B;",success:"color: #10B981;"}[t]||"")},O=function(e){try{return e()}catch(e){return}},C=function(e,t){if(m(["function","asyncfunction"],x(e)))try{e(t)}catch(e){N("回调执行失败！".concat(e),"error")}},T=function(e,t){void 0===t&&(t=!1);var r=0;if(_(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r&=r,n++;return t?Math.abs(r):r},D=function(e){return y(e,"_gioenc")?e.slice(0,-7):e},A=function(e){return isNaN(Number(e))&&O((function(){return JSON.parse(e)}))||e},k=function(e){var t={};return d(e)&&(b(e,"&&sendTo"),function(e,r){S(e).forEach((function(r){return function(e,r){var n=p(r).slice(0,100);d(e)?t[n]=k(e):f(e)?(t[n]=function(e,t){if(void 0===t&&(t=!1),f(e)){for(var r=0,n=[],o=0,i=e;o<i.length;o++){var a=i[o];a&&!_(a)&&(n[r++]=a),t&&0===a&&(n[r++]=a)}return n}return e}(e.slice(0,100),!0),t[n]=t[n].join("||").slice(0,1e3)):v(e)?t[n]=function(e){if(v(e)){var t=function(e){return 10>e?"0"+e:e};return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}return e}(e):t[n]=c(e)?"":p(e).slice(0,1e3)}(e[r],r)}))}(e)),t},j=/^(\.ac\.|\.br\.|\.co\.|\.com\.|\.edu\.|\.gov\.|\.org\.|\.net\.)/;function E(e){for(var t=1;arguments.length>t;t++){var r=arguments[t];for(var n in r)e[n]=r[n]}return e}var U,q=function e(t,r){function n(e,n,o){if("undefined"!=typeof document){"number"==typeof(o=E({},r,o)).expires&&(o.expires=new Date(Date.now()+864e5*o.expires)),o.expires&&(o.expires=o.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var i="";for(var a in o)o[a]&&(i+="; "+a,!0!==o[a]&&(i+="="+o[a].split(";")[0]));return document.cookie=e+"="+t.write(n,e)+i}}return Object.create({set:n,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var r=document.cookie?document.cookie.split("; "):[],n={},o=0;o<r.length;o++){var i=r[o].split("="),a=i.slice(1).join("=");try{var u=decodeURIComponent(i[0]);if(n[u]=t.read(a,u),e===u)break}catch(e){}}return e?n[e]:n}},remove:function(e,t){n(e,"",E({},t,{expires:-1}))},withAttributes:function(t){return e(this.converter,E({},this.attributes,t))},withConverter:function(t){return e(E({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(r)},converter:{value:Object.freeze(t)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"}),B={A:1,a:1,Z:1,z:1,"@":1,"{":1},M=function(e){return c(e)?e:O((function(){return"gioenc-".concat(R(e))}))||e},V=function(e){return s(e)&&I(e,"gioenc-")&&O((function(){return R(e.replace("gioenc-",""))}))||e},R=function(e){return(e=e||"").split("").map((function(e){return B[e]?e:H(e)})).join("")},H=function(e){if(/[0-9]/.test(e))return 1^+e;var t=e.charCodeAt(0);return String.fromCharCode(1^t)},K=function(e){var t=this;this.domain=e,this.getItem=function(e){return A(V(q.get(D(e),{domain:t.domain,path:"/"})))},this.setItem=function(e,r,n){var o;o=s(r)?r.length?y(e,"_gioenc")?M(r):r:"":JSON.stringify(r),q.set(D(e),o,{expires:new Date(n||new Date((new Date).toDateString()).getTime()+3456e7),domain:t.domain,path:"/"})},this.removeItem=function(e){q.remove(D(e),{domain:t.domain,path:"/"})},this.hasItem=function(e){return m(S(q.get()),D(e))},this.getKeys=function(){return S(q.get())},this.type="Cookie"},F=function(){this.getItem=function(e){var t=O((function(){return JSON.parse(localStorage.getItem(D(e))||"")}))||{};return d(t)&&t.expiredAt>+Date.now()?A(V(t.value)):void 0},this.setItem=function(e,t,r){var n=null!=r?r:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();localStorage.setItem(D(e),JSON.stringify({value:s(t)&&t.length&&y(e,"_gioenc")?M(t):t,expiredAt:n}))},this.removeItem=function(e){return localStorage.removeItem(D(e))},this.hasItem=function(e){return!!localStorage.getItem(D(e))},this.getKeys=function(){return h(Array(localStorage.length)).map((function(e,t){return localStorage.key(t)}))},this.type="localStorage"},J={},$=function(){this.getItem=function(e){var t=O((function(){return JSON.parse(J[D(e)]||"")}));return d(t)&&t.expiredAt>+Date.now()?A(V(t.value)):void 0},this.setItem=function(e,t,r){var n=null!=r?r:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();J[D(e)]=JSON.stringify({value:s(t)&&t.length?M(t):t,expiredAt:n})},this.removeItem=function(e){return b(J,D(e))},this.hasItem=function(e){return function(e,t){return!c(e)&&w.call(e,t)}(J,D(e))},this.getKeys=function(){return S(J)},this.type="memory"},P=function(e){var t=[];try{var r=e.split("."),n=function(e){try{var t=h(e);return t[t.length-1]}catch(e){return}}(r);if(r.length>=2&&(isNaN(Number(n))||0>Number(n)||Number(n)>255)){var o=".".concat(r.slice(-2).join("."));j.test(o)?U=o:t.push(o);var i=".".concat(r.slice(-3).join("."));j.test(i)||m(t,i)||t.push(i);var a=".".concat(r.slice(-4).join("."));j.test(a)||m(t,a)||t.push(a)}}catch(e){N(e,"error")}return t},L=function(e){var t="";return e.some((function(e){return!!Y(e)&&(t=e,!0)})),t},Y=function(e){try{q.set("gioCookie","yes",{domain:e});var t=!!q.get("gioCookie",{domain:e});return q.remove("gioCookie",{domain:e}),t}catch(e){return!1}},z=function(e){var t,r,o,i=e.storageType,a=e.cookieDomain,u=e.projectId;if(m(["cookie","localstorage"],i)||(i="cookie"),"cookie"===i&&(r=!!(o=navigator.userAgent.indexOf("Electron")>-1||m(["","localhost","127.0.0.1"],window.location.hostname)||!m(["http:","https:"],window.location.protocol)?"":L(n(n([],P(window.location.hostname),!0),[window.location.hostname],!1)))),"cookie"===i&&r){var c=new K(o);if(a){var s=P(a),l=L(_(s)?[]:n([a],P(a),!0));l&&Y(l)?c.domain=l:N("指定Cookie域无效或无权限，使用默认域！","warn")}t=c}else t=function(){try{var e=window.localStorage,t="__storage_test__";return e.setItem(t,t),e.removeItem(t),!0}catch(e){return!1}}()?new F:new $;return"cookie"===i&&U&&Y(U)&&function(e,t,r){if(t&&Y(t)){var n=new K(t);["".concat(r,"_gdp_session_id"),"gdp_user_id_gioenc","".concat(r,"_gdp_cs1_gioenc"),"".concat(r,"_gdp_user_key_gioenc"),"".concat(r,"_gdp_gio_id_gioenc"),"".concat(r,"_gdp_sequence_ids"),"".concat(r,"_gdp_session_id_sent")].forEach((function(t){var r=n.getItem(t);n.hasItem(t)&&(e.setItem(t,r),n.removeItem(t))})),n=void 0}}(t,U,u),t},G={},X={}.hasOwnProperty;function Z(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function W(e){try{return encodeURIComponent(e)}catch(e){return null}}G.stringify=function(e,t){t=t||"";var r,n,o=[];for(n in"string"!=typeof t&&(t="?"),e)if(X.call(e,n)){if((r=e[n])||null!=r&&!isNaN(r)||(r=""),n=W(n),r=W(r),null===n||null===r)continue;o.push(n+"="+r)}return o.length?t+o.join("&"):""},G.parse=function(e){for(var t,r=/([^=?#&]+)=?([^&]*)/g,n={};t=r.exec(e);){var o=Z(t[1]),i=Z(t[2]);null===o||null===i||o in n||(n[o]=i)}return n};var Q=/^\d+_gdp_abt_sign$/,ee=/^\d+_gdp_abtd$/,te={name:"gioABTest",method:function(e){var t=this;this.growingIO=e,this.getStorageSession=function(e){var r=t.growingIO,n=r.storage,o=r.dataStore;return n.getItem(o.getStorageKey(e,"sessionId"))},this.getVisitSids=function(e){var r=t.growingIO.dataStore;return localStorage.getItem(r.getStorageKey(e,"abts"))},this.setVisitSids=function(e,r){var n=t.growingIO.dataStore;localStorage.setItem(n.getStorageKey(e,"abts"),r)},this.removeVisitSids=function(e){var r=t.growingIO.dataStore;localStorage.removeItem(r.getStorageKey(e,"abts"))},this.timeoutCheck=function(e,r){t.requestInterval=l(Number(e))&&!g(Number(e))?Number(e):5,(t.requestInterval>1440||0>t.requestInterval)&&(t.requestInterval=5),t.requestTimeout=l(Number(r))&&!g(Number(r))?Number(r):1e3,(t.requestTimeout>5e3||100>t.requestTimeout)&&(t.requestTimeout=1e3)},this.getMainConfigs=function(){var e,r,n,o,i,a,u,c,s,l,g,d,f=t.growingIO,v=f.plugins,m=f.vdsConfig,h=f.useHybridInherit,p=f.useEmbeddedInherit,I=f.dataStore;if(h){var y=null!==(r=null===(e=null==v?void 0:v.gioHybridAdapter)||void 0===e?void 0:e.hybridConfig)&&void 0!==r?r:null===(n=null===window||void 0===window?void 0:window.GrowingWebViewJavascriptBridge)||void 0===n?void 0:n.configuration;d=null!==(i=null!==(o=null==y?void 0:y.dataSourceId)&&void 0!==o?o:null==y?void 0:y.datasourceId)&&void 0!==i?i:m.dataSourceId,g=null!==(a=null==y?void 0:y.projectId)&&void 0!==a?a:m.projectId}else p?(d=null!==(c=null===(u=I.eventContextBuilderInst.minpExtraParams)||void 0===u?void 0:u.dataSourceId)&&void 0!==c?c:m.dataSourceId,g=null!==(l=null===(s=I.eventContextBuilderInst.minpExtraParams)||void 0===s?void 0:s.projectId)&&void 0!==l?l:m.projectId):(d=m.dataSourceId,g=m.projectId);return{projectId:g,dataSourceId:d}},this.abtStorageCheck=function(){var e=t.abtStorage.getKeys();e.filter((function(e){return Q.test(e)})).forEach((function(e){var r=t.abtStorage.getItem(e);r&&r>=Date.now()||t.abtStorage.removeItem(e)})),e.filter((function(e){return ee.test(e)})).forEach((function(e){_(t.abtStorage.getItem(e))&&t.abtStorage.removeItem(e)}))},this.getHashKey=function(e,r){var n=t.growingIO.userStore.getUid,o=t.growingIO.dataStore.getTrackerVds(e).projectId;return T("".concat(e,"#").concat(o,"#").concat(n(),"#").concat(r),!0)},this.generateUrl=function(e,r){t.newDevice&&!t.getVisitSids(e)&&t.setVisitSids(e,t.growingIO.userStore.getSessionId(e)),I(r,"http")?t.url[e]="".concat(r,"/diversion/specified-layer-variables"):t.url[e]="https://".concat(r,"/diversion/specified-layer-variables")},this.getABTest=function(e,r,n){if(_(t.url[e])&&t.generateUrl(e,"https://ab.growingio.com"),!r)return N("获取ABTest数据失败! 实验层Id不合法!","error"),void C(n,{});var o=t.abtStorage.getItem("".concat(t.getHashKey(e,r),"_gdp_abt_sign"))||0,i=t.abtStorage.getItem("".concat(t.getHashKey(e,r),"_gdp_abtd"))||{};!o||o<Date.now()?t.initiateRequest(e,r,i,n):C(n,i)},this.initiateRequest=function(e,n,o,i){var a=t.growingIO,u=a.userStore,c=u.getUid,s=u.getSessionId,l=a.dataStore,g=e===t.growingIO.trackingId?t.getMainConfigs():l.getTrackerVds(e),d=g.projectId,f=g.dataSourceId,v=new XMLHttpRequest;if(v){v.open("POST",t.url[e],!0),v.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),v.timeout=t.requestTimeout,v.onload=function(a){var u,c=null!==(u=O((function(){return JSON.parse(a.target.responseText)})))&&void 0!==u?u:{};0===c.code?t.experimentVerify(e,r(r({},c),{layerId:n}),o,i):(N("获取ABTest数据失败! ".concat(c.errorMsg,"!"),"error"),C(i,{})),t.abtStorage.setItem("".concat(t.getHashKey(e,n),"_gdp_abt_sign"),Date.now()+6e4*t.requestInterval)},v.ontimeout=function(){N("获取ABTest数据失败! 请求超时!","error"),C(i,{})},v.onerror=function(){200!==v.status&&(2>t.retryCount?(t.initiateRequest(e,n,o,i),t.retryCount+=1):(N("获取ABTest数据失败! ".concat(v.statusText,"!"),"error"),C(i,{})))};var m={accountId:d,datasourceId:f,distinctId:c(),layerId:n};return t.getVisitSids(e)===s(e)?m.newDevice=!0:(m.newDevice=!1,t.removeVisitSids(e)),void v.send(G.stringify(m))}N("获取ABTest数据失败! 当前环境不支持XMLHttpRequest!","error")},this.experimentVerify=function(e,n,o,i){var a=n.layerId,u=n.strategyId,c=n.experimentId,s=n.layerName,l=n.experimentName,g=n.strategyName,d=n.variables,f="".concat(t.getHashKey(e,a),"_gdp_abtd"),v={layerId:p(a),strategyId:p(u),experimentId:p(c),variables:d},m=r({},o);b(m,["layerName","strategyName","experimentName"]);var h=T(JSON.stringify(v)),I=T(JSON.stringify(m)),y=r(r({},v),{layerName:s,strategyName:g,experimentName:l});t.abtStorage.setItem(f,y,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),h!==I&&u&&c&&t.buildExperimentHitEvent(e,y),C(i,y)},this.buildExperimentHitEvent=function(e,n){var o,i=t.growingIO.dataStore,a=i.eventContextBuilder,u=i.eventConverter,c=r({eventType:"CUSTOM",eventName:"$exp_hit"},a(e)),s=n.layerId,l=n.experimentId,g=n.strategyId,d=n.layerName,f=n.experimentName,v=n.strategyName;c.attributes=k(r(r({},null!==(o=c.attributes)&&void 0!==o?o:{}),{$exp_layer_id:s,$exp_id:l,$exp_strategy_id:g,$exp_layer_name:d,$exp_name:f,$exp_strategy_name:v})),u(c)},this.pluginVersion="4.3.0",this.abtStorage=z({storageType:"localstorage"}),this.growingIO.getABTest=this.getABTest;var n=this.growingIO.emitter;n.on("OPTION_INITIALIZED",(function(){var e,r=null!==(e=t.options)&&void 0!==e?e:{},n=r.abServerUrl,o=void 0===n?"https://ab.growingio.com":n,i=r.requestInterval,a=r.requestTimeout;t.timeoutCheck(i,a),_(o)?N("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn"):(t.abtStorageCheck(),t.url={},s(o)?t.generateUrl(t.growingIO.trackingId,o):d(o)&&S(o).forEach((function(e){t.generateUrl(e,o[e])})))})),n.on("UID_UPDATE",(function(e){var r,n=e.newUId,o=e.oldUId,i=(null!==(r=t.options)&&void 0!==r?r:{}).abServerUrl,a=void 0===i?"https://ab.growingio.com":i;if(t.newDevice=!0,!o&&n)if(s(a)){var u=t.growingIO.trackingId;t.setVisitSids(u,t.getStorageSession(u))}else d(a)&&S(a).forEach((function(e){t.setVisitSids(e,t.getStorageSession(e))}))})),this.retryCount=0}};export{te as default};
