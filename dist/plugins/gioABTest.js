var e,t,n=function(){return n=Object.assign||function(e){for(var t,n=1,r=arguments.length;r>n;n++)for(var o in t=arguments[n])({}).hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},n.apply(this,arguments)};function r(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;i>o;o++)!r&&o in t||(r||(r=[].slice.call(t,0,o)),r[o]=t[o]);return e.concat(r||[].slice.call(t))}var o,i,a,u="function"==typeof Array.from?Array.from:(t||(t=1,o=function(e){return"function"==typeof e},i=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),9007199254740991)},a=function(e){var t=e.next();return!t.done&&t},e=function(e){var t,n,r,u=this,c=arguments.length>1?arguments[1]:void 0;if(void 0!==c){if(!o(c))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(t=arguments[2])}var s=function(e,t){if(null!=e&&null!=t){var n=e[t];if(null==n)return;if(!o(n))throw new TypeError(n+" is not a function");return n}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==s){n=o(u)?Object(new u):[];var l,f,g=s.call(e);if(null==g)throw new TypeError("Array.from requires an array-like or iterable object");for(r=0;;){if(!(l=a(g)))return n.length=r,n;f=l.value,n[r]=c?c.call(t,f,r):f,r++}}else{var d=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var v,h=i(d.length);for(n=o(u)?Object(new u(h)):Array(h),r=0;h>r;)v=d[r],n[r]=c?c.call(t,v,r):v,r++;n.length=h}return n}),e),c=function(e){return d(["undefined","null"],S(e))},s=function(e){return"string"===S(e)},l=function(e){return"number"===S(e)},f=function(e){return"NaN"===h(Number(e))},g=function(e){return"object"===S(e)&&!c(e)},d=function(e,t){return("array"===S(e)||"string"===S(e))&&e.indexOf(t)>=0},v=u,h=function(e){return c(e)?"":"".concat(e)},m=function(e,t){return!!s(e)&&e.slice(0,t.length)===t},p=function(e,t){if(s(e)){var n=e.length,r=n;r>n&&(r=n);var o=r;return(r-=t.length)>=0&&e.slice(r,o)===t}return!1},y={}.hasOwnProperty,I=function(e){return g(e)?Object.keys(e):[]},w=function(e,t){if(!g(e))return!1;try{return"string"===S(t)?delete e[t]:"array"===S(t)?t.map((function(t){return delete e[t]})):(function(e){return"regexp"===S(e)}(t)&&I(e).forEach((function(n){t.test(n)&&w(e,n)})),!0)}catch(e){return!1}},b=function(e){return function(e){return Array.isArray(e)&&"array"===S(e)}(e)?0===e.length:g(e)?0===I(e).length:!e},S=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},_=function(e,t){console.log("%c [GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444;",warn:"color: #F59E0B;",success:"color: #10B981;"}[t]||"")},C=function(e){try{return e()}catch(e){return}},x=function(e,t){if(d(["function","asyncfunction"],S(e)))try{e(t)}catch(e){_("回调执行失败！".concat(e),"error")}},O=function(e,t){void 0===t&&(t=!1);var n=0;if(b(e)||"boolean"==typeof e)return n;for(var r=0;r<e.length;)n=(n<<5)-n+e.charCodeAt(r),n&=n,r++;return t?Math.abs(n):n},T=function(e){return p(e,"_gioenc")?e.slice(0,-7):e},N=function(e){return isNaN(Number(e))&&C((function(){return JSON.parse(e)}))||e},A=/^(\.ac\.|\.br\.|\.co\.|\.com\.|\.edu\.|\.gov\.|\.org\.|\.net\.)/;function D(e){for(var t=1;arguments.length>t;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}var k,j=function e(t,n){function r(e,r,o){if("undefined"!=typeof document){"number"==typeof(o=D({},n,o)).expires&&(o.expires=new Date(Date.now()+864e5*o.expires)),o.expires&&(o.expires=o.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var i="";for(var a in o)o[a]&&(i+="; "+a,!0!==o[a]&&(i+="="+o[a].split(";")[0]));return document.cookie=e+"="+t.write(r,e)+i}}return Object.create({set:r,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var n=document.cookie?document.cookie.split("; "):[],r={},o=0;o<n.length;o++){var i=n[o].split("="),a=i.slice(1).join("=");try{var u=decodeURIComponent(i[0]);if(r[u]=t.read(a,u),e===u)break}catch(e){}}return e?r[e]:r}},remove:function(e,t){r(e,"",D({},t,{expires:-1}))},withAttributes:function(t){return e(this.converter,D({},this.attributes,t))},withConverter:function(t){return e(D({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(n)},converter:{value:Object.freeze(t)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"}),E={A:1,a:1,Z:1,z:1,"@":1,"{":1},q=function(e){return c(e)?e:C((function(){return"gioenc-".concat(U(e))}))||e},B=function(e){return s(e)&&m(e,"gioenc-")&&C((function(){return U(e.replace("gioenc-",""))}))||e},U=function(e){return(e=e||"").split("").map((function(e){return E[e]?e:M(e)})).join("")},M=function(e){if(/[0-9]/.test(e))return 1^+e;var t=e.charCodeAt(0);return String.fromCharCode(1^t)},R=function(e){var t=this;this.domain=e,this.getItem=function(e){return N(B(j.get(T(e),{domain:t.domain,path:"/"})))},this.setItem=function(e,n,r){var o;o=s(n)?n.length?p(e,"_gioenc")?q(n):n:"":JSON.stringify(n),j.set(T(e),o,{expires:new Date(r||new Date((new Date).toDateString()).getTime()+3456e7),domain:t.domain,path:"/"})},this.removeItem=function(e){j.remove(T(e),{domain:t.domain,path:"/"})},this.hasItem=function(e){return d(I(j.get()),T(e))},this.getKeys=function(){return I(j.get())},this.type="Cookie"},H=function(){this.getItem=function(e){var t=C((function(){return JSON.parse(localStorage.getItem(T(e))||"")}))||{};return g(t)&&t.expiredAt>+Date.now()?N(B(t.value)):void 0},this.setItem=function(e,t,n){var r=null!=n?n:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();localStorage.setItem(T(e),JSON.stringify({value:s(t)&&t.length&&p(e,"_gioenc")?q(t):t,expiredAt:r}))},this.removeItem=function(e){return localStorage.removeItem(T(e))},this.hasItem=function(e){return!!localStorage.getItem(T(e))},this.getKeys=function(){return v(Array(localStorage.length)).map((function(e,t){return localStorage.key(t)}))},this.type="localStorage"},F={},J=function(){this.getItem=function(e){var t=C((function(){return JSON.parse(F[T(e)]||"")}));return g(t)&&t.expiredAt>+Date.now()?N(B(t.value)):void 0},this.setItem=function(e,t,n){var r=null!=n?n:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();F[T(e)]=JSON.stringify({value:s(t)&&t.length?q(t):t,expiredAt:r})},this.removeItem=function(e){return w(F,T(e))},this.hasItem=function(e){return function(e,t){return!c(e)&&y.call(e,t)}(F,T(e))},this.getKeys=function(){return I(F)},this.type="memory"},K=function(e){var t=[];try{var n=e.split("."),r=function(e){try{var t=v(e);return t[t.length-1]}catch(e){return}}(n);if(n.length>=2&&(isNaN(Number(r))||0>Number(r)||Number(r)>255)){var o=".".concat(n.slice(-2).join("."));A.test(o)?k=o:t.push(o);var i=".".concat(n.slice(-3).join("."));A.test(i)||d(t,i)||t.push(i);var a=".".concat(n.slice(-4).join("."));A.test(a)||d(t,a)||t.push(a)}}catch(e){_(e,"error")}return t},P=function(e){var t="";return e.some((function(e){return!!$(e)&&(t=e,!0)})),t},$=function(e){try{j.set("gioCookie","yes",{domain:e});var t=!!j.get("gioCookie",{domain:e});return j.remove("gioCookie",{domain:e}),t}catch(e){return!1}},L=function(e){var t,n,o,i=e.storageType,a=e.cookieDomain,u=e.projectId;if(d(["cookie","localstorage"],i)||(i="cookie"),"cookie"===i&&(n=!!(o=navigator.userAgent.indexOf("Electron")>-1||d(["","localhost","127.0.0.1"],window.location.hostname)||!d(["http:","https:"],window.location.protocol)?"":P(r(r([],K(window.location.hostname),!0),[window.location.hostname],!1)))),"cookie"===i&&n){var c=new R(o);if(a){var s=K(a),l=P(b(s)?[]:r([a],K(a),!0));l&&$(l)?c.domain=l:_("指定Cookie域无效或无权限，使用默认域！","warn")}t=c}else t=function(){try{var e=window.localStorage,t="__storage_test__";return e.setItem(t,t),e.removeItem(t),!0}catch(e){return!1}}()?new H:new J;return"cookie"===i&&k&&$(k)&&function(e,t,n){if(t&&$(t)){var r=new R(t);["".concat(n,"_gdp_session_id"),"gdp_user_id_gioenc","".concat(n,"_gdp_cs1_gioenc"),"".concat(n,"_gdp_user_key_gioenc"),"".concat(n,"_gdp_gio_id_gioenc"),"".concat(n,"_gdp_sequence_ids"),"".concat(n,"_gdp_session_id_sent")].forEach((function(t){var n=r.getItem(t);r.hasItem(t)&&(e.setItem(t,n),r.removeItem(t))})),r=void 0}}(t,k,u),t},z={},V={}.hasOwnProperty;function Y(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(e){return null}}function G(e){try{return encodeURIComponent(e)}catch(e){return null}}z.stringify=function(e,t){t=t||"";var n,r,o=[];for(r in"string"!=typeof t&&(t="?"),e)if(V.call(e,r)){if((n=e[r])||null!=n&&!isNaN(n)||(n=""),r=G(r),n=G(n),null===r||null===n)continue;o.push(r+"="+n)}return o.length?t+o.join("&"):""},z.parse=function(e){for(var t,n=/([^=?#&]+)=?([^&]*)/g,r={};t=n.exec(e);){var o=Y(t[1]),i=Y(t[2]);null===o||null===i||o in r||(r[o]=i)}return r};var X=/^\d+_gdp_abt_sign$/,Z=/^\d+_gdp_abtd$/,W={name:"gioABTest",method:function(e,t){var r=this;this.growingIO=e,this.options=t,this.timeoutCheck=function(e,t){r.requestInterval=l(Number(e))&&!f(Number(e))?Number(e):5,(r.requestInterval>1440||0>r.requestInterval)&&(r.requestInterval=5),r.requestTimeout=l(Number(t))&&!f(Number(t))?Number(t):1e3,(r.requestTimeout>5e3||100>r.requestTimeout)&&(r.requestTimeout=1e3)},this.getMainConfigs=function(){var e,t,n,o,i,a,u,c,s,l,f,g,d=r.growingIO,v=d.plugins,h=d.vdsConfig,m=d.useHybridInherit,p=d.useEmbeddedInherit,y=d.dataStore;if(m){var I=null!==(t=null===(e=null==v?void 0:v.gioHybridAdapter)||void 0===e?void 0:e.hybridConfig)&&void 0!==t?t:null===(n=null===window||void 0===window?void 0:window.GrowingWebViewJavascriptBridge)||void 0===n?void 0:n.configuration;g=null!==(i=null!==(o=null==I?void 0:I.dataSourceId)&&void 0!==o?o:null==I?void 0:I.datasourceId)&&void 0!==i?i:h.dataSourceId,f=null!==(a=null==I?void 0:I.projectId)&&void 0!==a?a:h.projectId}else p?(g=null!==(c=null===(u=y.eventContextBuilderInst.minpExtraParams)||void 0===u?void 0:u.dataSourceId)&&void 0!==c?c:h.dataSourceId,f=null!==(l=null===(s=y.eventContextBuilderInst.minpExtraParams)||void 0===s?void 0:s.projectId)&&void 0!==l?l:h.projectId):(g=h.dataSourceId,f=h.projectId);return{projectId:f,dataSourceId:g}},this.abtStorageCheck=function(){var e=r.abtStorage.getKeys();e.filter((function(e){return X.test(e)})).forEach((function(e){var t=r.abtStorage.getItem(e);t&&t>=Date.now()||r.abtStorage.removeItem(e)})),e.filter((function(e){return Z.test(e)})).forEach((function(e){b(r.abtStorage.getItem(e))&&r.abtStorage.removeItem(e)}))},this.getHashKey=function(e,t){var n=r.growingIO,o=n.userStore.getUid,i=n.vdsConfig.projectId;return O("".concat(e,"#").concat(i,"#").concat(o(),"#").concat(t),!0)},this.generateUrl=function(e,t){m(t,"http")?r.url[e]="".concat(t,"/diversion/specified-layer-variables"):r.url[e]="https://".concat(t,"/diversion/specified-layer-variables")},this.getABTest=function(e,t,n){if(b(r.url[e])&&r.generateUrl(e,"https://ab.growingio.com"),!t)return _("获取ABTest数据失败! 实验层Id不合法!","error"),void x(n,{});var o=r.abtStorage.getItem("".concat(r.getHashKey(e,t),"_gdp_abt_sign"))||0,i=r.abtStorage.getItem("".concat(r.getHashKey(e,t),"_gdp_abtd"))||{};!o||o<Date.now()?r.initiateRequest(e,t,i,n):x(n,i)},this.initiateRequest=function(e,t,o,i){var a=r.growingIO,u=a.userStore.getUid,c=a.dataStore,s=e===r.growingIO.trackingId?r.getMainConfigs():c.getTracker(e).vdsConfig,l=s.projectId,f=s.dataSourceId,g=new XMLHttpRequest;if(g)return g.open("POST",r.url[e],!0),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.timeout=r.requestTimeout,g.onload=function(a){var u,c=null!==(u=C((function(){return JSON.parse(a.target.responseText)})))&&void 0!==u?u:{};0===c.code?r.experimentVerify(e,n(n({},c),{layerId:t}),o,i):(_("获取ABTest数据失败! ".concat(c.errorMsg,"!"),"error"),x(i,{})),r.abtStorage.setItem("".concat(r.getHashKey(e,t),"_gdp_abt_sign"),Date.now()+6e4*r.requestInterval)},g.ontimeout=function(){_("获取ABTest数据失败! 请求超时!","error"),x(i,{})},g.onerror=function(){200!==g.status&&(2>r.retryCount?(r.initiateRequest(e,t,o,i),r.retryCount+=1):(_("获取ABTest数据失败! ".concat(g.statusText,"!"),"error"),x(i,{})))},void g.send(z.stringify({accountId:l,datasourceId:f,distinctId:u(),layerId:t}));_("获取ABTest数据失败! 当前环境不支持XMLHttpRequest!","error")},this.experimentVerify=function(e,t,n,o){var i=t.layerId,a=t.strategyId,u=t.experimentId,c=t.variables,s="".concat(r.getHashKey(e,i),"_gdp_abtd"),l={layerId:h(i),strategyId:h(a),experimentId:h(u),variables:c};O(JSON.stringify(l))!==O(JSON.stringify(n))&&(r.abtStorage.setItem(s,l,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),a&&u&&r.buildExperimentHitEvent(e,h(i),h(u),h(a))),x(o,l)},this.buildExperimentHitEvent=function(e,t,o,i){var a=r.growingIO.dataStore,u=a.eventContextBuilder;(0,a.eventConverter)(n(n({eventType:"CUSTOM",eventName:"$exp_hit",attributes:{$exp_layer_id:t,$exp_id:o,$exp_strategy_id:i}},u(e)),{customEventType:0}))};var o=null!=t?t:{},i=o.abServerUrl,a=void 0===i?"https://ab.growingio.com":i,u=o.requestInterval,c=o.requestTimeout,d=this.growingIO.emitter;this.timeoutCheck(u,c),this.abtStorage=L({storageType:"localstorage"}),this.growingIO.getABTest=this.getABTest,d.on("OPTION_INITIALIZED",(function(){b(a)?_("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn"):(r.abtStorageCheck(),r.url={},s(a)?r.generateUrl(r.growingIO.trackingId,a):g(a)&&I(a).forEach((function(e){r.generateUrl(e,a[e])})))})),this.retryCount=0}};export{W as default};
