var e,t,r,n,o=function(){return o=Object.assign||function(e){for(var t,r=1,n=arguments.length;n>r;r++)for(var o in t=arguments[r])({}).hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},o.apply(this,arguments)};function i(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;i>o;o++)!n&&o in t||(n||(n=[].slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||[].slice.call(t))}function a(e){return e&&e.__esModule&&{}.hasOwnProperty.call(e,"default")?e.default:e}var u,c,s,l=n?r:(n=1,r="function"==typeof Array.from?Array.from:(t||(t=1,u=function(e){return"function"==typeof e},c=function(e){var t=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t}(e);return Math.min(Math.max(t,0),9007199254740991)},s=function(e){var t=e.next();return!t.done&&t},e=function(e){var t,r,n,o=this,i=arguments.length>1?arguments[1]:void 0;if(void 0!==i){if(!u(i))throw new TypeError("Array.from: when provided, the second argument must be a function");arguments.length>2&&(t=arguments[2])}var a=function(e,t){if(null!=e&&null!=t){var r=e[t];if(null==r)return;if(!u(r))throw new TypeError(r+" is not a function");return r}}(e,function(e){if(null!=e){if(["string","number","boolean","symbol"].indexOf(typeof e)>-1)return Symbol.iterator;if("undefined"!=typeof Symbol&&"iterator"in Symbol&&Symbol.iterator in e)return Symbol.iterator;if("@@iterator"in e)return"@@iterator"}}(e));if(void 0!==a){r=u(o)?Object(new o):[];var l,g,d=a.call(e);if(null==d)throw new TypeError("Array.from requires an array-like or iterable object");for(n=0;;){if(!(l=s(d)))return r.length=n,r;g=l.value,r[n]=i?i.call(t,g,n):g,n++}}else{var f=Object(e);if(null==e)throw new TypeError("Array.from requires an array-like object - not null or undefined");var v,m=c(f.length);for(r=u(o)?Object(new o(m)):Array(m),n=0;m>n;)v=f[n],r[n]=i?i.call(t,v,n):v,n++;r.length=m}return r}),e)),g=function(e){return I(["undefined","null"],D(e))},d=function(e){return"string"===D(e)},f=function(e){return"number"===D(e)},v=function(e){return"NaN"===w(Number(e))},m=function(e){return"object"===D(e)&&!g(e)},h=function(e){return Array.isArray(e)&&"array"===D(e)},p=function(e){return"date"===D(e)},I=function(e,t){return("array"===D(e)||"string"===D(e))&&("array"===D(t)?t.some((function(t){return e.indexOf(t)>=0})):e.indexOf(t)>=0)},y=a(l),w=function(e){return g(e)?"":"".concat(e)},S=function(e,t){return!!d(e)&&e.slice(0,t.length)===t},b=function(e,t){if(d(e)){var r=e.length,n=r;n>r&&(n=r);var o=n;return(n-=t.length)>=0&&e.slice(n,o)===t}return!1},_={}.hasOwnProperty,O=function(e,t){return!g(e)&&_.call(e,t)},x=function(e){return m(e)?Object.keys(e):[]},N=function(e,t){if(!m(e))return!1;try{return"string"===D(t)?delete e[t]:"array"===D(t)?t.map((function(t){return delete e[t]})):(function(e){return"regexp"===D(e)}(t)&&x(e).forEach((function(r){t.test(r)&&N(e,r)})),!0)}catch(e){return!1}},C=function(e){return h(e)?0===e.length:m(e)?0===x(e).length:!e},D=function(e){return{}.toString.call(e).slice(8,-1).toLowerCase()},T=function(e,t){console.log("%c [GrowingIO]：".concat(e),{info:"color: #3B82F6;",error:"color: #EF4444;",warn:"color: #F59E0B;",success:"color: #10B981;"}[t]||"")},A=function(e){for(var t=[],r=1;arguments.length>r;r++)t[r-1]=arguments[r];try{return e.apply(void 0,t)}catch(e){return}},k=function(e){for(var t=[],r=1;arguments.length>r;r++)t[r-1]=arguments[r];if(I(["function","asyncfunction"],D(e)))try{e.apply(void 0,t)}catch(e){T("回调执行失败！".concat(e),"error")}},E=function(e,t){void 0===t&&(t=!1);var r=0;if(C(e)||"boolean"==typeof e)return r;for(var n=0;n<e.length;)r=(r<<5)-r+e.charCodeAt(n),r&=r,n++;return t?Math.abs(r):r},j=function(e){return b(e,"_gioenc")?e.slice(0,-7):e},U=function(e){return isNaN(Number(e))&&A((function(){return JSON.parse(e)}))||e},q=function(e){var t={};return m(e)&&(N(e,"&&sendTo"),function(e,r){x(e).forEach((function(r){return function(e,r){var n=w(r).slice(0,100);m(e)?t[n]=q(e):h(e)?(t[n]=function(e,t){if(h(e)){for(var r=0,n=[],o=0,i=e;o<i.length;o++){var a=i[o];a&&!C(a)&&(n[r++]=a),0===a&&(n[r++]=a)}return n}return e}(e.slice(0,100)),t[n]=t[n].join("||").slice(0,1e3)):p(e)?t[n]=function(e){if(p(e)){var t=function(e){return 10>e?"0"+e:e};return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}return e}(e):t[n]=g(e)?"":w(e).slice(0,1e3)}(e[r],r)}))}(e)),t},B=/^(\.ac\.|\.br\.|\.co\.|\.com\.|\.edu\.|\.gov\.|\.org\.|\.net\.)/;function M(e){for(var t=1;arguments.length>t;t++){var r=arguments[t];for(var n in r)e[n]=r[n]}return e}var R,V=function e(t,r){function n(e,n,o){if("undefined"!=typeof document){"number"==typeof(o=M({},r,o)).expires&&(o.expires=new Date(Date.now()+864e5*o.expires)),o.expires&&(o.expires=o.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var i="";for(var a in o)o[a]&&(i+="; "+a,!0!==o[a]&&(i+="="+o[a].split(";")[0]));return document.cookie=e+"="+t.write(n,e)+i}}return Object.create({set:n,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var r=document.cookie?document.cookie.split("; "):[],n={},o=0;o<r.length;o++){var i=r[o].split("="),a=i.slice(1).join("=");try{var u=decodeURIComponent(i[0]);if(n[u]=t.read(a,u),e===u)break}catch(e){}}return e?n[e]:n}},remove:function(e,t){n(e,"",M({},t,{expires:-1}))},withAttributes:function(t){return e(this.converter,M({},this.attributes,t))},withConverter:function(t){return e(M({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(r)},converter:{value:Object.freeze(t)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"}),H={A:1,a:1,Z:1,z:1,"@":1,"{":1},K=function(e){return g(e)?e:A((function(){return"gioenc-".concat(J(e))}))||e},F=function(e){return d(e)&&S(e,"gioenc-")&&A((function(){return J(e.replace("gioenc-",""))}))||e},J=function(e){return(e=e||"").split("").map((function(e){return H[e]?e:$(e)})).join("")},$=function(e){if(/[0-9]/.test(e))return 1^+e;var t=e.charCodeAt(0);return String.fromCharCode(1^t)},P=function(e){var t=this;this.domain=e,this.getItem=function(e){return U(F(V.get(j(e),{domain:t.domain,path:"/"})))},this.setItem=function(e,r,n){var o;o=d(r)?r.length?b(e,"_gioenc")?K(r):r:"":JSON.stringify(r),V.set(j(e),o,{expires:new Date(n||new Date((new Date).toDateString()).getTime()+3456e7),domain:t.domain,path:"/"})},this.removeItem=function(e){V.remove(j(e),{domain:t.domain,path:"/"})},this.hasItem=function(e){return I(x(V.get()),j(e))},this.getKeys=function(){return x(V.get())},this.type="Cookie"},G=function(){this.getItem=function(e){var t=A((function(){return JSON.parse(localStorage.getItem(j(e))||"")}))||{};return m(t)&&t.expiredAt>+Date.now()?U(F(t.value)):void 0},this.setItem=function(e,t,r){var n=null!=r?r:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();localStorage.setItem(j(e),JSON.stringify({value:d(t)&&t.length&&b(e,"_gioenc")?K(t):t,expiredAt:n}))},this.removeItem=function(e){return localStorage.removeItem(j(e))},this.hasItem=function(e){return!!localStorage.getItem(j(e))},this.getKeys=function(){return y(Array(localStorage.length)).map((function(e,t){return localStorage.key(t)}))},this.type="localStorage"},L={},Y=function(){this.getItem=function(e){var t=A((function(){return JSON.parse(L[j(e)]||"")}));return m(t)&&t.expiredAt>+Date.now()?U(F(t.value)):void 0},this.setItem=function(e,t,r){var n=null!=r?r:+new Date((new Date).getFullYear()+3,(new Date).getMonth(),(new Date).getDay()).getTime();L[j(e)]=JSON.stringify({value:d(t)&&t.length?K(t):t,expiredAt:n})},this.removeItem=function(e){return N(L,j(e))},this.hasItem=function(e){return O(L,j(e))},this.getKeys=function(){return x(L)},this.type="memory"},z=function(e){var t=[];try{var r=e.split("."),n=function(e){try{var t=y(e);return t[t.length-1]}catch(e){return}}(r);if(r.length>=2&&(isNaN(Number(n))||0>Number(n)||Number(n)>255)){var o=".".concat(r.slice(-2).join("."));B.test(o)?R=o:t.push(o);var i=".".concat(r.slice(-3).join("."));B.test(i)||I(t,i)||t.push(i);var a=".".concat(r.slice(-4).join("."));B.test(a)||I(t,a)||t.push(a)}}catch(e){T(e,"error")}return t},X=function(e){var t="";return e.some((function(e){return!!Z(e)&&(t=e,!0)})),t},Z=function(e){try{V.set("gioCookie","yes",{domain:e});var t=!!V.get("gioCookie",{domain:e});return V.remove("gioCookie",{domain:e}),t}catch(e){return!1}},W=function(e){var t,r,n,o=e.storageType,a=e.cookieDomain,u=e.projectId;if(I(["cookie","localstorage"],o)||(o="cookie"),"cookie"===o&&(r=!!(n=navigator.userAgent.indexOf("Electron")>-1||I(["","localhost","127.0.0.1"],window.location.hostname)||!I(["http:","https:"],window.location.protocol)?"":X(i(i([],z(window.location.hostname),!0),[window.location.hostname],!1)))),"cookie"===o&&r){var c=new P(n);if(a){var s=z(a),l=X(C(s)?[]:i([a],z(a),!0));l&&Z(l)?c.domain=l:T("指定Cookie域无效或无权限，使用默认域！","warn")}t=c}else t=function(){try{var e=window.localStorage,t="__storage_test__";return e.setItem(t,t),e.removeItem(t),!0}catch(e){return!1}}()?new G:new Y;return"cookie"===o&&R&&Z(R)&&function(e,t,r){if(t&&Z(t)){var n=new P(t);["".concat(r,"_gdp_session_id"),"gdp_user_id_gioenc","".concat(r,"_gdp_cs1_gioenc"),"".concat(r,"_gdp_user_key_gioenc"),"".concat(r,"_gdp_gio_id_gioenc"),"".concat(r,"_gdp_sequence_ids"),"".concat(r,"_gdp_session_id_sent")].forEach((function(t){var r=n.getItem(t);n.hasItem(t)&&(e.setItem(t,r),n.removeItem(t))})),n=void 0}}(t,R,u),t},Q=/^\d+_gdp_abt_sign$/,ee=/^\d+_gdp_abtd$/,te={name:"gioABTest",method:function(e){var t=this;this.growingIO=e,this.getStorageSession=function(e){var r=t.growingIO,n=r.storage,o=r.dataStore;return n.getItem(o.getStorageKey(e,"sessionId"))},this.getVisitSids=function(e){var r=t.growingIO.dataStore;return localStorage.getItem(r.getStorageKey(e,"abts"))},this.setVisitSids=function(e,r){var n=t.growingIO.dataStore;localStorage.setItem(n.getStorageKey(e,"abts"),r)},this.removeVisitSids=function(e){var r=t.growingIO.dataStore;localStorage.removeItem(r.getStorageKey(e,"abts"))},this.timeoutCheck=function(e,r){t.requestInterval=f(Number(e))&&!v(Number(e))?Number(e):5,(t.requestInterval>1440||0>t.requestInterval)&&(t.requestInterval=5),t.requestTimeout=f(Number(r))&&!v(Number(r))?Number(r):1e3,(t.requestTimeout>5e3||100>t.requestTimeout)&&(t.requestTimeout=1e3)},this.getMainConfigs=function(){var e,r,n,o,i,a,u,c,s,l,g,d,f=t.growingIO,v=f.plugins,m=f.vdsConfig,h=f.useHybridInherit,p=f.useEmbeddedInherit,I=f.dataStore;if(h){var y=null!==(r=null===(e=null==v?void 0:v.gioHybridAdapter)||void 0===e?void 0:e.hybridConfig)&&void 0!==r?r:null===(n=null===window||void 0===window?void 0:window.GrowingWebViewJavascriptBridge)||void 0===n?void 0:n.configuration;d=null!==(i=null!==(o=null==y?void 0:y.dataSourceId)&&void 0!==o?o:null==y?void 0:y.datasourceId)&&void 0!==i?i:m.dataSourceId,g=null!==(a=null==y?void 0:y.projectId)&&void 0!==a?a:m.projectId}else p?(d=null!==(c=null===(u=I.eventContextBuilderInst.minpExtraParams)||void 0===u?void 0:u.dataSourceId)&&void 0!==c?c:m.dataSourceId,g=null!==(l=null===(s=I.eventContextBuilderInst.minpExtraParams)||void 0===s?void 0:s.projectId)&&void 0!==l?l:m.projectId):(d=m.dataSourceId,g=m.projectId);return{projectId:g,dataSourceId:d}},this.abtStorageCheck=function(){var e=t.abtStorage.getKeys();e.filter((function(e){return Q.test(e)})).forEach((function(e){var r=t.abtStorage.getItem(e);r&&r>=Date.now()||t.abtStorage.removeItem(e)})),e.filter((function(e){return ee.test(e)})).forEach((function(e){C(t.abtStorage.getItem(e))&&t.abtStorage.removeItem(e)}))},this.getHashKey=function(e,r){var n=t.growingIO.userStore.getUid,o=t.growingIO.dataStore.getTrackerVds(e).projectId;return E("".concat(e,"#").concat(o,"#").concat(n(),"#").concat(r),!0)},this.generateUrl=function(e,r){t.newDevice&&!t.getVisitSids(e)&&t.setVisitSids(e,t.growingIO.userStore.getSessionId(e)),S(r,"http")?t.url[e]="".concat(r,"/diversion/specified-layer-variables"):t.url[e]="https://".concat(r,"/diversion/specified-layer-variables")},this.getABTest=function(e,r,n){if(C(t.url[e])&&t.generateUrl(e,"https://ab.growingio.com"),!r)return T("获取ABTest数据失败! 实验层Id不合法!","error"),void k(n,{});var o=t.abtStorage.getItem("".concat(t.getHashKey(e,r),"_gdp_abt_sign"))||0,i=t.abtStorage.getItem("".concat(t.getHashKey(e,r),"_gdp_abtd"))||{};!o||o<Date.now()?t.initiateRequest(e,r,i,n):k(n,i)},this.initiateRequest=function(e,r,n,i){var a=t.growingIO,u=a.userStore,c=u.getUid,s=u.getSessionId,l=a.dataStore,g=e===t.growingIO.trackingId?t.getMainConfigs():l.getTrackerVds(e),d=g.projectId,f=g.dataSourceId,v=new XMLHttpRequest;if(v){v.open("POST",t.url[e],!0),v.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),v.timeout=t.requestTimeout,v.onload=function(a){var u,c=null!==(u=A((function(){return JSON.parse(a.target.responseText)})))&&void 0!==u?u:{};0===c.code?t.experimentVerify(e,o(o({},c),{layerId:r}),n,i):(T("获取ABTest数据失败! ".concat(c.errorMsg,"!"),"error"),k(i,{})),t.abtStorage.setItem("".concat(t.getHashKey(e,r),"_gdp_abt_sign"),Date.now()+6e4*t.requestInterval)},v.ontimeout=function(){T("获取ABTest数据失败! 请求超时!","error"),k(i,{})},v.onerror=function(){200!==v.status&&(2>t.retryCount?(t.initiateRequest(e,r,n,i),t.retryCount+=1):(T("获取ABTest数据失败! ".concat(v.statusText,"!"),"error"),k(i,{})))};var m={accountId:d,datasourceId:f,distinctId:c(),layerId:r};return t.getVisitSids(e)===s(e)?m.newDevice=!0:(m.newDevice=!1,t.removeVisitSids(e)),void v.send(function(e,t){if(void 0===t&&(t=!1),"object"===D(e)){var r="";return(e.__GIO_ORDER__||x(e)).forEach((function(n){"__GIO_ORDER__"!==n&&O(e,n)&&(""===r?r=(t?"?":"")+"".concat(n,"=").concat(e[n]):r+="&".concat(n,"=").concat(e[n]))})),r}if("string"===D(e))return encodeURIComponent(e)}(m))}T("获取ABTest数据失败! 当前环境不支持XMLHttpRequest!","error")},this.experimentVerify=function(e,r,n,i){var a=r.layerId,u=r.strategyId,c=r.experimentId,s=r.layerName,l=r.experimentName,g=r.strategyName,d=r.variables,f="".concat(t.getHashKey(e,a),"_gdp_abtd"),v={layerId:w(a),strategyId:w(u),experimentId:w(c),variables:d},m=o({},n);N(m,["layerName","strategyName","experimentName"]);var h=E(JSON.stringify(v)),p=E(JSON.stringify(m)),I=o(o({},v),{layerName:s,strategyName:g,experimentName:l});t.abtStorage.setItem(f,I,new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()+1).getTime()),h!==p&&u&&c&&t.buildExperimentHitEvent(e,I),k(i,I)},this.buildExperimentHitEvent=function(e,r){var n,i=t.growingIO.dataStore,a=i.eventContextBuilder,u=i.eventConverter,c=o({eventType:"CUSTOM",eventName:"$exp_hit"},a(e)),s=r.layerId,l=r.experimentId,g=r.strategyId,d=r.layerName,f=r.experimentName,v=r.strategyName;c.attributes=q(o(o({},null!==(n=c.attributes)&&void 0!==n?n:{}),{$exp_layer_id:s,$exp_id:l,$exp_strategy_id:g,$exp_layer_name:d,$exp_name:f,$exp_strategy_name:v})),u(c)},this.pluginVersion="4.3.1",this.abtStorage=W({storageType:"localstorage"}),this.growingIO.getABTest=this.getABTest;var r=this.growingIO.emitter;r.on("OPTION_INITIALIZED",(function(){var e,r=null!==(e=t.options)&&void 0!==e?e:{},n=r.abServerUrl,o=void 0===n?"https://ab.growingio.com":n,i=r.requestInterval,a=r.requestTimeout;t.timeoutCheck(i,a),C(o)?T("如果您需要使用ABTest功能，请配置服务地址 abServerUrl!","warn"):(t.abtStorageCheck(),t.url={},d(o)?t.generateUrl(t.growingIO.trackingId,o):m(o)&&x(o).forEach((function(e){t.generateUrl(e,o[e])})))})),r.on("UID_UPDATE",(function(e){var r,n=e.newUId,o=e.oldUId,i=(null!==(r=t.options)&&void 0!==r?r:{}).abServerUrl,a=void 0===i?"https://ab.growingio.com":i;if(t.newDevice=!0,!o&&n)if(d(a)){var u=t.growingIO.trackingId;t.setVisitSids(u,t.getStorageSession(u))}else m(a)&&x(a).forEach((function(e){t.setVisitSids(e,t.getStorageSession(e))}))})),this.retryCount=0}};export{te as default};
